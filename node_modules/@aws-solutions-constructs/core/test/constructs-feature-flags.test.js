"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Imports
const cdk = require("aws-cdk-lib");
const cloud_assembly_schema_1 = require("@aws-cdk/cloud-assembly-schema");
const constructs_feature_flags_1 = require("../lib/constructs-feature-flags");
test('ensures feature flag report when scope is app', () => {
    const app = new cdk.App();
    constructs_feature_flags_1.ConstructsFeatureFlagsReport.ensure(app);
    const assembly = app.synth();
    const featureFlagArtifact = extractConstructFeatureFlagArtifact(assembly.manifest);
    expect(featureFlagArtifact).toBeDefined();
});
test('test ConstructsFeatureFlagsReport synthesis and manifest output', () => {
    const app = new cdk.App();
    const stack = new cdk.Stack(app, 'TestStack');
    // Call ConstructsFeatureFlagsReport.ensure()
    constructs_feature_flags_1.ConstructsFeatureFlagsReport.ensure(stack);
    // Synthesize the stack
    const assembly = app.synth();
    // Examine the manifest output
    const featureFlagArtifact = extractConstructFeatureFlagArtifact(assembly.manifest);
    expect(featureFlagArtifact).toBeDefined();
    // Cast to any to access custom properties since TypeScript doesn't know about our custom artifact type
    const artifactProps = featureFlagArtifact?.properties;
    expect(artifactProps?.module).toBe('@aws-solutions-constructs');
    const flags = artifactProps?.flags;
    expect(flags).toBeDefined();
    const keys = Object.keys(artifactProps?.flags);
    expect(keys.length).toBeGreaterThanOrEqual(1);
    // Check every flag entry
    const FLAG_NAME_PREFIX = "@aws-solutions-constructs";
    keys.forEach(keyName => {
        // Is the name of the flag of the correct format?
        const prefix = keyName.substring(0, FLAG_NAME_PREFIX.length);
        expect(prefix).toEqual(FLAG_NAME_PREFIX);
        // Verify the flag structure
        const constructsFlag = flags[keyName];
        expect(constructsFlag).toHaveProperty('recommendedValue', true);
        expect(constructsFlag).toHaveProperty('explanation');
    });
});
test('ensures feature flag report when scope is stack->stage->app', () => {
    const app = new cdk.App();
    const stage = new cdk.Stage(app, 'TestStage');
    const stack = new cdk.Stack(stage, 'TestStack');
    constructs_feature_flags_1.ConstructsFeatureFlagsReport.ensure(stack);
    const assembly = app.synth();
    const featureFlagArtifact = extractConstructFeatureFlagArtifact(assembly.manifest);
    expect(featureFlagArtifact).toBeDefined();
});
function extractConstructFeatureFlagArtifact(manifest) {
    if (!manifest.artifacts) {
        return undefined;
    }
    const allArtifacts = Object.values(manifest.artifacts);
    return allArtifacts.find(artifact => isConstructsFeatureFlagReport(artifact));
}
function isConstructsFeatureFlagReport(artifact) {
    return ((artifact.type === cloud_assembly_schema_1.ArtifactType.FEATURE_FLAG_REPORT) && (artifact.properties.module === '@aws-solutions-constructs'));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uc3RydWN0cy1mZWF0dXJlLWZsYWdzLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjb25zdHJ1Y3RzLWZlYXR1cmUtZmxhZ3MudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7O0FBRUgsVUFBVTtBQUNWLG1DQUFtQztBQUNuQywwRUFBa0c7QUFDbEcsOEVBQStFO0FBRS9FLElBQUksQ0FBQywrQ0FBK0MsRUFBRSxHQUFHLEVBQUU7SUFDekQsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDMUIsdURBQTRCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ3pDLE1BQU0sUUFBUSxHQUFHLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM3QixNQUFNLG1CQUFtQixHQUFHLG1DQUFtQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNuRixNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUM1QyxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyxpRUFBaUUsRUFBRSxHQUFHLEVBQUU7SUFDM0UsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDMUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUU5Qyw2Q0FBNkM7SUFDN0MsdURBQTRCLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRTNDLHVCQUF1QjtJQUN2QixNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFFN0IsOEJBQThCO0lBQzlCLE1BQU0sbUJBQW1CLEdBQUcsbUNBQW1DLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRW5GLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBRTFDLHVHQUF1RztJQUN2RyxNQUFNLGFBQWEsR0FBRyxtQkFBbUIsRUFBRSxVQUFpQixDQUFDO0lBRTdELE1BQU0sQ0FBQyxhQUFhLEVBQUUsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLENBQUM7SUFDaEUsTUFBTSxLQUFLLEdBQUcsYUFBYSxFQUFFLEtBQUssQ0FBQztJQUNuQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDNUIsTUFBTSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDL0MsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU5Qyx5QkFBeUI7SUFDekIsTUFBTSxnQkFBZ0IsR0FBRywyQkFBMkIsQ0FBQztJQUNyRCxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxFQUFFO1FBQ3JCLGlEQUFpRDtRQUNqRCxNQUFNLE1BQU0sR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM3RCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFekMsNEJBQTRCO1FBQzVCLE1BQU0sY0FBYyxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN0QyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsY0FBYyxDQUFDLGtCQUFrQixFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ2hFLE1BQU0sQ0FBQyxjQUFjLENBQUMsQ0FBQyxjQUFjLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDdkQsQ0FBQyxDQUFDLENBQUM7QUFFTCxDQUFDLENBQUMsQ0FBQztBQUVILElBQUksQ0FBQyw2REFBNkQsRUFBRSxHQUFHLEVBQUU7SUFDdkUsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7SUFDMUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxHQUFHLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUM5QyxNQUFNLEtBQUssR0FBRyxJQUFJLEdBQUcsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ2hELHVEQUE0QixDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUMzQyxNQUFNLFFBQVEsR0FBRyxHQUFHLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDN0IsTUFBTSxtQkFBbUIsR0FBRyxtQ0FBbUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbkYsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUMsV0FBVyxFQUFFLENBQUM7QUFDNUMsQ0FBQyxDQUFDLENBQUM7QUFFSCxTQUFTLG1DQUFtQyxDQUFDLFFBQTBCO0lBQ3JFLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDeEIsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUNELE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBQ3ZELE9BQU8sWUFBWSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLDZCQUE2QixDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7QUFDaEYsQ0FBQztBQUVELFNBQVMsNkJBQTZCLENBQUMsUUFBMEI7SUFDL0QsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksS0FBSyxvQ0FBWSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBRSxRQUFRLENBQUMsVUFBbUIsQ0FBQyxNQUFNLEtBQUssMkJBQTJCLENBQUMsQ0FBQyxDQUFDO0FBQzFJLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG4vLyBJbXBvcnRzXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInO1xuaW1wb3J0IHsgQXJ0aWZhY3RUeXBlLCBBc3NlbWJseU1hbmlmZXN0LCBBcnRpZmFjdE1hbmlmZXN0IH0gZnJvbSAnQGF3cy1jZGsvY2xvdWQtYXNzZW1ibHktc2NoZW1hJztcbmltcG9ydCB7IENvbnN0cnVjdHNGZWF0dXJlRmxhZ3NSZXBvcnQgfSBmcm9tICcuLi9saWIvY29uc3RydWN0cy1mZWF0dXJlLWZsYWdzJztcblxudGVzdCgnZW5zdXJlcyBmZWF0dXJlIGZsYWcgcmVwb3J0IHdoZW4gc2NvcGUgaXMgYXBwJywgKCkgPT4ge1xuICBjb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuICBDb25zdHJ1Y3RzRmVhdHVyZUZsYWdzUmVwb3J0LmVuc3VyZShhcHApO1xuICBjb25zdCBhc3NlbWJseSA9IGFwcC5zeW50aCgpO1xuICBjb25zdCBmZWF0dXJlRmxhZ0FydGlmYWN0ID0gZXh0cmFjdENvbnN0cnVjdEZlYXR1cmVGbGFnQXJ0aWZhY3QoYXNzZW1ibHkubWFuaWZlc3QpO1xuICBleHBlY3QoZmVhdHVyZUZsYWdBcnRpZmFjdCkudG9CZURlZmluZWQoKTtcbn0pO1xuXG50ZXN0KCd0ZXN0IENvbnN0cnVjdHNGZWF0dXJlRmxhZ3NSZXBvcnQgc3ludGhlc2lzIGFuZCBtYW5pZmVzdCBvdXRwdXQnLCAoKSA9PiB7XG4gIGNvbnN0IGFwcCA9IG5ldyBjZGsuQXBwKCk7XG4gIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjayhhcHAsICdUZXN0U3RhY2snKTtcblxuICAvLyBDYWxsIENvbnN0cnVjdHNGZWF0dXJlRmxhZ3NSZXBvcnQuZW5zdXJlKClcbiAgQ29uc3RydWN0c0ZlYXR1cmVGbGFnc1JlcG9ydC5lbnN1cmUoc3RhY2spO1xuXG4gIC8vIFN5bnRoZXNpemUgdGhlIHN0YWNrXG4gIGNvbnN0IGFzc2VtYmx5ID0gYXBwLnN5bnRoKCk7XG5cbiAgLy8gRXhhbWluZSB0aGUgbWFuaWZlc3Qgb3V0cHV0XG4gIGNvbnN0IGZlYXR1cmVGbGFnQXJ0aWZhY3QgPSBleHRyYWN0Q29uc3RydWN0RmVhdHVyZUZsYWdBcnRpZmFjdChhc3NlbWJseS5tYW5pZmVzdCk7XG5cbiAgZXhwZWN0KGZlYXR1cmVGbGFnQXJ0aWZhY3QpLnRvQmVEZWZpbmVkKCk7XG5cbiAgLy8gQ2FzdCB0byBhbnkgdG8gYWNjZXNzIGN1c3RvbSBwcm9wZXJ0aWVzIHNpbmNlIFR5cGVTY3JpcHQgZG9lc24ndCBrbm93IGFib3V0IG91ciBjdXN0b20gYXJ0aWZhY3QgdHlwZVxuICBjb25zdCBhcnRpZmFjdFByb3BzID0gZmVhdHVyZUZsYWdBcnRpZmFjdD8ucHJvcGVydGllcyBhcyBhbnk7XG5cbiAgZXhwZWN0KGFydGlmYWN0UHJvcHM/Lm1vZHVsZSkudG9CZSgnQGF3cy1zb2x1dGlvbnMtY29uc3RydWN0cycpO1xuICBjb25zdCBmbGFncyA9IGFydGlmYWN0UHJvcHM/LmZsYWdzO1xuICBleHBlY3QoZmxhZ3MpLnRvQmVEZWZpbmVkKCk7XG4gIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhcnRpZmFjdFByb3BzPy5mbGFncyk7XG4gIGV4cGVjdChrZXlzLmxlbmd0aCkudG9CZUdyZWF0ZXJUaGFuT3JFcXVhbCgxKTtcblxuICAvLyBDaGVjayBldmVyeSBmbGFnIGVudHJ5XG4gIGNvbnN0IEZMQUdfTkFNRV9QUkVGSVggPSBcIkBhd3Mtc29sdXRpb25zLWNvbnN0cnVjdHNcIjtcbiAga2V5cy5mb3JFYWNoKGtleU5hbWUgPT4ge1xuICAgIC8vIElzIHRoZSBuYW1lIG9mIHRoZSBmbGFnIG9mIHRoZSBjb3JyZWN0IGZvcm1hdD9cbiAgICBjb25zdCBwcmVmaXggPSBrZXlOYW1lLnN1YnN0cmluZygwLCBGTEFHX05BTUVfUFJFRklYLmxlbmd0aCk7XG4gICAgZXhwZWN0KHByZWZpeCkudG9FcXVhbChGTEFHX05BTUVfUFJFRklYKTtcblxuICAgIC8vIFZlcmlmeSB0aGUgZmxhZyBzdHJ1Y3R1cmVcbiAgICBjb25zdCBjb25zdHJ1Y3RzRmxhZyA9IGZsYWdzW2tleU5hbWVdO1xuICAgIGV4cGVjdChjb25zdHJ1Y3RzRmxhZykudG9IYXZlUHJvcGVydHkoJ3JlY29tbWVuZGVkVmFsdWUnLCB0cnVlKTtcbiAgICBleHBlY3QoY29uc3RydWN0c0ZsYWcpLnRvSGF2ZVByb3BlcnR5KCdleHBsYW5hdGlvbicpO1xuICB9KTtcblxufSk7XG5cbnRlc3QoJ2Vuc3VyZXMgZmVhdHVyZSBmbGFnIHJlcG9ydCB3aGVuIHNjb3BlIGlzIHN0YWNrLT5zdGFnZS0+YXBwJywgKCkgPT4ge1xuICBjb25zdCBhcHAgPSBuZXcgY2RrLkFwcCgpO1xuICBjb25zdCBzdGFnZSA9IG5ldyBjZGsuU3RhZ2UoYXBwLCAnVGVzdFN0YWdlJyk7XG4gIGNvbnN0IHN0YWNrID0gbmV3IGNkay5TdGFjayhzdGFnZSwgJ1Rlc3RTdGFjaycpO1xuICBDb25zdHJ1Y3RzRmVhdHVyZUZsYWdzUmVwb3J0LmVuc3VyZShzdGFjayk7XG4gIGNvbnN0IGFzc2VtYmx5ID0gYXBwLnN5bnRoKCk7XG4gIGNvbnN0IGZlYXR1cmVGbGFnQXJ0aWZhY3QgPSBleHRyYWN0Q29uc3RydWN0RmVhdHVyZUZsYWdBcnRpZmFjdChhc3NlbWJseS5tYW5pZmVzdCk7XG4gIGV4cGVjdChmZWF0dXJlRmxhZ0FydGlmYWN0KS50b0JlRGVmaW5lZCgpO1xufSk7XG5cbmZ1bmN0aW9uIGV4dHJhY3RDb25zdHJ1Y3RGZWF0dXJlRmxhZ0FydGlmYWN0KG1hbmlmZXN0OiBBc3NlbWJseU1hbmlmZXN0KTogQXJ0aWZhY3RNYW5pZmVzdCB8IHVuZGVmaW5lZCB7XG4gIGlmICghbWFuaWZlc3QuYXJ0aWZhY3RzKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgfVxuICBjb25zdCBhbGxBcnRpZmFjdHMgPSBPYmplY3QudmFsdWVzKG1hbmlmZXN0LmFydGlmYWN0cyk7XG4gIHJldHVybiBhbGxBcnRpZmFjdHMuZmluZChhcnRpZmFjdCA9PiBpc0NvbnN0cnVjdHNGZWF0dXJlRmxhZ1JlcG9ydChhcnRpZmFjdCkpO1xufVxuXG5mdW5jdGlvbiBpc0NvbnN0cnVjdHNGZWF0dXJlRmxhZ1JlcG9ydChhcnRpZmFjdDogQXJ0aWZhY3RNYW5pZmVzdCkge1xuICByZXR1cm4gKChhcnRpZmFjdC50eXBlID09PSBBcnRpZmFjdFR5cGUuRkVBVFVSRV9GTEFHX1JFUE9SVCkgJiYgKChhcnRpZmFjdC5wcm9wZXJ0aWVzISBhcyBhbnkpLm1vZHVsZSA9PT0gJ0Bhd3Mtc29sdXRpb25zLWNvbnN0cnVjdHMnKSk7XG59XG4iXX0=
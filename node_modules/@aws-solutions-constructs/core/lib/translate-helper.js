"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.ConfigureTranslateSupport = ConfigureTranslateSupport;
exports.CheckTranslateProps = CheckTranslateProps;
const iam = require("aws-cdk-lib/aws-iam");
const s3_bucket_helper_1 = require("./s3-bucket-helper");
const utils_1 = require("./utils");
function ConfigureTranslateSupport(scope, id, props) {
    let configuration = {
        lambdaIamActionsRequired: ['translate:TranslateText', 'translate:TranslateDocument'],
    };
    if (props.asyncJobs) {
        // Setup source S3 Bucket
        if (props.existingSourceBucketObj) {
            configuration = (0, utils_1.overrideProps)(configuration, {
                sourceBucket: {
                    bucketInterface: props.existingSourceBucketObj
                }
            }, false);
        }
        else {
            const buildSourceBucketResponse = (0, s3_bucket_helper_1.buildS3Bucket)(scope, {
                bucketProps: props.sourceBucketProps,
                loggingBucketProps: props.sourceLoggingBucketProps,
                logS3AccessLogs: props.logSourceS3AccessLogs
            }, `${id}-source-bucket`);
            configuration = (0, utils_1.overrideProps)(configuration, {
                sourceBucket: {
                    bucket: buildSourceBucketResponse.bucket,
                    loggingBucket: buildSourceBucketResponse.loggingBucket,
                    bucketInterface: buildSourceBucketResponse.bucket,
                }
            }, false);
        }
        // Setup destination S3 Bucket
        if (props.useSameBucket) {
            configuration = (0, utils_1.overrideProps)(configuration, {
                destinationBucket: {
                    bucketInterface: configuration.sourceBucket?.bucketInterface,
                    bucket: configuration.sourceBucket?.bucket,
                    loggingBucket: configuration.sourceBucket?.loggingBucket,
                }
            }, false);
        }
        else {
            if (props.existingDestinationBucketObj) {
                configuration = (0, utils_1.overrideProps)(configuration, {
                    destinationBucket: {
                        bucketInterface: props.existingDestinationBucketObj
                    }
                }, false);
            }
            else {
                const buildDestinationBucketResponse = (0, s3_bucket_helper_1.buildS3Bucket)(scope, {
                    bucketProps: props.destinationBucketProps,
                    loggingBucketProps: props.destinationLoggingBucketProps,
                    logS3AccessLogs: props.logDestinationS3AccessLogs
                }, `${id}-destination-bucket`);
                configuration = (0, utils_1.overrideProps)(configuration, {
                    destinationBucket: {
                        bucket: buildDestinationBucketResponse.bucket,
                        loggingBucket: buildDestinationBucketResponse.loggingBucket,
                        bucketInterface: buildDestinationBucketResponse.bucket,
                    }
                }, false);
            }
        }
        // Set up role that is sent to the Translate service
        const translateServiceRole = new iam.Role(scope, `${id}-translate-service-role`, {
            assumedBy: new iam.ServicePrincipal('translate.amazonaws.com'),
        });
        configuration.destinationBucket?.bucketInterface.grantReadWrite(translateServiceRole);
        configuration.sourceBucket?.bucketInterface.grantRead(translateServiceRole);
        configuration = (0, utils_1.overrideProps)(configuration, {
            translateRole: translateServiceRole
        }, false);
        // Give the Lambda function additional permissions
        configuration.lambdaIamActionsRequired.push("translate:DescribeTextTranslationJob");
        configuration.lambdaIamActionsRequired.push("translate:ListTextTranslationJobs");
        configuration.lambdaIamActionsRequired.push("translate:StartTextTranslationJob");
        configuration.lambdaIamActionsRequired.push("translate:StopTextTranslationJob");
    }
    return configuration;
}
function CheckTranslateProps(props) {
    let errorMessages = '';
    let errorFound = false;
    if (props.asyncJobs) {
        // Check source bucket props
        const sourceS3Props = {
            existingBucketObj: props.existingSourceBucketObj,
            bucketProps: props.sourceBucketProps,
            loggingBucketProps: props.sourceLoggingBucketProps,
            logS3AccessLogs: props.logSourceS3AccessLogs
        };
        (0, s3_bucket_helper_1.CheckS3Props)(sourceS3Props);
        // Check destination bucket props (only if not using same bucket)
        if (!props.useSameBucket) {
            const destinationS3Props = {
                existingBucketObj: props.existingDestinationBucketObj,
                bucketProps: props.destinationBucketProps,
                loggingBucketProps: props.destinationLoggingBucketProps,
                logS3AccessLogs: props.logDestinationS3AccessLogs
            };
            (0, s3_bucket_helper_1.CheckS3Props)(destinationS3Props);
        }
    }
    // If asyncJobs is false, no S3 bucket props should be provided
    if (!props.asyncJobs) {
        if (props.existingSourceBucketObj || props.sourceBucketProps ||
            props.existingDestinationBucketObj || props.destinationBucketProps ||
            props.sourceLoggingBucketProps || props.destinationLoggingBucketProps ||
            props.logSourceS3AccessLogs !== undefined || props.logDestinationS3AccessLogs !== undefined ||
            props.sourceBucketEnvironmentVariableName || props.destinationBucketEnvironmentVariableName ||
            props.dataAccessRoleArnEnvironmentVariableName || props.useSameBucket) {
            errorMessages += 'S3 bucket properties can only be provided when asyncJobs is true';
            errorFound = true;
        }
    }
    // If useSameBucket is true, no destination bucket props should be provided
    if (props.useSameBucket) {
        if (props.existingDestinationBucketObj || props.destinationBucketProps ||
            props.destinationLoggingBucketProps || props.logDestinationS3AccessLogs !== undefined) {
            errorMessages += 'Destination bucket properties cannot be provided when useSameBucket is true';
            errorFound = true;
        }
    }
    if (errorFound) {
        throw new Error(errorMessages);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRlLWhlbHBlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInRyYW5zbGF0ZS1oZWxwZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7OztHQVdHOztBQXFDSCw4REFnRkM7QUFFRCxrREFvREM7QUF2S0QsMkNBQTJDO0FBQzNDLHlEQUFpRTtBQUNqRSxtQ0FBd0M7QUErQnhDLFNBQWdCLHlCQUF5QixDQUFDLEtBQWdCLEVBQUUsRUFBVSxFQUFFLEtBQXFCO0lBRTNGLElBQUksYUFBYSxHQUEyQjtRQUMxQyx3QkFBd0IsRUFBRSxDQUFDLHlCQUF5QixFQUFFLDZCQUE2QixDQUFDO0tBQ3JGLENBQUM7SUFFRixJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUVwQix5QkFBeUI7UUFDekIsSUFBSSxLQUFLLENBQUMsdUJBQXVCLEVBQUUsQ0FBQztZQUNsQyxhQUFhLEdBQUcsSUFBQSxxQkFBYSxFQUFDLGFBQWEsRUFBRTtnQkFDM0MsWUFBWSxFQUFFO29CQUNaLGVBQWUsRUFBRSxLQUFLLENBQUMsdUJBQXVCO2lCQUMvQzthQUNGLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDWixDQUFDO2FBQU0sQ0FBQztZQUNOLE1BQU0seUJBQXlCLEdBQUcsSUFBQSxnQ0FBYSxFQUFDLEtBQUssRUFBRTtnQkFDckQsV0FBVyxFQUFFLEtBQUssQ0FBQyxpQkFBaUI7Z0JBQ3BDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyx3QkFBd0I7Z0JBQ2xELGVBQWUsRUFBRSxLQUFLLENBQUMscUJBQXFCO2FBQzdDLEVBQUUsR0FBRyxFQUFFLGdCQUFnQixDQUFDLENBQUM7WUFDMUIsYUFBYSxHQUFHLElBQUEscUJBQWEsRUFBQyxhQUFhLEVBQUU7Z0JBQzNDLFlBQVksRUFBRTtvQkFDWixNQUFNLEVBQUUseUJBQXlCLENBQUMsTUFBTTtvQkFDeEMsYUFBYSxFQUFFLHlCQUF5QixDQUFDLGFBQWE7b0JBQ3RELGVBQWUsRUFBRSx5QkFBeUIsQ0FBQyxNQUFNO2lCQUNsRDthQUNGLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDWixDQUFDO1FBRUQsOEJBQThCO1FBQzlCLElBQUksS0FBSyxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQ3hCLGFBQWEsR0FBRyxJQUFBLHFCQUFhLEVBQUMsYUFBYSxFQUFFO2dCQUMzQyxpQkFBaUIsRUFBRTtvQkFDakIsZUFBZSxFQUFFLGFBQWEsQ0FBQyxZQUFZLEVBQUUsZUFBZTtvQkFDNUQsTUFBTSxFQUFFLGFBQWEsQ0FBQyxZQUFZLEVBQUUsTUFBTTtvQkFDMUMsYUFBYSxFQUFFLGFBQWEsQ0FBQyxZQUFZLEVBQUUsYUFBYTtpQkFDekQ7YUFDRixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ1osQ0FBQzthQUFNLENBQUM7WUFDTixJQUFJLEtBQUssQ0FBQyw0QkFBNEIsRUFBRSxDQUFDO2dCQUN2QyxhQUFhLEdBQUcsSUFBQSxxQkFBYSxFQUFDLGFBQWEsRUFBRTtvQkFDM0MsaUJBQWlCLEVBQUU7d0JBQ2pCLGVBQWUsRUFBRSxLQUFLLENBQUMsNEJBQTRCO3FCQUNwRDtpQkFDRixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ1osQ0FBQztpQkFBTSxDQUFDO2dCQUNOLE1BQU0sOEJBQThCLEdBQUcsSUFBQSxnQ0FBYSxFQUFDLEtBQUssRUFBRTtvQkFDMUQsV0FBVyxFQUFFLEtBQUssQ0FBQyxzQkFBc0I7b0JBQ3pDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyw2QkFBNkI7b0JBQ3ZELGVBQWUsRUFBRSxLQUFLLENBQUMsMEJBQTBCO2lCQUNsRCxFQUFFLEdBQUcsRUFBRSxxQkFBcUIsQ0FBQyxDQUFDO2dCQUMvQixhQUFhLEdBQUcsSUFBQSxxQkFBYSxFQUFDLGFBQWEsRUFBRTtvQkFDM0MsaUJBQWlCLEVBQUU7d0JBQ2pCLE1BQU0sRUFBRSw4QkFBOEIsQ0FBQyxNQUFNO3dCQUM3QyxhQUFhLEVBQUUsOEJBQThCLENBQUMsYUFBYTt3QkFDM0QsZUFBZSxFQUFFLDhCQUE4QixDQUFDLE1BQU07cUJBQ3ZEO2lCQUNGLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDWixDQUFDO1FBQ0gsQ0FBQztRQUVELG9EQUFvRDtRQUNwRCxNQUFNLG9CQUFvQixHQUFHLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsR0FBRyxFQUFFLHlCQUF5QixFQUFFO1lBQy9FLFNBQVMsRUFBRSxJQUFJLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyx5QkFBeUIsQ0FBQztTQUMvRCxDQUFDLENBQUM7UUFDSCxhQUFhLENBQUMsaUJBQWlCLEVBQUUsZUFBZSxDQUFDLGNBQWMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQ3RGLGFBQWEsQ0FBQyxZQUFZLEVBQUUsZUFBZSxDQUFDLFNBQVMsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBQzVFLGFBQWEsR0FBRyxJQUFBLHFCQUFhLEVBQUMsYUFBYSxFQUFFO1lBQzNDLGFBQWEsRUFBRSxvQkFBb0I7U0FDcEMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVWLGtEQUFrRDtRQUNsRCxhQUFhLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLHNDQUFzQyxDQUFDLENBQUM7UUFDcEYsYUFBYSxDQUFDLHdCQUF3QixDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDO1FBQ2pGLGFBQWEsQ0FBQyx3QkFBd0IsQ0FBQyxJQUFJLENBQUMsbUNBQW1DLENBQUMsQ0FBQztRQUNqRixhQUFhLENBQUMsd0JBQXdCLENBQUMsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLENBQUM7SUFFbEYsQ0FBQztJQUNELE9BQU8sYUFBYSxDQUFDO0FBQ3ZCLENBQUM7QUFFRCxTQUFnQixtQkFBbUIsQ0FBQyxLQUFxQjtJQUN2RCxJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7SUFDdkIsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBRXZCLElBQUksS0FBSyxDQUFDLFNBQVMsRUFBRSxDQUFDO1FBRXBCLDRCQUE0QjtRQUM1QixNQUFNLGFBQWEsR0FBRztZQUNwQixpQkFBaUIsRUFBRSxLQUFLLENBQUMsdUJBQXVCO1lBQ2hELFdBQVcsRUFBRSxLQUFLLENBQUMsaUJBQWlCO1lBQ3BDLGtCQUFrQixFQUFFLEtBQUssQ0FBQyx3QkFBd0I7WUFDbEQsZUFBZSxFQUFFLEtBQUssQ0FBQyxxQkFBcUI7U0FDN0MsQ0FBQztRQUNGLElBQUEsK0JBQVksRUFBQyxhQUFhLENBQUMsQ0FBQztRQUU1QixpRUFBaUU7UUFDakUsSUFBSSxDQUFDLEtBQUssQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN6QixNQUFNLGtCQUFrQixHQUFHO2dCQUN6QixpQkFBaUIsRUFBRSxLQUFLLENBQUMsNEJBQTRCO2dCQUNyRCxXQUFXLEVBQUUsS0FBSyxDQUFDLHNCQUFzQjtnQkFDekMsa0JBQWtCLEVBQUUsS0FBSyxDQUFDLDZCQUE2QjtnQkFDdkQsZUFBZSxFQUFFLEtBQUssQ0FBQywwQkFBMEI7YUFDbEQsQ0FBQztZQUNGLElBQUEsK0JBQVksRUFBQyxrQkFBa0IsQ0FBQyxDQUFDO1FBQ25DLENBQUM7SUFDSCxDQUFDO0lBRUQsK0RBQStEO0lBQy9ELElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDckIsSUFBSSxLQUFLLENBQUMsdUJBQXVCLElBQUksS0FBSyxDQUFDLGlCQUFpQjtZQUMxRCxLQUFLLENBQUMsNEJBQTRCLElBQUksS0FBSyxDQUFDLHNCQUFzQjtZQUNsRSxLQUFLLENBQUMsd0JBQXdCLElBQUksS0FBSyxDQUFDLDZCQUE2QjtZQUNyRSxLQUFLLENBQUMscUJBQXFCLEtBQUssU0FBUyxJQUFJLEtBQUssQ0FBQywwQkFBMEIsS0FBSyxTQUFTO1lBQzNGLEtBQUssQ0FBQyxtQ0FBbUMsSUFBSSxLQUFLLENBQUMsd0NBQXdDO1lBQzFGLEtBQUssQ0FBQyx3Q0FBd0MsSUFBRyxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDeEUsYUFBYSxJQUFJLGtFQUFrRSxDQUFDO1lBQ3BGLFVBQVUsR0FBRyxJQUFJLENBQUM7UUFDcEIsQ0FBQztJQUNILENBQUM7SUFFRCwyRUFBMkU7SUFDM0UsSUFBSSxLQUFLLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDeEIsSUFBSSxLQUFLLENBQUMsNEJBQTRCLElBQUksS0FBSyxDQUFDLHNCQUFzQjtZQUNwRSxLQUFLLENBQUMsNkJBQTZCLElBQUksS0FBSyxDQUFDLDBCQUEwQixLQUFLLFNBQVMsRUFBRSxDQUFDO1lBQ3hGLGFBQWEsSUFBSSw2RUFBNkUsQ0FBQztZQUMvRixVQUFVLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLENBQUM7SUFDSCxDQUFDO0lBRUQsSUFBSSxVQUFVLEVBQUUsQ0FBQztRQUNmLE1BQU0sSUFBSSxLQUFLLENBQUMsYUFBYSxDQUFDLENBQUM7SUFDakMsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgKiBhcyBzMyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtczMnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5pbXBvcnQgKiBhcyBpYW0gZnJvbSAnYXdzLWNkay1saWIvYXdzLWlhbSc7XG5pbXBvcnQgeyBDaGVja1MzUHJvcHMsIGJ1aWxkUzNCdWNrZXQgfSBmcm9tICcuL3MzLWJ1Y2tldC1oZWxwZXInO1xuaW1wb3J0IHsgb3ZlcnJpZGVQcm9wcyB9IGZyb20gJy4vdXRpbHMnO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRyYW5zbGF0ZVByb3BzIHtcbiAgcmVhZG9ubHkgYXN5bmNKb2JzPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgZXhpc3RpbmdTb3VyY2VCdWNrZXRPYmo/OiBzMy5JQnVja2V0O1xuICByZWFkb25seSBzb3VyY2VCdWNrZXRQcm9wcz86IHMzLkJ1Y2tldFByb3BzO1xuICByZWFkb25seSBleGlzdGluZ0Rlc3RpbmF0aW9uQnVja2V0T2JqPzogczMuSUJ1Y2tldDtcbiAgcmVhZG9ubHkgZGVzdGluYXRpb25CdWNrZXRQcm9wcz86IHMzLkJ1Y2tldFByb3BzO1xuICByZWFkb25seSB1c2VTYW1lQnVja2V0PzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgc291cmNlTG9nZ2luZ0J1Y2tldFByb3BzPzogczMuQnVja2V0UHJvcHM7XG4gIHJlYWRvbmx5IGRlc3RpbmF0aW9uTG9nZ2luZ0J1Y2tldFByb3BzPzogczMuQnVja2V0UHJvcHM7XG4gIHJlYWRvbmx5IGxvZ1NvdXJjZVMzQWNjZXNzTG9ncz86IGJvb2xlYW47XG4gIHJlYWRvbmx5IGxvZ0Rlc3RpbmF0aW9uUzNBY2Nlc3NMb2dzPzogYm9vbGVhbjtcbiAgcmVhZG9ubHkgc291cmNlQnVja2V0RW52aXJvbm1lbnRWYXJpYWJsZU5hbWU/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRlc3RpbmF0aW9uQnVja2V0RW52aXJvbm1lbnRWYXJpYWJsZU5hbWU/OiBzdHJpbmc7XG4gIHJlYWRvbmx5IGRhdGFBY2Nlc3NSb2xlQXJuRW52aXJvbm1lbnRWYXJpYWJsZU5hbWU/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVHJhbnNsYXRlQ29uZmlndXJhdGlvbiB7XG4gIHJlYWRvbmx5IHRyYW5zbGF0ZVJvbGU/OiBpYW0uUm9sZSxcbiAgcmVhZG9ubHkgbGFtYmRhSWFtQWN0aW9uc1JlcXVpcmVkOiBzdHJpbmdbXSxcbiAgcmVhZG9ubHkgc291cmNlQnVja2V0PzogQnVja2V0RGV0YWlscyxcbiAgcmVhZG9ubHkgZGVzdGluYXRpb25CdWNrZXQ/OiBCdWNrZXREZXRhaWxzLFxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJ1Y2tldERldGFpbHMge1xuICByZWFkb25seSBidWNrZXQ/OiBzMy5CdWNrZXQsXG4gIHJlYWRvbmx5IGJ1Y2tldEludGVyZmFjZTogczMuSUJ1Y2tldCxcbiAgcmVhZG9ubHkgbG9nZ2luZ0J1Y2tldD86IHMzLkJ1Y2tldFxufVxuXG5leHBvcnQgZnVuY3Rpb24gQ29uZmlndXJlVHJhbnNsYXRlU3VwcG9ydChzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogVHJhbnNsYXRlUHJvcHMpOiBUcmFuc2xhdGVDb25maWd1cmF0aW9uIHtcblxuICBsZXQgY29uZmlndXJhdGlvbjogVHJhbnNsYXRlQ29uZmlndXJhdGlvbiA9IHtcbiAgICBsYW1iZGFJYW1BY3Rpb25zUmVxdWlyZWQ6IFsndHJhbnNsYXRlOlRyYW5zbGF0ZVRleHQnLCAndHJhbnNsYXRlOlRyYW5zbGF0ZURvY3VtZW50J10sXG4gIH07XG5cbiAgaWYgKHByb3BzLmFzeW5jSm9icykge1xuXG4gICAgLy8gU2V0dXAgc291cmNlIFMzIEJ1Y2tldFxuICAgIGlmIChwcm9wcy5leGlzdGluZ1NvdXJjZUJ1Y2tldE9iaikge1xuICAgICAgY29uZmlndXJhdGlvbiA9IG92ZXJyaWRlUHJvcHMoY29uZmlndXJhdGlvbiwge1xuICAgICAgICBzb3VyY2VCdWNrZXQ6IHtcbiAgICAgICAgICBidWNrZXRJbnRlcmZhY2U6IHByb3BzLmV4aXN0aW5nU291cmNlQnVja2V0T2JqXG4gICAgICAgIH1cbiAgICAgIH0sIGZhbHNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYnVpbGRTb3VyY2VCdWNrZXRSZXNwb25zZSA9IGJ1aWxkUzNCdWNrZXQoc2NvcGUsIHtcbiAgICAgICAgYnVja2V0UHJvcHM6IHByb3BzLnNvdXJjZUJ1Y2tldFByb3BzLFxuICAgICAgICBsb2dnaW5nQnVja2V0UHJvcHM6IHByb3BzLnNvdXJjZUxvZ2dpbmdCdWNrZXRQcm9wcyxcbiAgICAgICAgbG9nUzNBY2Nlc3NMb2dzOiBwcm9wcy5sb2dTb3VyY2VTM0FjY2Vzc0xvZ3NcbiAgICAgIH0sIGAke2lkfS1zb3VyY2UtYnVja2V0YCk7XG4gICAgICBjb25maWd1cmF0aW9uID0gb3ZlcnJpZGVQcm9wcyhjb25maWd1cmF0aW9uLCB7XG4gICAgICAgIHNvdXJjZUJ1Y2tldDoge1xuICAgICAgICAgIGJ1Y2tldDogYnVpbGRTb3VyY2VCdWNrZXRSZXNwb25zZS5idWNrZXQsXG4gICAgICAgICAgbG9nZ2luZ0J1Y2tldDogYnVpbGRTb3VyY2VCdWNrZXRSZXNwb25zZS5sb2dnaW5nQnVja2V0LFxuICAgICAgICAgIGJ1Y2tldEludGVyZmFjZTogYnVpbGRTb3VyY2VCdWNrZXRSZXNwb25zZS5idWNrZXQsXG4gICAgICAgIH1cbiAgICAgIH0sIGZhbHNlKTtcbiAgICB9XG5cbiAgICAvLyBTZXR1cCBkZXN0aW5hdGlvbiBTMyBCdWNrZXRcbiAgICBpZiAocHJvcHMudXNlU2FtZUJ1Y2tldCkge1xuICAgICAgY29uZmlndXJhdGlvbiA9IG92ZXJyaWRlUHJvcHMoY29uZmlndXJhdGlvbiwge1xuICAgICAgICBkZXN0aW5hdGlvbkJ1Y2tldDoge1xuICAgICAgICAgIGJ1Y2tldEludGVyZmFjZTogY29uZmlndXJhdGlvbi5zb3VyY2VCdWNrZXQ/LmJ1Y2tldEludGVyZmFjZSxcbiAgICAgICAgICBidWNrZXQ6IGNvbmZpZ3VyYXRpb24uc291cmNlQnVja2V0Py5idWNrZXQsXG4gICAgICAgICAgbG9nZ2luZ0J1Y2tldDogY29uZmlndXJhdGlvbi5zb3VyY2VCdWNrZXQ/LmxvZ2dpbmdCdWNrZXQsXG4gICAgICAgIH1cbiAgICAgIH0sIGZhbHNlKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHByb3BzLmV4aXN0aW5nRGVzdGluYXRpb25CdWNrZXRPYmopIHtcbiAgICAgICAgY29uZmlndXJhdGlvbiA9IG92ZXJyaWRlUHJvcHMoY29uZmlndXJhdGlvbiwge1xuICAgICAgICAgIGRlc3RpbmF0aW9uQnVja2V0OiB7XG4gICAgICAgICAgICBidWNrZXRJbnRlcmZhY2U6IHByb3BzLmV4aXN0aW5nRGVzdGluYXRpb25CdWNrZXRPYmpcbiAgICAgICAgICB9XG4gICAgICAgIH0sIGZhbHNlKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGJ1aWxkRGVzdGluYXRpb25CdWNrZXRSZXNwb25zZSA9IGJ1aWxkUzNCdWNrZXQoc2NvcGUsIHtcbiAgICAgICAgICBidWNrZXRQcm9wczogcHJvcHMuZGVzdGluYXRpb25CdWNrZXRQcm9wcyxcbiAgICAgICAgICBsb2dnaW5nQnVja2V0UHJvcHM6IHByb3BzLmRlc3RpbmF0aW9uTG9nZ2luZ0J1Y2tldFByb3BzLFxuICAgICAgICAgIGxvZ1MzQWNjZXNzTG9nczogcHJvcHMubG9nRGVzdGluYXRpb25TM0FjY2Vzc0xvZ3NcbiAgICAgICAgfSwgYCR7aWR9LWRlc3RpbmF0aW9uLWJ1Y2tldGApO1xuICAgICAgICBjb25maWd1cmF0aW9uID0gb3ZlcnJpZGVQcm9wcyhjb25maWd1cmF0aW9uLCB7XG4gICAgICAgICAgZGVzdGluYXRpb25CdWNrZXQ6IHtcbiAgICAgICAgICAgIGJ1Y2tldDogYnVpbGREZXN0aW5hdGlvbkJ1Y2tldFJlc3BvbnNlLmJ1Y2tldCxcbiAgICAgICAgICAgIGxvZ2dpbmdCdWNrZXQ6IGJ1aWxkRGVzdGluYXRpb25CdWNrZXRSZXNwb25zZS5sb2dnaW5nQnVja2V0LFxuICAgICAgICAgICAgYnVja2V0SW50ZXJmYWNlOiBidWlsZERlc3RpbmF0aW9uQnVja2V0UmVzcG9uc2UuYnVja2V0LFxuICAgICAgICAgIH1cbiAgICAgICAgfSwgZmFsc2UpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFNldCB1cCByb2xlIHRoYXQgaXMgc2VudCB0byB0aGUgVHJhbnNsYXRlIHNlcnZpY2VcbiAgICBjb25zdCB0cmFuc2xhdGVTZXJ2aWNlUm9sZSA9IG5ldyBpYW0uUm9sZShzY29wZSwgYCR7aWR9LXRyYW5zbGF0ZS1zZXJ2aWNlLXJvbGVgLCB7XG4gICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uU2VydmljZVByaW5jaXBhbCgndHJhbnNsYXRlLmFtYXpvbmF3cy5jb20nKSxcbiAgICB9KTtcbiAgICBjb25maWd1cmF0aW9uLmRlc3RpbmF0aW9uQnVja2V0Py5idWNrZXRJbnRlcmZhY2UuZ3JhbnRSZWFkV3JpdGUodHJhbnNsYXRlU2VydmljZVJvbGUpO1xuICAgIGNvbmZpZ3VyYXRpb24uc291cmNlQnVja2V0Py5idWNrZXRJbnRlcmZhY2UuZ3JhbnRSZWFkKHRyYW5zbGF0ZVNlcnZpY2VSb2xlKTtcbiAgICBjb25maWd1cmF0aW9uID0gb3ZlcnJpZGVQcm9wcyhjb25maWd1cmF0aW9uLCB7XG4gICAgICB0cmFuc2xhdGVSb2xlOiB0cmFuc2xhdGVTZXJ2aWNlUm9sZVxuICAgIH0sIGZhbHNlKTtcblxuICAgIC8vIEdpdmUgdGhlIExhbWJkYSBmdW5jdGlvbiBhZGRpdGlvbmFsIHBlcm1pc3Npb25zXG4gICAgY29uZmlndXJhdGlvbi5sYW1iZGFJYW1BY3Rpb25zUmVxdWlyZWQucHVzaChcInRyYW5zbGF0ZTpEZXNjcmliZVRleHRUcmFuc2xhdGlvbkpvYlwiKTtcbiAgICBjb25maWd1cmF0aW9uLmxhbWJkYUlhbUFjdGlvbnNSZXF1aXJlZC5wdXNoKFwidHJhbnNsYXRlOkxpc3RUZXh0VHJhbnNsYXRpb25Kb2JzXCIpO1xuICAgIGNvbmZpZ3VyYXRpb24ubGFtYmRhSWFtQWN0aW9uc1JlcXVpcmVkLnB1c2goXCJ0cmFuc2xhdGU6U3RhcnRUZXh0VHJhbnNsYXRpb25Kb2JcIik7XG4gICAgY29uZmlndXJhdGlvbi5sYW1iZGFJYW1BY3Rpb25zUmVxdWlyZWQucHVzaChcInRyYW5zbGF0ZTpTdG9wVGV4dFRyYW5zbGF0aW9uSm9iXCIpO1xuXG4gIH1cbiAgcmV0dXJuIGNvbmZpZ3VyYXRpb247XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBDaGVja1RyYW5zbGF0ZVByb3BzKHByb3BzOiBUcmFuc2xhdGVQcm9wcyk6IHZvaWQge1xuICBsZXQgZXJyb3JNZXNzYWdlcyA9ICcnO1xuICBsZXQgZXJyb3JGb3VuZCA9IGZhbHNlO1xuXG4gIGlmIChwcm9wcy5hc3luY0pvYnMpIHtcblxuICAgIC8vIENoZWNrIHNvdXJjZSBidWNrZXQgcHJvcHNcbiAgICBjb25zdCBzb3VyY2VTM1Byb3BzID0ge1xuICAgICAgZXhpc3RpbmdCdWNrZXRPYmo6IHByb3BzLmV4aXN0aW5nU291cmNlQnVja2V0T2JqLFxuICAgICAgYnVja2V0UHJvcHM6IHByb3BzLnNvdXJjZUJ1Y2tldFByb3BzLFxuICAgICAgbG9nZ2luZ0J1Y2tldFByb3BzOiBwcm9wcy5zb3VyY2VMb2dnaW5nQnVja2V0UHJvcHMsXG4gICAgICBsb2dTM0FjY2Vzc0xvZ3M6IHByb3BzLmxvZ1NvdXJjZVMzQWNjZXNzTG9nc1xuICAgIH07XG4gICAgQ2hlY2tTM1Byb3BzKHNvdXJjZVMzUHJvcHMpO1xuXG4gICAgLy8gQ2hlY2sgZGVzdGluYXRpb24gYnVja2V0IHByb3BzIChvbmx5IGlmIG5vdCB1c2luZyBzYW1lIGJ1Y2tldClcbiAgICBpZiAoIXByb3BzLnVzZVNhbWVCdWNrZXQpIHtcbiAgICAgIGNvbnN0IGRlc3RpbmF0aW9uUzNQcm9wcyA9IHtcbiAgICAgICAgZXhpc3RpbmdCdWNrZXRPYmo6IHByb3BzLmV4aXN0aW5nRGVzdGluYXRpb25CdWNrZXRPYmosXG4gICAgICAgIGJ1Y2tldFByb3BzOiBwcm9wcy5kZXN0aW5hdGlvbkJ1Y2tldFByb3BzLFxuICAgICAgICBsb2dnaW5nQnVja2V0UHJvcHM6IHByb3BzLmRlc3RpbmF0aW9uTG9nZ2luZ0J1Y2tldFByb3BzLFxuICAgICAgICBsb2dTM0FjY2Vzc0xvZ3M6IHByb3BzLmxvZ0Rlc3RpbmF0aW9uUzNBY2Nlc3NMb2dzXG4gICAgICB9O1xuICAgICAgQ2hlY2tTM1Byb3BzKGRlc3RpbmF0aW9uUzNQcm9wcyk7XG4gICAgfVxuICB9XG5cbiAgLy8gSWYgYXN5bmNKb2JzIGlzIGZhbHNlLCBubyBTMyBidWNrZXQgcHJvcHMgc2hvdWxkIGJlIHByb3ZpZGVkXG4gIGlmICghcHJvcHMuYXN5bmNKb2JzKSB7XG4gICAgaWYgKHByb3BzLmV4aXN0aW5nU291cmNlQnVja2V0T2JqIHx8IHByb3BzLnNvdXJjZUJ1Y2tldFByb3BzIHx8XG4gICAgICBwcm9wcy5leGlzdGluZ0Rlc3RpbmF0aW9uQnVja2V0T2JqIHx8IHByb3BzLmRlc3RpbmF0aW9uQnVja2V0UHJvcHMgfHxcbiAgICAgIHByb3BzLnNvdXJjZUxvZ2dpbmdCdWNrZXRQcm9wcyB8fCBwcm9wcy5kZXN0aW5hdGlvbkxvZ2dpbmdCdWNrZXRQcm9wcyB8fFxuICAgICAgcHJvcHMubG9nU291cmNlUzNBY2Nlc3NMb2dzICE9PSB1bmRlZmluZWQgfHwgcHJvcHMubG9nRGVzdGluYXRpb25TM0FjY2Vzc0xvZ3MgIT09IHVuZGVmaW5lZCB8fFxuICAgICAgcHJvcHMuc291cmNlQnVja2V0RW52aXJvbm1lbnRWYXJpYWJsZU5hbWUgfHwgcHJvcHMuZGVzdGluYXRpb25CdWNrZXRFbnZpcm9ubWVudFZhcmlhYmxlTmFtZSB8fFxuICAgICAgIHByb3BzLmRhdGFBY2Nlc3NSb2xlQXJuRW52aXJvbm1lbnRWYXJpYWJsZU5hbWUgfHxwcm9wcy51c2VTYW1lQnVja2V0KSB7XG4gICAgICBlcnJvck1lc3NhZ2VzICs9ICdTMyBidWNrZXQgcHJvcGVydGllcyBjYW4gb25seSBiZSBwcm92aWRlZCB3aGVuIGFzeW5jSm9icyBpcyB0cnVlJztcbiAgICAgIGVycm9yRm91bmQgPSB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIC8vIElmIHVzZVNhbWVCdWNrZXQgaXMgdHJ1ZSwgbm8gZGVzdGluYXRpb24gYnVja2V0IHByb3BzIHNob3VsZCBiZSBwcm92aWRlZFxuICBpZiAocHJvcHMudXNlU2FtZUJ1Y2tldCkge1xuICAgIGlmIChwcm9wcy5leGlzdGluZ0Rlc3RpbmF0aW9uQnVja2V0T2JqIHx8IHByb3BzLmRlc3RpbmF0aW9uQnVja2V0UHJvcHMgfHxcbiAgICAgIHByb3BzLmRlc3RpbmF0aW9uTG9nZ2luZ0J1Y2tldFByb3BzIHx8IHByb3BzLmxvZ0Rlc3RpbmF0aW9uUzNBY2Nlc3NMb2dzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGVycm9yTWVzc2FnZXMgKz0gJ0Rlc3RpbmF0aW9uIGJ1Y2tldCBwcm9wZXJ0aWVzIGNhbm5vdCBiZSBwcm92aWRlZCB3aGVuIHVzZVNhbWVCdWNrZXQgaXMgdHJ1ZSc7XG4gICAgICBlcnJvckZvdW5kID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBpZiAoZXJyb3JGb3VuZCkge1xuICAgIHRocm93IG5ldyBFcnJvcihlcnJvck1lc3NhZ2VzKTtcbiAgfVxufVxuIl19
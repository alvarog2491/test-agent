"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CustomTransformation = exports.TransformationStep = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
/**
 * Defines the step in the ingestion process where the custom transformation is applied.
 */
var TransformationStep;
(function (TransformationStep) {
    /**
     * Processes documents after they have been converted into chunks.
     * This allows for custom chunk-level metadata addition or custom post-chunking logic.
     */
    TransformationStep["POST_CHUNKING"] = "POST_CHUNKING";
})(TransformationStep || (exports.TransformationStep = TransformationStep = {}));
/**
 * Represents a custom transformation configuration for a data source ingestion.
 * @see https://docs.aws.amazon.com/bedrock/latest/userguide/kb-chunking-parsing.html#kb-custom-transformation
 */
class CustomTransformation {
    // ------------------------------------------------------
    // Lambda Transformation Strategy
    // ------------------------------------------------------
    /**
     * This feature allows you to use a Lambda function to inject your own logic
     * into the knowledge base ingestion process.
     * @see https://github.com/aws-samples/amazon-bedrock-samples/blob/main/knowledge-bases/features-examples/02-optimizing-accuracy-retrieved-results/advanced_chunking_options.ipynb
     */
    static lambda(props) {
        class LambdaCustomTransformation extends CustomTransformation {
            constructor() {
                super(...arguments);
                this.configuration = {
                    intermediateStorage: {
                        s3Location: {
                            uri: props.s3BucketUri,
                        },
                    },
                    transformations: [
                        {
                            stepToApply: TransformationStep.POST_CHUNKING,
                            // To uncomment when more steps are available
                            // stepToApply: props.stepToApply ?? TransformationStep.POST_CHUNKING,
                            transformationFunction: {
                                transformationLambdaConfiguration: {
                                    lambdaArn: props.lambdaFunction.functionArn,
                                },
                            },
                        },
                    ],
                };
            }
            generatePolicyStatements(scope) {
                return [
                    new aws_iam_1.PolicyStatement({
                        actions: ['lambda:InvokeFunction'],
                        resources: [`${props.lambdaFunction.functionArn}:*`],
                        conditions: {
                            StringEquals: {
                                'aws:ResourceAccount': aws_cdk_lib_1.Stack.of(scope).account,
                            },
                        },
                    }),
                ];
            }
        }
        return new LambdaCustomTransformation();
    }
}
exports.CustomTransformation = CustomTransformation;
_a = JSII_RTTI_SYMBOL_1;
CustomTransformation[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.CustomTransformation", version: "0.1.312" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tLXRyYW5zZm9ybWF0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2Nkay1saWIvYmVkcm9jay9kYXRhLXNvdXJjZXMvY3VzdG9tLXRyYW5zZm9ybWF0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7QUFFSCw2Q0FBb0M7QUFFcEMsaURBQXNEO0FBSXREOztHQUVHO0FBQ0gsSUFBWSxrQkFNWDtBQU5ELFdBQVksa0JBQWtCO0lBQzVCOzs7T0FHRztJQUNILHFEQUErQixDQUFBO0FBQ2pDLENBQUMsRUFOVyxrQkFBa0Isa0NBQWxCLGtCQUFrQixRQU03QjtBQTBCRDs7O0dBR0c7QUFDSCxNQUFzQixvQkFBb0I7SUFDeEMseURBQXlEO0lBQ3pELGlDQUFpQztJQUNqQyx5REFBeUQ7SUFDekQ7Ozs7T0FJRztJQUNJLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBc0M7UUFDekQsTUFBTSwwQkFBMkIsU0FBUSxvQkFBb0I7WUFBN0Q7O2dCQUNrQixrQkFBYSxHQUFHO29CQUM5QixtQkFBbUIsRUFBRTt3QkFDbkIsVUFBVSxFQUFFOzRCQUNWLEdBQUcsRUFBRSxLQUFLLENBQUMsV0FBVzt5QkFDdkI7cUJBQ0Y7b0JBQ0QsZUFBZSxFQUFFO3dCQUNmOzRCQUNFLFdBQVcsRUFBRSxrQkFBa0IsQ0FBQyxhQUFhOzRCQUM3Qyw2Q0FBNkM7NEJBQzdDLHNFQUFzRTs0QkFDdEUsc0JBQXNCLEVBQUU7Z0NBQ3RCLGlDQUFpQyxFQUFFO29DQUNqQyxTQUFTLEVBQUUsS0FBSyxDQUFDLGNBQWMsQ0FBQyxXQUFXO2lDQUM1Qzs2QkFDRjt5QkFDRjtxQkFDRjtpQkFDRixDQUFDO1lBY0osQ0FBQztZQWJRLHdCQUF3QixDQUFDLEtBQWdCO2dCQUM5QyxPQUFPO29CQUNMLElBQUkseUJBQWUsQ0FBQzt3QkFDbEIsT0FBTyxFQUFFLENBQUMsdUJBQXVCLENBQUM7d0JBQ2xDLFNBQVMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLGNBQWMsQ0FBQyxXQUFXLElBQUksQ0FBQzt3QkFDcEQsVUFBVSxFQUFFOzRCQUNWLFlBQVksRUFBRTtnQ0FDWixxQkFBcUIsRUFBRSxtQkFBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxPQUFPOzZCQUMvQzt5QkFDRjtxQkFDRixDQUFDO2lCQUNILENBQUM7WUFDSixDQUFDO1NBQ0Y7UUFDRCxPQUFPLElBQUksMEJBQTBCLEVBQUUsQ0FBQztJQUMxQyxDQUFDOztBQTdDSCxvREF1REMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqICBDb3B5cmlnaHQgQW1hem9uLmNvbSwgSW5jLiBvciBpdHMgYWZmaWxpYXRlcy4gQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiAgTGljZW5zZWQgdW5kZXIgdGhlIEFwYWNoZSBMaWNlbnNlLCBWZXJzaW9uIDIuMCAodGhlIFwiTGljZW5zZVwiKS4gWW91IG1heSBub3QgdXNlIHRoaXMgZmlsZSBleGNlcHQgaW4gY29tcGxpYW5jZVxuICogIHdpdGggdGhlIExpY2Vuc2UuIEEgY29weSBvZiB0aGUgTGljZW5zZSBpcyBsb2NhdGVkIGF0XG4gKlxuICogICAgICBodHRwOi8vd3d3LmFwYWNoZS5vcmcvbGljZW5zZXMvTElDRU5TRS0yLjBcbiAqXG4gKiAgb3IgaW4gdGhlICdsaWNlbnNlJyBmaWxlIGFjY29tcGFueWluZyB0aGlzIGZpbGUuIFRoaXMgZmlsZSBpcyBkaXN0cmlidXRlZCBvbiBhbiAnQVMgSVMnIEJBU0lTLCBXSVRIT1VUIFdBUlJBTlRJRVNcbiAqICBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBleHByZXNzIG9yIGltcGxpZWQuIFNlZSB0aGUgTGljZW5zZSBmb3IgdGhlIHNwZWNpZmljIGxhbmd1YWdlIGdvdmVybmluZyBwZXJtaXNzaW9uc1xuICogIGFuZCBsaW1pdGF0aW9ucyB1bmRlciB0aGUgTGljZW5zZS5cbiAqL1xuXG5pbXBvcnQgeyBTdGFjayB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCB7IENmbkRhdGFTb3VyY2UgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtYmVkcm9jayc7XG5pbXBvcnQgeyBQb2xpY3lTdGF0ZW1lbnQgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtaWFtJztcbmltcG9ydCB7IElGdW5jdGlvbiB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cyc7XG5cbi8qKlxuICogRGVmaW5lcyB0aGUgc3RlcCBpbiB0aGUgaW5nZXN0aW9uIHByb2Nlc3Mgd2hlcmUgdGhlIGN1c3RvbSB0cmFuc2Zvcm1hdGlvbiBpcyBhcHBsaWVkLlxuICovXG5leHBvcnQgZW51bSBUcmFuc2Zvcm1hdGlvblN0ZXAge1xuICAvKipcbiAgICogUHJvY2Vzc2VzIGRvY3VtZW50cyBhZnRlciB0aGV5IGhhdmUgYmVlbiBjb252ZXJ0ZWQgaW50byBjaHVua3MuXG4gICAqIFRoaXMgYWxsb3dzIGZvciBjdXN0b20gY2h1bmstbGV2ZWwgbWV0YWRhdGEgYWRkaXRpb24gb3IgY3VzdG9tIHBvc3QtY2h1bmtpbmcgbG9naWMuXG4gICAqL1xuICBQT1NUX0NIVU5LSU5HID0gJ1BPU1RfQ0hVTktJTkcnLFxufVxuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGNvbmZpZ3VyaW5nIGEgTGFtYmRhLWJhc2VkIGN1c3RvbSB0cmFuc2Zvcm1hdGlvbi5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBMYW1iZGFDdXN0b21UcmFuc2Zvcm1hdGlvblByb3BzIHtcbiAgLyoqXG4gICAqIFRoZSBMYW1iZGEgZnVuY3Rpb24gdG8gdXNlIGZvciBjdXN0b20gZG9jdW1lbnQgcHJvY2Vzc2luZy5cbiAgICovXG4gIHJlYWRvbmx5IGxhbWJkYUZ1bmN0aW9uOiBJRnVuY3Rpb247XG5cbiAgLyoqXG4gICAqIEFuIFMzIGJ1Y2tldCBVUkwvcGF0aCB0byBzdG9yZSBpbnB1dCBkb2N1bWVudHMgZm9yIExhbWJkYSBwcm9jZXNzaW5nXG4gICAqIGFuZCB0byBzdG9yZSB0aGUgb3V0cHV0IG9mIHRoZSBwcm9jZXNzZWQgZG9jdW1lbnRzLlxuICAgKiBAZXhhbXBsZSBcInMzOi8vbXktYnVja2V0L2NodW5rLXByb2Nlc3Nvci9cIlxuICAgKi9cbiAgcmVhZG9ubHkgczNCdWNrZXRVcmk6IHN0cmluZztcblxuICAvLyBDb21tZW50ZWQgYXMgb25seSBvbmUgc3VwcG9ydGVkIGF0IHRoZSB0aW1lIHRoaXMgY29kZSBpcyB3cml0dGVuLlxuICAvLyAvKipcbiAgLy8gICogV2hlbiBpbiB0aGUgaW5nZXN0aW9uIHByb2Nlc3MgdG8gYXBwbHkgdGhlIHRyYW5zZm9ybWF0aW9uIHN0ZXAuXG4gIC8vICAqIEBkZWZhdWx0IFRyYW5zZm9ybWF0aW9uU3RlcC5QT1NUX0NIVU5LSU5HXG4gIC8vICAqL1xuICAvLyByZWFkb25seSBzdGVwVG9BcHBseT86IFRyYW5zZm9ybWF0aW9uU3RlcDtcbn1cblxuLyoqXG4gKiBSZXByZXNlbnRzIGEgY3VzdG9tIHRyYW5zZm9ybWF0aW9uIGNvbmZpZ3VyYXRpb24gZm9yIGEgZGF0YSBzb3VyY2UgaW5nZXN0aW9uLlxuICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vYmVkcm9jay9sYXRlc3QvdXNlcmd1aWRlL2tiLWNodW5raW5nLXBhcnNpbmcuaHRtbCNrYi1jdXN0b20tdHJhbnNmb3JtYXRpb25cbiAqL1xuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEN1c3RvbVRyYW5zZm9ybWF0aW9uIHtcbiAgLy8gLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gIC8vIExhbWJkYSBUcmFuc2Zvcm1hdGlvbiBTdHJhdGVneVxuICAvLyAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAgLyoqXG4gICAqIFRoaXMgZmVhdHVyZSBhbGxvd3MgeW91IHRvIHVzZSBhIExhbWJkYSBmdW5jdGlvbiB0byBpbmplY3QgeW91ciBvd24gbG9naWNcbiAgICogaW50byB0aGUga25vd2xlZGdlIGJhc2UgaW5nZXN0aW9uIHByb2Nlc3MuXG4gICAqIEBzZWUgaHR0cHM6Ly9naXRodWIuY29tL2F3cy1zYW1wbGVzL2FtYXpvbi1iZWRyb2NrLXNhbXBsZXMvYmxvYi9tYWluL2tub3dsZWRnZS1iYXNlcy9mZWF0dXJlcy1leGFtcGxlcy8wMi1vcHRpbWl6aW5nLWFjY3VyYWN5LXJldHJpZXZlZC1yZXN1bHRzL2FkdmFuY2VkX2NodW5raW5nX29wdGlvbnMuaXB5bmJcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgbGFtYmRhKHByb3BzOiBMYW1iZGFDdXN0b21UcmFuc2Zvcm1hdGlvblByb3BzKTogQ3VzdG9tVHJhbnNmb3JtYXRpb24ge1xuICAgIGNsYXNzIExhbWJkYUN1c3RvbVRyYW5zZm9ybWF0aW9uIGV4dGVuZHMgQ3VzdG9tVHJhbnNmb3JtYXRpb24ge1xuICAgICAgcHVibGljIHJlYWRvbmx5IGNvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgIGludGVybWVkaWF0ZVN0b3JhZ2U6IHtcbiAgICAgICAgICBzM0xvY2F0aW9uOiB7XG4gICAgICAgICAgICB1cmk6IHByb3BzLnMzQnVja2V0VXJpLFxuICAgICAgICAgIH0sXG4gICAgICAgIH0sXG4gICAgICAgIHRyYW5zZm9ybWF0aW9uczogW1xuICAgICAgICAgIHtcbiAgICAgICAgICAgIHN0ZXBUb0FwcGx5OiBUcmFuc2Zvcm1hdGlvblN0ZXAuUE9TVF9DSFVOS0lORyxcbiAgICAgICAgICAgIC8vIFRvIHVuY29tbWVudCB3aGVuIG1vcmUgc3RlcHMgYXJlIGF2YWlsYWJsZVxuICAgICAgICAgICAgLy8gc3RlcFRvQXBwbHk6IHByb3BzLnN0ZXBUb0FwcGx5ID8/IFRyYW5zZm9ybWF0aW9uU3RlcC5QT1NUX0NIVU5LSU5HLFxuICAgICAgICAgICAgdHJhbnNmb3JtYXRpb25GdW5jdGlvbjoge1xuICAgICAgICAgICAgICB0cmFuc2Zvcm1hdGlvbkxhbWJkYUNvbmZpZ3VyYXRpb246IHtcbiAgICAgICAgICAgICAgICBsYW1iZGFBcm46IHByb3BzLmxhbWJkYUZ1bmN0aW9uLmZ1bmN0aW9uQXJuLFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9LFxuICAgICAgICBdLFxuICAgICAgfTtcbiAgICAgIHB1YmxpYyBnZW5lcmF0ZVBvbGljeVN0YXRlbWVudHMoc2NvcGU6IENvbnN0cnVjdCk6IFBvbGljeVN0YXRlbWVudFtdIHtcbiAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICBuZXcgUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGFjdGlvbnM6IFsnbGFtYmRhOkludm9rZUZ1bmN0aW9uJ10sXG4gICAgICAgICAgICByZXNvdXJjZXM6IFtgJHtwcm9wcy5sYW1iZGFGdW5jdGlvbi5mdW5jdGlvbkFybn06KmBdLFxuICAgICAgICAgICAgY29uZGl0aW9uczoge1xuICAgICAgICAgICAgICBTdHJpbmdFcXVhbHM6IHtcbiAgICAgICAgICAgICAgICAnYXdzOlJlc291cmNlQWNjb3VudCc6IFN0YWNrLm9mKHNjb3BlKS5hY2NvdW50LFxuICAgICAgICAgICAgICB9LFxuICAgICAgICAgICAgfSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgXTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIG5ldyBMYW1iZGFDdXN0b21UcmFuc2Zvcm1hdGlvbigpO1xuICB9XG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvLyBQcm9wZXJ0aWVzXG4gIC8vIC0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICAvKipcbiAgICogVGhlIENsb3VkRm9ybWF0aW9uIHByb3BlcnR5IHJlcHJlc2VudGF0aW9uIG9mIHRoaXMgY3VzdG9tIHRyYW5zZm9ybWF0aW9uIGNvbmZpZ3VyYXRpb24uXG4gICAqL1xuICBwdWJsaWMgYWJzdHJhY3QgY29uZmlndXJhdGlvbjogQ2ZuRGF0YVNvdXJjZS5DdXN0b21UcmFuc2Zvcm1hdGlvbkNvbmZpZ3VyYXRpb25Qcm9wZXJ0eTtcblxuICBwdWJsaWMgYWJzdHJhY3QgZ2VuZXJhdGVQb2xpY3lTdGF0ZW1lbnRzKHNjb3BlOiBDb25zdHJ1Y3QpOiBQb2xpY3lTdGF0ZW1lbnRbXTtcbn1cbiJdfQ==
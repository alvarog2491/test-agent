"use strict";
var _a;
Object.defineProperty(exports, "__esModule", { value: true });
exports.CrossRegionInferenceProfile = exports.REGION_TO_GEO_AREA = exports.CrossRegionInferenceProfileRegion = void 0;
const JSII_RTTI_SYMBOL_1 = Symbol.for("jsii.rtti");
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
const aws_cdk_lib_1 = require("aws-cdk-lib");
const aws_iam_1 = require("aws-cdk-lib/aws-iam");
const common_1 = require("./common");
var CrossRegionInferenceProfileRegion;
(function (CrossRegionInferenceProfileRegion) {
    /**
     * Cross-region Inference Identifier for the European area.
     * According to the model chosen, this might include:
     * - Frankfurt (`eu-central-1`)
     * - Ireland (`eu-west-1`)
     * - Paris (`eu-west-3`)
     */
    CrossRegionInferenceProfileRegion["EU"] = "eu";
    /**
     * Cross-region Inference Identifier for the United States area.
     * According to the model chosen, this might include:
     * - N. Virginia (`us-east-1`)
     * - Oregon (`us-west-2`)
     * - Ohio (`us-east-2`)
     */
    CrossRegionInferenceProfileRegion["US"] = "us";
    /**
     * Cross-region Inference Identifier for the Asia-Pacific area.
     * According to the model chosen, this might include:
     * - Tokyo (`ap-northeast-1`)
     * - Seoul (`ap-northeast-2`)
     * - Mumbai (`ap-south-1`)
     * - Singapore (`ap-southeast-1`)
     * - Sydney (`ap-southeast-2`)
     */
    CrossRegionInferenceProfileRegion["APAC"] = "apac";
})(CrossRegionInferenceProfileRegion || (exports.CrossRegionInferenceProfileRegion = CrossRegionInferenceProfileRegion = {}));
exports.REGION_TO_GEO_AREA = {
    // US Regions
    'us-east-1': CrossRegionInferenceProfileRegion.US, // N. Virginia
    'us-east-2': CrossRegionInferenceProfileRegion.US, // Ohio
    'us-west-2': CrossRegionInferenceProfileRegion.US, // Oregon
    // EU Regions
    'eu-central-1': CrossRegionInferenceProfileRegion.EU, // Frankfurt
    'eu-west-1': CrossRegionInferenceProfileRegion.EU, // Ireland
    'eu-west-3': CrossRegionInferenceProfileRegion.EU, // Paris
    // APAC Regions
    'ap-northeast-1': CrossRegionInferenceProfileRegion.APAC, // Tokyo
    'ap-northeast-2': CrossRegionInferenceProfileRegion.APAC, // Seoul
    'ap-south-1': CrossRegionInferenceProfileRegion.APAC, // Mumbai
    'ap-southeast-1': CrossRegionInferenceProfileRegion.APAC, // Singapore
    'ap-southeast-2': CrossRegionInferenceProfileRegion.APAC, // Sydney
};
/******************************************************************************
 *                        NEW CONSTRUCT DEFINITION
 *****************************************************************************/
/**
 * Cross-region inference enables you to seamlessly manage unplanned traffic
 * bursts by utilizing compute across different AWS Regions. With cross-region
 * inference, you can distribute traffic across multiple AWS Regions, enabling
 * higher throughput and enhanced resilience during periods of peak demands.
 * @see https://docs.aws.amazon.com/bedrock/latest/userguide/cross-region-inference.html
 */
class CrossRegionInferenceProfile {
    static fromConfig(config) {
        return new CrossRegionInferenceProfile(config);
    }
    constructor(props) {
        if (!props.model.supportsCrossRegion) {
            throw new Error(`Model ${props.model.modelId} does not support cross-region inference`);
        }
        this.type = common_1.InferenceProfileType.SYSTEM_DEFINED;
        this.inferenceProfileModel = props.model;
        this.inferenceProfileId = `${props.geoRegion}.${props.model.modelId}`;
        this.inferenceProfileArn = aws_cdk_lib_1.Arn.format({
            partition: aws_cdk_lib_1.Aws.PARTITION,
            service: 'bedrock',
            account: aws_cdk_lib_1.Aws.ACCOUNT_ID,
            region: aws_cdk_lib_1.Aws.REGION,
            resource: 'inference-profile',
            resourceName: this.inferenceProfileId,
            arnFormat: aws_cdk_lib_1.ArnFormat.SLASH_RESOURCE_NAME,
        });
        // Needed to Implement IInvokable
        this.invokableArn = this.inferenceProfileArn;
    }
    /**
     * Gives the appropriate policies to invoke and use the Foundation Model.
     */
    grantInvoke(grantee) {
        // for CRIS, we need to provide permissions to invoke the model in all regions
        // where the inference profile can route requests
        this.inferenceProfileModel.grantInvokeAllRegions(grantee);
        // and we need to provide permissions to invoke the inference profile itself
        return this.grantProfileUsage(grantee);
    }
    /**
     * Grants appropriate permissions to use the cross-region inference profile.
     * Does not grant permissions to use the model in the profile.
     */
    grantProfileUsage(grantee) {
        const grant = aws_iam_1.Grant.addToPrincipal({
            grantee: grantee,
            actions: ['bedrock:GetInferenceProfile', 'bedrock:InvokeModel*'],
            resourceArns: [this.inferenceProfileArn],
        });
        return grant;
    }
}
exports.CrossRegionInferenceProfile = CrossRegionInferenceProfile;
_a = JSII_RTTI_SYMBOL_1;
CrossRegionInferenceProfile[_a] = { fqn: "@cdklabs/generative-ai-cdk-constructs.bedrock.CrossRegionInferenceProfile", version: "0.1.312" };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3Jvc3MtcmVnaW9uLWluZmVyZW5jZS1wcm9maWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2Nkay1saWIvYmVkcm9jay9pbmZlcmVuY2UtcHJvZmlsZXMvY3Jvc3MtcmVnaW9uLWluZmVyZW5jZS1wcm9maWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7QUFFSCw2Q0FBa0Q7QUFDbEQsaURBQXdEO0FBRXhELHFDQUFtRTtBQUVuRSxJQUFZLGlDQTJCWDtBQTNCRCxXQUFZLGlDQUFpQztJQUMzQzs7Ozs7O09BTUc7SUFDSCw4Q0FBUyxDQUFBO0lBQ1Q7Ozs7OztPQU1HO0lBQ0gsOENBQVMsQ0FBQTtJQUNUOzs7Ozs7OztPQVFHO0lBQ0gsa0RBQWEsQ0FBQTtBQUNmLENBQUMsRUEzQlcsaUNBQWlDLGlEQUFqQyxpQ0FBaUMsUUEyQjVDO0FBRVksUUFBQSxrQkFBa0IsR0FBeUQ7SUFDdEYsYUFBYTtJQUNiLFdBQVcsRUFBRSxpQ0FBaUMsQ0FBQyxFQUFFLEVBQUUsY0FBYztJQUNqRSxXQUFXLEVBQUUsaUNBQWlDLENBQUMsRUFBRSxFQUFFLE9BQU87SUFDMUQsV0FBVyxFQUFFLGlDQUFpQyxDQUFDLEVBQUUsRUFBRSxTQUFTO0lBRTVELGFBQWE7SUFDYixjQUFjLEVBQUUsaUNBQWlDLENBQUMsRUFBRSxFQUFFLFlBQVk7SUFDbEUsV0FBVyxFQUFFLGlDQUFpQyxDQUFDLEVBQUUsRUFBRSxVQUFVO0lBQzdELFdBQVcsRUFBRSxpQ0FBaUMsQ0FBQyxFQUFFLEVBQUUsUUFBUTtJQUUzRCxlQUFlO0lBQ2YsZ0JBQWdCLEVBQUUsaUNBQWlDLENBQUMsSUFBSSxFQUFFLFFBQVE7SUFDbEUsZ0JBQWdCLEVBQUUsaUNBQWlDLENBQUMsSUFBSSxFQUFFLFFBQVE7SUFDbEUsWUFBWSxFQUFFLGlDQUFpQyxDQUFDLElBQUksRUFBRSxTQUFTO0lBQy9ELGdCQUFnQixFQUFFLGlDQUFpQyxDQUFDLElBQUksRUFBRSxZQUFZO0lBQ3RFLGdCQUFnQixFQUFFLGlDQUFpQyxDQUFDLElBQUksRUFBRSxTQUFTO0NBQ3BFLENBQUM7QUFrQkY7OytFQUUrRTtBQUMvRTs7Ozs7O0dBTUc7QUFDSCxNQUFhLDJCQUEyQjtJQUMvQixNQUFNLENBQUMsVUFBVSxDQUFDLE1BQXdDO1FBQy9ELE9BQU8sSUFBSSwyQkFBMkIsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNqRCxDQUFDO0lBb0JELFlBQW9CLEtBQXVDO1FBQ3pELElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDckMsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTywwQ0FBMEMsQ0FBQyxDQUFDO1FBQzFGLENBQUM7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLDZCQUFvQixDQUFDLGNBQWMsQ0FBQztRQUNoRCxJQUFJLENBQUMscUJBQXFCLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUN6QyxJQUFJLENBQUMsa0JBQWtCLEdBQUcsR0FBRyxLQUFLLENBQUMsU0FBUyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDdEUsSUFBSSxDQUFDLG1CQUFtQixHQUFHLGlCQUFHLENBQUMsTUFBTSxDQUFDO1lBQ3BDLFNBQVMsRUFBRSxpQkFBRyxDQUFDLFNBQVM7WUFDeEIsT0FBTyxFQUFFLFNBQVM7WUFDbEIsT0FBTyxFQUFFLGlCQUFHLENBQUMsVUFBVTtZQUN2QixNQUFNLEVBQUUsaUJBQUcsQ0FBQyxNQUFNO1lBQ2xCLFFBQVEsRUFBRSxtQkFBbUI7WUFDN0IsWUFBWSxFQUFFLElBQUksQ0FBQyxrQkFBa0I7WUFDckMsU0FBUyxFQUFFLHVCQUFTLENBQUMsbUJBQW1CO1NBQ3pDLENBQUMsQ0FBQztRQUNILGlDQUFpQztRQUNqQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztJQUMvQyxDQUFDO0lBRUQ7O09BRUc7SUFDSSxXQUFXLENBQUMsT0FBbUI7UUFDcEMsOEVBQThFO1FBQzlFLGlEQUFpRDtRQUNqRCxJQUFJLENBQUMscUJBQXFCLENBQUMscUJBQXFCLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDMUQsNEVBQTRFO1FBQzVFLE9BQU8sSUFBSSxDQUFDLGlCQUFpQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3pDLENBQUM7SUFFRDs7O09BR0c7SUFDSCxpQkFBaUIsQ0FBQyxPQUFtQjtRQUNuQyxNQUFNLEtBQUssR0FBRyxlQUFLLENBQUMsY0FBYyxDQUFDO1lBQ2pDLE9BQU8sRUFBRSxPQUFPO1lBQ2hCLE9BQU8sRUFBRSxDQUFDLDZCQUE2QixFQUFFLHNCQUFzQixDQUFDO1lBQ2hFLFlBQVksRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQztTQUN6QyxDQUFDLENBQUM7UUFDSCxPQUFPLEtBQUssQ0FBQztJQUNmLENBQUM7O0FBakVILGtFQWtFQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCB7IEFybiwgQXJuRm9ybWF0LCBBd3MgfSBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBHcmFudCwgSUdyYW50YWJsZSB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1pYW0nO1xuaW1wb3J0IHsgQmVkcm9ja0ZvdW5kYXRpb25Nb2RlbCwgSUludm9rYWJsZSB9IGZyb20gJy4uL21vZGVscyc7XG5pbXBvcnQgeyBJSW5mZXJlbmNlUHJvZmlsZSwgSW5mZXJlbmNlUHJvZmlsZVR5cGUgfSBmcm9tICcuL2NvbW1vbic7XG5cbmV4cG9ydCBlbnVtIENyb3NzUmVnaW9uSW5mZXJlbmNlUHJvZmlsZVJlZ2lvbiB7XG4gIC8qKlxuICAgKiBDcm9zcy1yZWdpb24gSW5mZXJlbmNlIElkZW50aWZpZXIgZm9yIHRoZSBFdXJvcGVhbiBhcmVhLlxuICAgKiBBY2NvcmRpbmcgdG8gdGhlIG1vZGVsIGNob3NlbiwgdGhpcyBtaWdodCBpbmNsdWRlOlxuICAgKiAtIEZyYW5rZnVydCAoYGV1LWNlbnRyYWwtMWApXG4gICAqIC0gSXJlbGFuZCAoYGV1LXdlc3QtMWApXG4gICAqIC0gUGFyaXMgKGBldS13ZXN0LTNgKVxuICAgKi9cbiAgRVUgPSAnZXUnLFxuICAvKipcbiAgICogQ3Jvc3MtcmVnaW9uIEluZmVyZW5jZSBJZGVudGlmaWVyIGZvciB0aGUgVW5pdGVkIFN0YXRlcyBhcmVhLlxuICAgKiBBY2NvcmRpbmcgdG8gdGhlIG1vZGVsIGNob3NlbiwgdGhpcyBtaWdodCBpbmNsdWRlOlxuICAgKiAtIE4uIFZpcmdpbmlhIChgdXMtZWFzdC0xYClcbiAgICogLSBPcmVnb24gKGB1cy13ZXN0LTJgKVxuICAgKiAtIE9oaW8gKGB1cy1lYXN0LTJgKVxuICAgKi9cbiAgVVMgPSAndXMnLFxuICAvKipcbiAgICogQ3Jvc3MtcmVnaW9uIEluZmVyZW5jZSBJZGVudGlmaWVyIGZvciB0aGUgQXNpYS1QYWNpZmljIGFyZWEuXG4gICAqIEFjY29yZGluZyB0byB0aGUgbW9kZWwgY2hvc2VuLCB0aGlzIG1pZ2h0IGluY2x1ZGU6XG4gICAqIC0gVG9reW8gKGBhcC1ub3J0aGVhc3QtMWApXG4gICAqIC0gU2VvdWwgKGBhcC1ub3J0aGVhc3QtMmApXG4gICAqIC0gTXVtYmFpIChgYXAtc291dGgtMWApXG4gICAqIC0gU2luZ2Fwb3JlIChgYXAtc291dGhlYXN0LTFgKVxuICAgKiAtIFN5ZG5leSAoYGFwLXNvdXRoZWFzdC0yYClcbiAgICovXG4gIEFQQUMgPSAnYXBhYycsXG59XG5cbmV4cG9ydCBjb25zdCBSRUdJT05fVE9fR0VPX0FSRUE6IHsgW2tleTogc3RyaW5nXTogQ3Jvc3NSZWdpb25JbmZlcmVuY2VQcm9maWxlUmVnaW9uIH0gPSB7XG4gIC8vIFVTIFJlZ2lvbnNcbiAgJ3VzLWVhc3QtMSc6IENyb3NzUmVnaW9uSW5mZXJlbmNlUHJvZmlsZVJlZ2lvbi5VUywgLy8gTi4gVmlyZ2luaWFcbiAgJ3VzLWVhc3QtMic6IENyb3NzUmVnaW9uSW5mZXJlbmNlUHJvZmlsZVJlZ2lvbi5VUywgLy8gT2hpb1xuICAndXMtd2VzdC0yJzogQ3Jvc3NSZWdpb25JbmZlcmVuY2VQcm9maWxlUmVnaW9uLlVTLCAvLyBPcmVnb25cblxuICAvLyBFVSBSZWdpb25zXG4gICdldS1jZW50cmFsLTEnOiBDcm9zc1JlZ2lvbkluZmVyZW5jZVByb2ZpbGVSZWdpb24uRVUsIC8vIEZyYW5rZnVydFxuICAnZXUtd2VzdC0xJzogQ3Jvc3NSZWdpb25JbmZlcmVuY2VQcm9maWxlUmVnaW9uLkVVLCAvLyBJcmVsYW5kXG4gICdldS13ZXN0LTMnOiBDcm9zc1JlZ2lvbkluZmVyZW5jZVByb2ZpbGVSZWdpb24uRVUsIC8vIFBhcmlzXG5cbiAgLy8gQVBBQyBSZWdpb25zXG4gICdhcC1ub3J0aGVhc3QtMSc6IENyb3NzUmVnaW9uSW5mZXJlbmNlUHJvZmlsZVJlZ2lvbi5BUEFDLCAvLyBUb2t5b1xuICAnYXAtbm9ydGhlYXN0LTInOiBDcm9zc1JlZ2lvbkluZmVyZW5jZVByb2ZpbGVSZWdpb24uQVBBQywgLy8gU2VvdWxcbiAgJ2FwLXNvdXRoLTEnOiBDcm9zc1JlZ2lvbkluZmVyZW5jZVByb2ZpbGVSZWdpb24uQVBBQywgLy8gTXVtYmFpXG4gICdhcC1zb3V0aGVhc3QtMSc6IENyb3NzUmVnaW9uSW5mZXJlbmNlUHJvZmlsZVJlZ2lvbi5BUEFDLCAvLyBTaW5nYXBvcmVcbiAgJ2FwLXNvdXRoZWFzdC0yJzogQ3Jvc3NSZWdpb25JbmZlcmVuY2VQcm9maWxlUmVnaW9uLkFQQUMsIC8vIFN5ZG5leVxufTtcblxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogICAgICAgICAgICAgICAgICAgICAgICBQUk9QUyBGT1IgTkVXIENPTlNUUlVDVFxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqL1xuZXhwb3J0IGludGVyZmFjZSBDcm9zc1JlZ2lvbkluZmVyZW5jZVByb2ZpbGVQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgZ2VvZ3JhcGhpYyByZWdpb24gd2hlcmUgdGhlIHRyYWZmaWMgaXMgZ29pbmcgdG8gYmUgZGlzdHJpYnV0ZWQuIFJvdXRpbmdcbiAgICogZmFjdG9ycyBpbiB1c2VyIHRyYWZmaWMsIGRlbWFuZCBhbmQgdXRpbGl6YXRpb24gb2YgcmVzb3VyY2VzLlxuICAgKi9cbiAgcmVhZG9ubHkgZ2VvUmVnaW9uOiBDcm9zc1JlZ2lvbkluZmVyZW5jZVByb2ZpbGVSZWdpb247XG4gIC8qKlxuICAgKiBBIG1vZGVsIHN1cHBvcnRpbmcgY3Jvc3MtcmVnaW9uIGluZmVyZW5jZS5cbiAgICogQHNlZSBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vYmVkcm9jay9sYXRlc3QvdXNlcmd1aWRlL2Nyb3NzLXJlZ2lvbi1pbmZlcmVuY2Utc3VwcG9ydC5odG1sXG4gICAqL1xuICByZWFkb25seSBtb2RlbDogQmVkcm9ja0ZvdW5kYXRpb25Nb2RlbDtcbn1cblxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKlxuICogICAgICAgICAgICAgICAgICAgICAgICBORVcgQ09OU1RSVUNUIERFRklOSVRJT05cbiAqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKi9cbi8qKlxuICogQ3Jvc3MtcmVnaW9uIGluZmVyZW5jZSBlbmFibGVzIHlvdSB0byBzZWFtbGVzc2x5IG1hbmFnZSB1bnBsYW5uZWQgdHJhZmZpY1xuICogYnVyc3RzIGJ5IHV0aWxpemluZyBjb21wdXRlIGFjcm9zcyBkaWZmZXJlbnQgQVdTIFJlZ2lvbnMuIFdpdGggY3Jvc3MtcmVnaW9uXG4gKiBpbmZlcmVuY2UsIHlvdSBjYW4gZGlzdHJpYnV0ZSB0cmFmZmljIGFjcm9zcyBtdWx0aXBsZSBBV1MgUmVnaW9ucywgZW5hYmxpbmdcbiAqIGhpZ2hlciB0aHJvdWdocHV0IGFuZCBlbmhhbmNlZCByZXNpbGllbmNlIGR1cmluZyBwZXJpb2RzIG9mIHBlYWsgZGVtYW5kcy5cbiAqIEBzZWUgaHR0cHM6Ly9kb2NzLmF3cy5hbWF6b24uY29tL2JlZHJvY2svbGF0ZXN0L3VzZXJndWlkZS9jcm9zcy1yZWdpb24taW5mZXJlbmNlLmh0bWxcbiAqL1xuZXhwb3J0IGNsYXNzIENyb3NzUmVnaW9uSW5mZXJlbmNlUHJvZmlsZSBpbXBsZW1lbnRzIElJbnZva2FibGUsIElJbmZlcmVuY2VQcm9maWxlIHtcbiAgcHVibGljIHN0YXRpYyBmcm9tQ29uZmlnKGNvbmZpZzogQ3Jvc3NSZWdpb25JbmZlcmVuY2VQcm9maWxlUHJvcHMpOiBDcm9zc1JlZ2lvbkluZmVyZW5jZVByb2ZpbGUge1xuICAgIHJldHVybiBuZXcgQ3Jvc3NSZWdpb25JbmZlcmVuY2VQcm9maWxlKGNvbmZpZyk7XG4gIH1cbiAgLyoqXG4gICAqIEluZmVyZW5jZSBwcm9maWxlIElEXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgaW5mZXJlbmNlUHJvZmlsZUlkOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBJbmZlcmVuY2UgcHJvZmlsZSBBUk5cbiAgICovXG4gIHB1YmxpYyByZWFkb25seSBpbmZlcmVuY2VQcm9maWxlQXJuOiBzdHJpbmc7XG4gIC8qKlxuICAgKiBJbmZlcmVuY2UgcHJvZmlsZSB0eXBlXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgdHlwZTogSW5mZXJlbmNlUHJvZmlsZVR5cGU7XG4gIC8qKlxuICAgKiBUaGUgdW5kZXJseWluZyBtb2RlbCBzdXBwb3J0aW5nIGNyb3NzLXJlZ2lvbiBpbmZlcmVuY2UuXG4gICAqL1xuICBwdWJsaWMgcmVhZG9ubHkgaW5mZXJlbmNlUHJvZmlsZU1vZGVsOiBCZWRyb2NrRm91bmRhdGlvbk1vZGVsO1xuICAvKiogVGhpcyBlcXVhbHMgdG8gdGhlIGluZmVyZW5jZVByb2ZpbGVBcm4gcHJvcGVydHksIHVzZWZ1bCBqdXN0IHRvIGltcGxlbWVudCBJSW52b2thYmxlIGludGVyZmFjZSovXG4gIHB1YmxpYyByZWFkb25seSBpbnZva2FibGVBcm46IHN0cmluZztcblxuICBwcml2YXRlIGNvbnN0cnVjdG9yKHByb3BzOiBDcm9zc1JlZ2lvbkluZmVyZW5jZVByb2ZpbGVQcm9wcykge1xuICAgIGlmICghcHJvcHMubW9kZWwuc3VwcG9ydHNDcm9zc1JlZ2lvbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBNb2RlbCAke3Byb3BzLm1vZGVsLm1vZGVsSWR9IGRvZXMgbm90IHN1cHBvcnQgY3Jvc3MtcmVnaW9uIGluZmVyZW5jZWApO1xuICAgIH1cbiAgICB0aGlzLnR5cGUgPSBJbmZlcmVuY2VQcm9maWxlVHlwZS5TWVNURU1fREVGSU5FRDtcbiAgICB0aGlzLmluZmVyZW5jZVByb2ZpbGVNb2RlbCA9IHByb3BzLm1vZGVsO1xuICAgIHRoaXMuaW5mZXJlbmNlUHJvZmlsZUlkID0gYCR7cHJvcHMuZ2VvUmVnaW9ufS4ke3Byb3BzLm1vZGVsLm1vZGVsSWR9YDtcbiAgICB0aGlzLmluZmVyZW5jZVByb2ZpbGVBcm4gPSBBcm4uZm9ybWF0KHtcbiAgICAgIHBhcnRpdGlvbjogQXdzLlBBUlRJVElPTixcbiAgICAgIHNlcnZpY2U6ICdiZWRyb2NrJyxcbiAgICAgIGFjY291bnQ6IEF3cy5BQ0NPVU5UX0lELFxuICAgICAgcmVnaW9uOiBBd3MuUkVHSU9OLFxuICAgICAgcmVzb3VyY2U6ICdpbmZlcmVuY2UtcHJvZmlsZScsXG4gICAgICByZXNvdXJjZU5hbWU6IHRoaXMuaW5mZXJlbmNlUHJvZmlsZUlkLFxuICAgICAgYXJuRm9ybWF0OiBBcm5Gb3JtYXQuU0xBU0hfUkVTT1VSQ0VfTkFNRSxcbiAgICB9KTtcbiAgICAvLyBOZWVkZWQgdG8gSW1wbGVtZW50IElJbnZva2FibGVcbiAgICB0aGlzLmludm9rYWJsZUFybiA9IHRoaXMuaW5mZXJlbmNlUHJvZmlsZUFybjtcbiAgfVxuXG4gIC8qKlxuICAgKiBHaXZlcyB0aGUgYXBwcm9wcmlhdGUgcG9saWNpZXMgdG8gaW52b2tlIGFuZCB1c2UgdGhlIEZvdW5kYXRpb24gTW9kZWwuXG4gICAqL1xuICBwdWJsaWMgZ3JhbnRJbnZva2UoZ3JhbnRlZTogSUdyYW50YWJsZSk6IEdyYW50IHtcbiAgICAvLyBmb3IgQ1JJUywgd2UgbmVlZCB0byBwcm92aWRlIHBlcm1pc3Npb25zIHRvIGludm9rZSB0aGUgbW9kZWwgaW4gYWxsIHJlZ2lvbnNcbiAgICAvLyB3aGVyZSB0aGUgaW5mZXJlbmNlIHByb2ZpbGUgY2FuIHJvdXRlIHJlcXVlc3RzXG4gICAgdGhpcy5pbmZlcmVuY2VQcm9maWxlTW9kZWwuZ3JhbnRJbnZva2VBbGxSZWdpb25zKGdyYW50ZWUpO1xuICAgIC8vIGFuZCB3ZSBuZWVkIHRvIHByb3ZpZGUgcGVybWlzc2lvbnMgdG8gaW52b2tlIHRoZSBpbmZlcmVuY2UgcHJvZmlsZSBpdHNlbGZcbiAgICByZXR1cm4gdGhpcy5ncmFudFByb2ZpbGVVc2FnZShncmFudGVlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHcmFudHMgYXBwcm9wcmlhdGUgcGVybWlzc2lvbnMgdG8gdXNlIHRoZSBjcm9zcy1yZWdpb24gaW5mZXJlbmNlIHByb2ZpbGUuXG4gICAqIERvZXMgbm90IGdyYW50IHBlcm1pc3Npb25zIHRvIHVzZSB0aGUgbW9kZWwgaW4gdGhlIHByb2ZpbGUuXG4gICAqL1xuICBncmFudFByb2ZpbGVVc2FnZShncmFudGVlOiBJR3JhbnRhYmxlKTogR3JhbnQge1xuICAgIGNvbnN0IGdyYW50ID0gR3JhbnQuYWRkVG9QcmluY2lwYWwoe1xuICAgICAgZ3JhbnRlZTogZ3JhbnRlZSxcbiAgICAgIGFjdGlvbnM6IFsnYmVkcm9jazpHZXRJbmZlcmVuY2VQcm9maWxlJywgJ2JlZHJvY2s6SW52b2tlTW9kZWwqJ10sXG4gICAgICByZXNvdXJjZUFybnM6IFt0aGlzLmluZmVyZW5jZVByb2ZpbGVBcm5dLFxuICAgIH0pO1xuICAgIHJldHVybiBncmFudDtcbiAgfVxufVxuIl19
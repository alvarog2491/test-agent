"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.buildRedisCluster = buildRedisCluster;
exports.getRedisSecurityGroup = getRedisSecurityGroup;
exports.setInboundRules = setInboundRules;
exports.CheckRedisClusterProps = CheckRedisClusterProps;
const ec2 = require("aws-cdk-lib/aws-ec2");
const elasticache = require("aws-cdk-lib/aws-elasticache");
function buildRedisCluster(scope, props) {
    const cacheNodeType = props.cfnCacheClusterProps?.cacheNodeType || 'cache.r6g.xlarge';
    const engine = props.cfnCacheClusterProps?.engine || 'redis';
    const numCacheNodes = props.cfnCacheClusterProps?.numCacheNodes || 1;
    let redisCulster = new elasticache.CfnCacheCluster(scope, 'redisCluster', {
        cacheNodeType: cacheNodeType,
        engine: engine,
        numCacheNodes: numCacheNodes,
        cacheSubnetGroupName: getRedisSubnetGroup(scope, props).ref,
        vpcSecurityGroupIds: [props.redisSecurityGroup.securityGroupId],
        port: props.redisPort,
    });
    return redisCulster;
}
// get redis subnet group from existing vpc
function getRedisSubnetGroup(scope, props) {
    let redisSubnetGroup = new elasticache.CfnSubnetGroup(scope, 'redisSubnetGroup', {
        description: 'Redis subnet group',
        subnetIds: props.subnetIds,
    });
    return redisSubnetGroup;
}
// get redis security group from existing vpc
function getRedisSecurityGroup(scope, props) {
    let redisSecurityGroup = new ec2.SecurityGroup(scope, 'redisSecurityGroup', {
        vpc: props.existingVpc,
        allowAllOutbound: true,
        description: 'security group for elasticache',
    });
    return redisSecurityGroup;
}
function setInboundRules(redisSecurityGroup, sourceSecuritygroup, redisPort) {
    redisSecurityGroup.connections.allowFrom(sourceSecuritygroup, ec2.Port.tcp(redisPort));
}
function CheckRedisClusterProps(propsObject) {
    let errorMessages = '';
    let errorFound = false;
    if (propsObject.existingRedisCulster && propsObject.cfnCacheClusterProps) {
        errorMessages += 'Error - Either provide existingRedisCulster or cfnCacheClusterProps, but not both.\n';
        errorFound = true;
    }
    if (errorFound) {
        throw new Error(errorMessages);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVkaXMtaGVscGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2NvbW1vbi9oZWxwZXJzL3JlZGlzLWhlbHBlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7O0FBNkRILDhDQWNDO0FBWUQsc0RBU0M7QUFFRCwwQ0FLQztBQUVELHdEQVlDO0FBbkhELDJDQUEyQztBQUMzQywyREFBMkQ7QUEwRDNELFNBQWdCLGlCQUFpQixDQUFDLEtBQWdCLEVBQUUsS0FBaUI7SUFDbkUsTUFBTSxhQUFhLEdBQUcsS0FBSyxDQUFDLG9CQUFvQixFQUFFLGFBQWEsSUFBSSxrQkFBa0IsQ0FBQztJQUN0RixNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsTUFBTSxJQUFJLE9BQU8sQ0FBQztJQUM3RCxNQUFNLGFBQWEsR0FBRyxLQUFLLENBQUMsb0JBQW9CLEVBQUUsYUFBYSxJQUFJLENBQUMsQ0FBQztJQUVyRSxJQUFJLFlBQVksR0FBRyxJQUFJLFdBQVcsQ0FBQyxlQUFlLENBQUMsS0FBSyxFQUFFLGNBQWMsRUFBRTtRQUN4RSxhQUFhLEVBQUUsYUFBYTtRQUM1QixNQUFNLEVBQUUsTUFBTTtRQUNkLGFBQWEsRUFBRSxhQUFhO1FBQzVCLG9CQUFvQixFQUFFLG1CQUFtQixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxHQUFHO1FBQzNELG1CQUFtQixFQUFFLENBQUMsS0FBSyxDQUFDLGtCQUFtQixDQUFDLGVBQWUsQ0FBQztRQUNoRSxJQUFJLEVBQUUsS0FBSyxDQUFDLFNBQVM7S0FDdEIsQ0FBQyxDQUFDO0lBQ0gsT0FBTyxZQUFZLENBQUM7QUFDdEIsQ0FBQztBQUVELDJDQUEyQztBQUMzQyxTQUFTLG1CQUFtQixDQUFDLEtBQWdCLEVBQUUsS0FBaUI7SUFDOUQsSUFBSSxnQkFBZ0IsR0FBRyxJQUFJLFdBQVcsQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLGtCQUFrQixFQUFFO1FBQy9FLFdBQVcsRUFBRSxvQkFBb0I7UUFDakMsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO0tBQzNCLENBQUMsQ0FBQztJQUNILE9BQU8sZ0JBQWdCLENBQUM7QUFDMUIsQ0FBQztBQUVELDZDQUE2QztBQUM3QyxTQUFnQixxQkFBcUIsQ0FBQyxLQUFnQixFQUNwRCxLQUF1QjtJQUN2QixJQUFJLGtCQUFrQixHQUFHLElBQUksR0FBRyxDQUFDLGFBQWEsQ0FBQyxLQUFLLEVBQUUsb0JBQW9CLEVBQUU7UUFDMUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxXQUFXO1FBQ3RCLGdCQUFnQixFQUFFLElBQUk7UUFDdEIsV0FBVyxFQUFFLGdDQUFnQztLQUM5QyxDQUFDLENBQUM7SUFFSCxPQUFPLGtCQUFrQixDQUFDO0FBQzVCLENBQUM7QUFFRCxTQUFnQixlQUFlLENBQUMsa0JBQW9DLEVBQ2xFLG1CQUFzQyxFQUN0QyxTQUFnQjtJQUNoQixrQkFBa0IsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLG1CQUFtQixFQUMxRCxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO0FBQzdCLENBQUM7QUFFRCxTQUFnQixzQkFBc0IsQ0FBQyxXQUE2QjtJQUNsRSxJQUFJLGFBQWEsR0FBRyxFQUFFLENBQUM7SUFDdkIsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO0lBRXZCLElBQUksV0FBVyxDQUFDLG9CQUFvQixJQUFJLFdBQVcsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBQ3pFLGFBQWEsSUFBSSxzRkFBc0YsQ0FBQztRQUN4RyxVQUFVLEdBQUcsSUFBSSxDQUFDO0lBQ3BCLENBQUM7SUFFRCxJQUFJLFVBQVUsRUFBRSxDQUFDO1FBQ2YsTUFBTSxJQUFJLEtBQUssQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUNqQyxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogIENvcHlyaWdodCBBbWF6b24uY29tLCBJbmMuIG9yIGl0cyBhZmZpbGlhdGVzLiBBbGwgUmlnaHRzIFJlc2VydmVkLlxuICpcbiAqICBMaWNlbnNlZCB1bmRlciB0aGUgQXBhY2hlIExpY2Vuc2UsIFZlcnNpb24gMi4wICh0aGUgXCJMaWNlbnNlXCIpLiBZb3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlXG4gKiAgd2l0aCB0aGUgTGljZW5zZS4gQSBjb3B5IG9mIHRoZSBMaWNlbnNlIGlzIGxvY2F0ZWQgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqICBvciBpbiB0aGUgJ2xpY2Vuc2UnIGZpbGUgYWNjb21wYW55aW5nIHRoaXMgZmlsZS4gVGhpcyBmaWxlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuICdBUyBJUycgQkFTSVMsIFdJVEhPVVQgV0FSUkFOVElFU1xuICogIE9SIENPTkRJVElPTlMgT0YgQU5ZIEtJTkQsIGV4cHJlc3Mgb3IgaW1wbGllZC4gU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zXG4gKiAgYW5kIGxpbWl0YXRpb25zIHVuZGVyIHRoZSBMaWNlbnNlLlxuICovXG5cbmltcG9ydCAqIGFzIGVjMiBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJztcbmltcG9ydCAqIGFzIGVsYXN0aWNhY2hlIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lbGFzdGljYWNoZSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJztcblxuZXhwb3J0IGludGVyZmFjZSBSZWRpc1Byb3BzIHtcblxuICAvKipcbiAgICogUmVxdWlyZWQuIEV4aXN0aW5nIGluc3RhbmNlIG9mIGEgVlBDLCBpZiB0aGlzIGlzIHNldCB0aGVuIHRoZSBhbGwgUHJvcHMgYXJlIGlnbm9yZWQsXG4gICAqIGlmIHRoaXMgaXMgbm90IHNldCB0aGVuIGRlYWZ1bHRWUEMgUHJvcHMgYXJlIHVzZWQuXG4gICAqL1xuICByZWFkb25seSBleGlzdGluZ1ZwYzogZWMyLklWcGM7XG5cbiAgLyoqXG4gICAqIE9wdGlvbmFsIGNmbkNhY2hlQ2x1c3RlclByb3BzXG4gICAqIEBkZWZhdWx0IGNhY2hlTm9kZVR5cGUgLSAgJ2NhY2hlLnI2Zy54bGFyZ2UnXG4gICAqIEBkZWZhdWx0IG51bUNhY2hlTm9kZXMtIDFcbiAgICovXG4gIHJlYWRvbmx5IGNmbkNhY2hlQ2x1c3RlclByb3BzPzogZWxhc3RpY2FjaGUuQ2ZuQ2FjaGVDbHVzdGVyUHJvcHM7XG5cbiAgLyoqXG4gICAqIE9wdGlvbmFsLiBFeGlzdGluZyBSZWRpcyBjbHVzdGVyIHRvIGNhY2hlIHRoZSBnZW5lcmF0ZWQgc3VtbWFyeVxuICAgKiBmb3Igc3Vic2VxdWVudCByZXF1ZXN0IG9mIHNhbWUgZG9jdW1lbnQuXG4gICAqXG4gICAqIEBkZWZhdWx0IC0gbm9uZVxuICAgKi9cbiAgcmVhZG9ubHkgZXhpc3RpbmdSZWRpc0N1bHN0ZXI/OiBlbGFzdGljYWNoZS5DZm5DYWNoZUNsdXN0ZXI7XG5cbiAgLyoqXG4gICAqIE9wdGlvbmFsIC5uYW1lICBvZiByZWRpcyBTZWN1cml0eSBHcm91cFxuICAgKiBAZGVmYXVsdCAncmVkaXNTZWN1cml0eUdyb3VwJ1xuICAgKi9cbiAgcmVhZG9ubHkgcmVkaXNTZWN1cml0eUdyb3VwbmFtZT86IHN0cmluZztcblxuICAvKipcbiAgICogUmVxdWlyZWQuIHJlZGlzIFNlY3VyaXR5IEdyb3VwXG4gICAqXG4gICAqL1xuICByZWFkb25seSByZWRpc1NlY3VyaXR5R3JvdXA6IGVjMi5TZWN1cml0eUdyb3VwO1xuXG4gIC8qKlxuICAgKiBSZXF1aXJlZC4gbGlzdCBvZiBzdWJuZXQgSWRzXG4gICAqIEBkZWZhdWx0IE5vbmVcbiAgICovXG4gIHJlYWRvbmx5IHN1Ym5ldElkczogc3RyaW5nIFtdO1xuXG4gIC8qKlxuICAgKiBSZXF1aXJlZC4gbGFtYmRhIHNlY3VyaXR5IGdyb3VwIHdoaWNoIHdpbGwgYWNjZXMgdGhlIHJlZGlzIGNsdXN0ZXJcbiAgICpcbiAgICovXG4gIHJlYWRvbmx5IGluYm91bmRTZWN1cml0eUdyb3VwOiBlYzIuSVNlY3VyaXR5R3JvdXA7XG5cbiAgLyoqXG4gICAqIE9wdGlvbmFsLiByZWRpcyBwb3J0IG51bWJlclxuICAgKiBAZGVmYXVsdCByZWRpc1BvcnRcbiAgICovXG4gIHJlYWRvbmx5IHJlZGlzUG9ydD86IG51bWJlcjtcblxufVxuXG5leHBvcnQgZnVuY3Rpb24gYnVpbGRSZWRpc0NsdXN0ZXIoc2NvcGU6IENvbnN0cnVjdCwgcHJvcHM6IFJlZGlzUHJvcHMpOiBlbGFzdGljYWNoZS5DZm5DYWNoZUNsdXN0ZXIge1xuICBjb25zdCBjYWNoZU5vZGVUeXBlID0gcHJvcHMuY2ZuQ2FjaGVDbHVzdGVyUHJvcHM/LmNhY2hlTm9kZVR5cGUgfHwgJ2NhY2hlLnI2Zy54bGFyZ2UnO1xuICBjb25zdCBlbmdpbmUgPSBwcm9wcy5jZm5DYWNoZUNsdXN0ZXJQcm9wcz8uZW5naW5lIHx8ICdyZWRpcyc7XG4gIGNvbnN0IG51bUNhY2hlTm9kZXMgPSBwcm9wcy5jZm5DYWNoZUNsdXN0ZXJQcm9wcz8ubnVtQ2FjaGVOb2RlcyB8fCAxO1xuXG4gIGxldCByZWRpc0N1bHN0ZXIgPSBuZXcgZWxhc3RpY2FjaGUuQ2ZuQ2FjaGVDbHVzdGVyKHNjb3BlLCAncmVkaXNDbHVzdGVyJywge1xuICAgIGNhY2hlTm9kZVR5cGU6IGNhY2hlTm9kZVR5cGUsXG4gICAgZW5naW5lOiBlbmdpbmUsXG4gICAgbnVtQ2FjaGVOb2RlczogbnVtQ2FjaGVOb2RlcyxcbiAgICBjYWNoZVN1Ym5ldEdyb3VwTmFtZTogZ2V0UmVkaXNTdWJuZXRHcm91cChzY29wZSwgcHJvcHMpLnJlZixcbiAgICB2cGNTZWN1cml0eUdyb3VwSWRzOiBbcHJvcHMucmVkaXNTZWN1cml0eUdyb3VwIS5zZWN1cml0eUdyb3VwSWRdLFxuICAgIHBvcnQ6IHByb3BzLnJlZGlzUG9ydCxcbiAgfSk7XG4gIHJldHVybiByZWRpc0N1bHN0ZXI7XG59XG5cbi8vIGdldCByZWRpcyBzdWJuZXQgZ3JvdXAgZnJvbSBleGlzdGluZyB2cGNcbmZ1bmN0aW9uIGdldFJlZGlzU3VibmV0R3JvdXAoc2NvcGU6IENvbnN0cnVjdCwgcHJvcHM6IFJlZGlzUHJvcHMpOiBlbGFzdGljYWNoZS5DZm5TdWJuZXRHcm91cCB7XG4gIGxldCByZWRpc1N1Ym5ldEdyb3VwID0gbmV3IGVsYXN0aWNhY2hlLkNmblN1Ym5ldEdyb3VwKHNjb3BlLCAncmVkaXNTdWJuZXRHcm91cCcsIHtcbiAgICBkZXNjcmlwdGlvbjogJ1JlZGlzIHN1Ym5ldCBncm91cCcsXG4gICAgc3VibmV0SWRzOiBwcm9wcy5zdWJuZXRJZHMsXG4gIH0pO1xuICByZXR1cm4gcmVkaXNTdWJuZXRHcm91cDtcbn1cblxuLy8gZ2V0IHJlZGlzIHNlY3VyaXR5IGdyb3VwIGZyb20gZXhpc3RpbmcgdnBjXG5leHBvcnQgZnVuY3Rpb24gZ2V0UmVkaXNTZWN1cml0eUdyb3VwKHNjb3BlOiBDb25zdHJ1Y3QsXG4gIHByb3BzOiBSZWRpc1Byb3BzIHwgYW55ICk6IGVjMi5TZWN1cml0eUdyb3VwIHtcbiAgbGV0IHJlZGlzU2VjdXJpdHlHcm91cCA9IG5ldyBlYzIuU2VjdXJpdHlHcm91cChzY29wZSwgJ3JlZGlzU2VjdXJpdHlHcm91cCcsIHtcbiAgICB2cGM6IHByb3BzLmV4aXN0aW5nVnBjLFxuICAgIGFsbG93QWxsT3V0Ym91bmQ6IHRydWUsXG4gICAgZGVzY3JpcHRpb246ICdzZWN1cml0eSBncm91cCBmb3IgZWxhc3RpY2FjaGUnLFxuICB9KTtcblxuICByZXR1cm4gcmVkaXNTZWN1cml0eUdyb3VwO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0SW5ib3VuZFJ1bGVzKHJlZGlzU2VjdXJpdHlHcm91cDplYzIuU2VjdXJpdHlHcm91cCxcbiAgc291cmNlU2VjdXJpdHlncm91cDplYzIuSVNlY3VyaXR5R3JvdXAsXG4gIHJlZGlzUG9ydDpudW1iZXIpIHtcbiAgcmVkaXNTZWN1cml0eUdyb3VwLmNvbm5lY3Rpb25zLmFsbG93RnJvbShzb3VyY2VTZWN1cml0eWdyb3VwLFxuICAgIGVjMi5Qb3J0LnRjcChyZWRpc1BvcnQpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIENoZWNrUmVkaXNDbHVzdGVyUHJvcHMocHJvcHNPYmplY3Q6IFJlZGlzUHJvcHMgfCBhbnkpIHtcbiAgbGV0IGVycm9yTWVzc2FnZXMgPSAnJztcbiAgbGV0IGVycm9yRm91bmQgPSBmYWxzZTtcblxuICBpZiAocHJvcHNPYmplY3QuZXhpc3RpbmdSZWRpc0N1bHN0ZXIgJiYgcHJvcHNPYmplY3QuY2ZuQ2FjaGVDbHVzdGVyUHJvcHMpIHtcbiAgICBlcnJvck1lc3NhZ2VzICs9ICdFcnJvciAtIEVpdGhlciBwcm92aWRlIGV4aXN0aW5nUmVkaXNDdWxzdGVyIG9yIGNmbkNhY2hlQ2x1c3RlclByb3BzLCBidXQgbm90IGJvdGguXFxuJztcbiAgICBlcnJvckZvdW5kID0gdHJ1ZTtcbiAgfVxuXG4gIGlmIChlcnJvckZvdW5kKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTWVzc2FnZXMpO1xuICB9XG59XG4iXX0=
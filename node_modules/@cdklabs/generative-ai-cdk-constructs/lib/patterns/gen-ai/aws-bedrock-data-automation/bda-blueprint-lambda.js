"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.BdaBlueprintLambda = void 0;
const path = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const cdk_nag_1 = require("cdk-nag");
/**
 * Lambda function that manages BDA blueprint creation
 */
class BdaBlueprintLambda extends aws_cdk_lib_1.aws_lambda.Function {
    constructor(scope, id, props) {
        const role = new aws_cdk_lib_1.aws_iam.Role(scope, `${id}manageBlueprint`, {
            assumedBy: new aws_cdk_lib_1.aws_iam.ServicePrincipal('lambda.amazonaws.com'),
        });
        super(scope, id, {
            runtime: aws_cdk_lib_1.aws_lambda.Runtime.PYTHON_3_13,
            handler: 'lambda.handler',
            // eslint-disable-next-line @cdklabs/no-invalid-path
            code: aws_cdk_lib_1.aws_lambda.Code.fromAsset(path.join(__dirname, '../../../../lambda/aws-bedrock-data-automation/bda_blueprint')),
            layers: props.lambdaLayers,
            description: 'BDA control plane for BDA blueprint operations',
            environment: {
                INPUT_BUCKET: props.inputBucket.bucketName,
                POWERTOOLS_SERVICE_NAME: 'BEDROCK_BLUEPRINT',
            },
            memorySize: 1024,
            role: role,
            architecture: aws_cdk_lib_1.aws_lambda.Architecture.X86_64,
            timeout: aws_cdk_lib_1.Duration.minutes(15),
        });
        // Add basic permissions for CloudWatch logs
        const cloudwatchLogsPolicy = new aws_cdk_lib_1.aws_iam.Policy(scope, `${id}LambdaBasicExecPolicy`, {
            statements: [
                new aws_cdk_lib_1.aws_iam.PolicyStatement({
                    effect: aws_cdk_lib_1.aws_iam.Effect.ALLOW,
                    actions: [
                        'logs:CreateLogGroup',
                        'logs:CreateLogStream',
                        'logs:PutLogEvents',
                    ],
                    resources: [
                        `arn:${aws_cdk_lib_1.Aws.PARTITION}:logs:${aws_cdk_lib_1.Aws.REGION}:${aws_cdk_lib_1.Aws.ACCOUNT_ID}:log-group:/aws/lambda/${this.functionName}`,
                        `arn:${aws_cdk_lib_1.Aws.PARTITION}:logs:${aws_cdk_lib_1.Aws.REGION}:${aws_cdk_lib_1.Aws.ACCOUNT_ID}:log-group:/aws/lambda/${this.functionName}:*`,
                    ],
                }),
            ],
        });
        cdk_nag_1.NagSuppressions.addResourceSuppressions(cloudwatchLogsPolicy, [{ id: 'AwsSolutions-IAM5', reason: 'Lambda requires CloudWatch logs permissions with log group name patterns' }]);
        role.attachInlinePolicy(cloudwatchLogsPolicy);
        // Permissions for BDA
        const BedrockBDABPPolicy = new aws_cdk_lib_1.aws_iam.Policy(scope, `${id}BedrockBDABPPolicy`, {
            statements: [
                new aws_cdk_lib_1.aws_iam.PolicyStatement({
                    effect: aws_cdk_lib_1.aws_iam.Effect.ALLOW,
                    actions: [
                        'bedrock:ListBlueprints',
                        'bedrock:DeleteBlueprint',
                        'bedrock:InvokeBlueprint',
                        'bedrock:ListBlueprintInvocations',
                        'bedrock:GetBlueprintInvocation',
                    ],
                    resources: ['*'],
                }),
            ],
        });
        cdk_nag_1.NagSuppressions.addResourceSuppressions(BedrockBDABPPolicy, [{
                id: 'AwsSolutions-IAM5',
                reason: 'Bedrock Blueprint operations require access to all blueprints as resource-level permissions are not supported',
            }], true);
        role.attachInlinePolicy(BedrockBDABPPolicy);
        const bedrockBDABPVersionPolicy = new aws_cdk_lib_1.aws_iam.Policy(scope, `${id}BedrockBDABPVersionPolicy`, {
            statements: [
                new aws_cdk_lib_1.aws_iam.PolicyStatement({
                    effect: aws_cdk_lib_1.aws_iam.Effect.ALLOW,
                    actions: [
                        'bedrock:CreateBlueprint',
                        'bedrock:CreateBlueprintVersion',
                    ],
                    resources: ['*'],
                }),
            ],
        });
        cdk_nag_1.NagSuppressions.addResourceSuppressions(bedrockBDABPVersionPolicy, [{
                id: 'AwsSolutions-IAM5',
                reason: 'Bedrock Blueprint version creation operations require access to all blueprints as resource-level permissions are not supported',
            }], true);
        role.attachInlinePolicy(bedrockBDABPVersionPolicy);
        // Give Lambda access to the bucket
        if (this.role) {
            props.inputBucket.grantRead(this.role);
        }
        cdk_nag_1.NagSuppressions.addResourceSuppressions(role, [{
                id: 'AwsSolutions-IAM5',
                reason: 'Lambda needs read access to process files from the input bucket',
            }], true);
    }
}
exports.BdaBlueprintLambda = BdaBlueprintLambda;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmRhLWJsdWVwcmludC1sYW1iZGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcGF0dGVybnMvZ2VuLWFpL2F3cy1iZWRyb2NrLWRhdGEtYXV0b21hdGlvbi9iZGEtYmx1ZXByaW50LWxhbWJkYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7OztBQUVILDZCQUE2QjtBQUM3Qiw2Q0FBa0Y7QUFFbEYscUNBQTBDO0FBbUIxQzs7R0FFRztBQUNILE1BQWEsa0JBQW1CLFNBQVEsd0JBQU0sQ0FBQyxRQUFRO0lBQ3JELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBOEI7UUFDdEUsTUFBTSxJQUFJLEdBQUcsSUFBSSxxQkFBRyxDQUFDLElBQUksQ0FDdkIsS0FBSyxFQUNMLEdBQUcsRUFBRSxpQkFBaUIsRUFDdEI7WUFDRSxTQUFTLEVBQUUsSUFBSSxxQkFBRyxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDO1NBQzVELENBQ0YsQ0FBQztRQUVGLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFO1lBRWYsT0FBTyxFQUFFLHdCQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsT0FBTyxFQUFFLGdCQUFnQjtZQUN6QixvREFBb0Q7WUFDcEQsSUFBSSxFQUFFLHdCQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSw4REFBOEQsQ0FBQyxDQUFDO1lBQ2pILE1BQU0sRUFBRSxLQUFLLENBQUMsWUFBWTtZQUMxQixXQUFXLEVBQUUsZ0RBQWdEO1lBQzdELFdBQVcsRUFBRTtnQkFDWCxZQUFZLEVBQUUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxVQUFVO2dCQUMxQyx1QkFBdUIsRUFBRSxtQkFBbUI7YUFDN0M7WUFDRCxVQUFVLEVBQUUsSUFBSTtZQUNoQixJQUFJLEVBQUUsSUFBSTtZQUNWLFlBQVksRUFBRSx3QkFBTSxDQUFD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QUMsQ0FBQztRQUN6QyxDQUFDO1FBRUQseUJBQWUsQ0FBQyx1QkFBdUIsQ0FDckMsSUFBSSxFQUNKLENBQUM7Z0JBQ0MsRUFBRSxFQUFFLG1CQUFtQjtnQkFDdkIsTUFBTSxFQUFFLGlFQUFpRTthQUMxRSxDQUFDLEVBQ0YsSUFBSSxDQUNMLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFuSUQsZ0RBbUlDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGF3c19pYW0gYXMgaWFtLCBhd3NfbGFtYmRhIGFzIGxhbWJkYSwgRHVyYXRpb24sIEF3cyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgeyBOYWdTdXBwcmVzc2lvbnMgfSBmcm9tICdjZGstbmFnJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGNyZWF0aW5nIGEgQmRhQmx1ZXByaW50TGFtYmRhXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQmRhQmx1ZXByaW50TGFtYmRhUHJvcHMge1xuICAvKipcbiAgICogVGhlIFMzIGJ1Y2tldFxuICAgKiBmb3IgaW5wdXQgZGF0YSB1c2VkIGJ5IHRoZSBCZWRyb2NrIERhdGEgQXV0b21hdGlvbiBwcm9jZXNzLlxuICAgKiBJZiBub3QgcHJvdmlkZWQsIGEgbmV3IGJ1Y2tldCB3aWxsIGJlIGNyZWF0ZWQuXG4gICAqL1xuICByZWFkb25seSBpbnB1dEJ1Y2tldDogczMuSUJ1Y2tldDtcbiAgLyoqXG4gICAqIFRoZSBsYXllcnMgdG8gYXBwbHkgdG8gdGhpcyBsYW1iZGEgZnVuY3Rpb24uXG4gICAqL1xuICByZWFkb25seSBsYW1iZGFMYXllcnM6IGxhbWJkYS5JTGF5ZXJWZXJzaW9uW107XG59XG5cbi8qKlxuICogTGFtYmRhIGZ1bmN0aW9uIHRoYXQgbWFuYWdlcyBCREEgYmx1ZXByaW50IGNyZWF0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBCZGFCbHVlcHJpbnRMYW1iZGEgZXh0ZW5kcyBsYW1iZGEuRnVuY3Rpb24ge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQmRhQmx1ZXByaW50TGFtYmRhUHJvcHMpIHtcbiAgICBjb25zdCByb2xlID0gbmV3IGlhbS5Sb2xlKFxuICAgICAgc2NvcGUsXG4gICAgICBgJHtpZH1tYW5hZ2VCbHVlcHJpbnRgLFxuICAgICAge1xuICAgICAgICBhc3N1bWVkQnk6IG5ldyBpYW0uU2VydmljZVByaW5jaXBhbCgnbGFtYmRhLmFtYXpvbmF3cy5jb20nKSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIHN1cGVyKHNjb3BlLCBpZCwge1xuXG4gICAgICBydW50aW1lOiBsYW1iZGEuUnVudGltZS5QWVRIT05fM18xMyxcbiAgICAgIGhhbmRsZXI6ICdsYW1iZGEuaGFuZGxlcicsXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQGNka2xhYnMvbm8taW52YWxpZC1wYXRoXG4gICAgICBjb2RlOiBsYW1iZGEuQ29kZS5mcm9tQXNzZXQocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uLy4uLy4uLy4uL2xhbWJkYS9hd3MtYmVkcm9jay1kYXRhLWF1dG9tYXRpb24vYmRhX2JsdWVwcmludCcpKSxcbiAgICAgIGxheWVyczogcHJvcHMubGFtYmRhTGF5ZXJzLFxuICAgICAgZGVzY3JpcHRpb246ICdCREEgY29udHJvbCBwbGFuZSBmb3IgQkRBIGJsdWVwcmludCBvcGVyYXRpb25zJyxcbiAgICAgIGVudmlyb25tZW50OiB7XG4gICAgICAgIElOUFVUX0JVQ0tFVDogcHJvcHMuaW5wdXRCdWNrZXQuYnVja2V0TmFtZSxcbiAgICAgICAgUE9XRVJUT09MU19TRVJWSUNFX05BTUU6ICdCRURST0NLX0JMVUVQUklOVCcsXG4gICAgICB9LFxuICAgICAgbWVtb3J5U2l6ZTogMTAyNCxcbiAgICAgIHJvbGU6IHJvbGUsXG4gICAgICBhcmNoaXRlY3R1cmU6IGxhbWJkYS5BcmNoaXRlY3R1cmUuWDg2XzY0LFxuICAgICAgdGltZW91dDogRHVyYXRpb24ubWludXRlcygxNSksXG4gICAgfSk7XG5cbiAgICAvLyBBZGQgYmFzaWMgcGVybWlzc2lvbnMgZm9yIENsb3VkV2F0Y2ggbG9nc1xuICAgIGNvbnN0IGNsb3Vkd2F0Y2hMb2dzUG9saWN5ID0gbmV3IGlhbS5Qb2xpY3koXG4gICAgICBzY29wZSxcbiAgICAgIGAke2lkfUxhbWJkYUJhc2ljRXhlY1BvbGljeWAsXG4gICAgICB7XG4gICAgICAgIHN0YXRlbWVudHM6IFtcbiAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICdsb2dzOkNyZWF0ZUxvZ0dyb3VwJyxcbiAgICAgICAgICAgICAgJ2xvZ3M6Q3JlYXRlTG9nU3RyZWFtJyxcbiAgICAgICAgICAgICAgJ2xvZ3M6UHV0TG9nRXZlbnRzJyxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgICByZXNvdXJjZXM6IFtcbiAgICAgICAgICAgICAgYGFybjoke0F3cy5QQVJUSVRJT059OmxvZ3M6JHtBd3MuUkVHSU9OfToke0F3cy5BQ0NPVU5UX0lEfTpsb2ctZ3JvdXA6L2F3cy9sYW1iZGEvJHt0aGlzLmZ1bmN0aW9uTmFtZX1gLFxuICAgICAgICAgICAgICBgYXJuOiR7QXdzLlBBUlRJVElPTn06bG9nczoke0F3cy5SRUdJT059OiR7QXdzLkFDQ09VTlRfSUR9OmxvZy1ncm91cDovYXdzL2xhbWJkYS8ke3RoaXMuZnVuY3Rpb25OYW1lfToqYCxcbiAgICAgICAgICAgIF0sXG4gICAgICAgICAgfSksXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICk7XG5cbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkUmVzb3VyY2VTdXBwcmVzc2lvbnMoXG4gICAgICBjbG91ZHdhdGNoTG9nc1BvbGljeSxcbiAgICAgIFt7IGlkOiAnQXdzU29sdXRpb25zLUlBTTUnLCByZWFzb246ICdMYW1iZGEgcmVxdWlyZXMgQ2xvdWRXYXRjaCBsb2dzIHBlcm1pc3Npb25zIHdpdGggbG9nIGdyb3VwIG5hbWUgcGF0dGVybnMnIH1dLFxuICAgICk7XG5cbiAgICByb2xlLmF0dGFjaElubGluZVBvbGljeShjbG91ZHdhdGNoTG9nc1BvbGljeSk7XG5cbiAgICAvLyBQZXJtaXNzaW9ucyBmb3IgQkRBXG4gICAgY29uc3QgQmVkcm9ja0JEQUJQUG9saWN5ID0gbmV3IGlhbS5Qb2xpY3koXG4gICAgICBzY29wZSxcbiAgICAgIGAke2lkfUJlZHJvY2tCREFCUFBvbGljeWAsXG4gICAgICB7XG4gICAgICAgIHN0YXRlbWVudHM6IFtcbiAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICdiZWRyb2NrOkxpc3RCbHVlcHJpbnRzJyxcbiAgICAgICAgICAgICAgJ2JlZHJvY2s6RGVsZXRlQmx1ZXByaW50JyxcbiAgICAgICAgICAgICAgJ2JlZHJvY2s6SW52b2tlQmx1ZXByaW50JyxcbiAgICAgICAgICAgICAgJ2JlZHJvY2s6TGlzdEJsdWVwcmludEludm9jYXRpb25zJyxcbiAgICAgICAgICAgICAgJ2JlZHJvY2s6R2V0Qmx1ZXByaW50SW52b2NhdGlvbicsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIE5hZ1N1cHByZXNzaW9ucy5hZGRSZXNvdXJjZVN1cHByZXNzaW9ucyhcbiAgICAgIEJlZHJvY2tCREFCUFBvbGljeSxcbiAgICAgIFt7XG4gICAgICAgIGlkOiAnQXdzU29sdXRpb25zLUlBTTUnLFxuICAgICAgICByZWFzb246ICdCZWRyb2NrIEJsdWVwcmludCBvcGVyYXRpb25zIHJlcXVpcmUgYWNjZXNzIHRvIGFsbCBibHVlcHJpbnRzIGFzIHJlc291cmNlLWxldmVsIHBlcm1pc3Npb25zIGFyZSBub3Qgc3VwcG9ydGVkJyxcbiAgICAgIH1dLFxuICAgICAgdHJ1ZSxcbiAgICApO1xuXG4gICAgcm9sZS5hdHRhY2hJbmxpbmVQb2xpY3koQmVkcm9ja0JEQUJQUG9saWN5KTtcblxuICAgIGNvbnN0IGJlZHJvY2tCREFCUFZlcnNpb25Qb2xpY3kgPSBuZXcgaWFtLlBvbGljeShcbiAgICAgIHNjb3BlLFxuICAgICAgYCR7aWR9QmVkcm9ja0JEQUJQVmVyc2lvblBvbGljeWAsXG4gICAgICB7XG4gICAgICAgIHN0YXRlbWVudHM6IFtcbiAgICAgICAgICBuZXcgaWFtLlBvbGljeVN0YXRlbWVudCh7XG4gICAgICAgICAgICBlZmZlY3Q6IGlhbS5FZmZlY3QuQUxMT1csXG4gICAgICAgICAgICBhY3Rpb25zOiBbXG4gICAgICAgICAgICAgICdiZWRyb2NrOkNyZWF0ZUJsdWVwcmludCcsXG4gICAgICAgICAgICAgICdiZWRyb2NrOkNyZWF0ZUJsdWVwcmludFZlcnNpb24nLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIHJlc291cmNlczogWycqJ10sXG4gICAgICAgICAgfSksXG4gICAgICAgIF0sXG4gICAgICB9LFxuICAgICk7XG5cbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkUmVzb3VyY2VTdXBwcmVzc2lvbnMoXG4gICAgICBiZWRyb2NrQkRBQlBWZXJzaW9uUG9saWN5LFxuICAgICAgW3tcbiAgICAgICAgaWQ6ICdBd3NTb2x1dGlvbnMtSUFNNScsXG4gICAgICAgIHJlYXNvbjogJ0JlZHJvY2sgQmx1ZXByaW50IHZlcnNpb24gY3JlYXRpb24gb3BlcmF0aW9ucyByZXF1aXJlIGFjY2VzcyB0byBhbGwgYmx1ZXByaW50cyBhcyByZXNvdXJjZS1sZXZlbCBwZXJtaXNzaW9ucyBhcmUgbm90IHN1cHBvcnRlZCcsXG4gICAgICB9XSxcbiAgICAgIHRydWUsXG4gICAgKTtcblxuICAgIHJvbGUuYXR0YWNoSW5saW5lUG9saWN5KGJlZHJvY2tCREFCUFZlcnNpb25Qb2xpY3kpO1xuXG4gICAgLy8gR2l2ZSBMYW1iZGEgYWNjZXNzIHRvIHRoZSBidWNrZXRcbiAgICBpZiAodGhpcy5yb2xlKSB7XG4gICAgICBwcm9wcy5pbnB1dEJ1Y2tldC5ncmFudFJlYWQodGhpcy5yb2xlKTtcbiAgICB9XG5cbiAgICBOYWdTdXBwcmVzc2lvbnMuYWRkUmVzb3VyY2VTdXBwcmVzc2lvbnMoXG4gICAgICByb2xlLFxuICAgICAgW3tcbiAgICAgICAgaWQ6ICdBd3NTb2x1dGlvbnMtSUFNNScsXG4gICAgICAgIHJlYXNvbjogJ0xhbWJkYSBuZWVkcyByZWFkIGFjY2VzcyB0byBwcm9jZXNzIGZpbGVzIGZyb20gdGhlIGlucHV0IGJ1Y2tldCcsXG4gICAgICB9XSxcbiAgICAgIHRydWUsXG4gICAgKTtcbiAgfVxufVxuIl19
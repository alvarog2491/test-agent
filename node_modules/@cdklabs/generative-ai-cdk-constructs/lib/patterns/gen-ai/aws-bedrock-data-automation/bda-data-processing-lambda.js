"use strict";
/**
 *  Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.
 *
 *  Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance
 *  with the License. A copy of the License is located at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  or in the 'license' file accompanying this file. This file is distributed on an 'AS IS' BASIS, WITHOUT WARRANTIES
 *  OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions
 *  and limitations under the License.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.BdaDataProcessingLambda = void 0;
const path = require("path");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const cdk_nag_1 = require("cdk-nag");
/**
 * Lambda function that manages BDA data processing
 */
class BdaDataProcessingLambda extends aws_cdk_lib_1.aws_lambda.Function {
    constructor(scope, id, props) {
        const role = new aws_cdk_lib_1.aws_iam.Role(scope, `${id}createDataProcessing`, {
            assumedBy: new aws_cdk_lib_1.aws_iam.ServicePrincipal('lambda.amazonaws.com'),
        });
        super(scope, id, {
            runtime: aws_cdk_lib_1.aws_lambda.Runtime.PYTHON_3_13,
            handler: 'lambda.handler', // Adjust this based on your actual handler
            // eslint-disable-next-line @cdklabs/no-invalid-path
            code: aws_cdk_lib_1.aws_lambda.Code.fromAsset(path.join(__dirname, '../../../../lambda/aws-bedrock-data-automation/data_processing')),
            layers: props.lambdaLayers,
            description: 'BDA runtime for BDA data processing',
            environment: {
                INPUT_BUCKET: props.inputBucket.bucketName,
                OUTPUT_BUCKET: props.outputBucket.bucketName,
                OUTPUT_FILENAME: '',
                POWERTOOLS_SERVICE_NAME: 'BEDROCK_INVOKE',
            },
            memorySize: 1024,
            role: role,
            architecture: aws_cdk_lib_1.aws_lambda.Architecture.X86_64,
            timeout: aws_cdk_lib_1.Duration.minutes(15),
        });
        // Add basic permissions for CloudWatch logs
        const cloudwatchLogsPolicy = new aws_cdk_lib_1.aws_iam.Policy(scope, `${id}LambdaBasicExecPolicy`, {
            statements: [
                new aws_cdk_lib_1.aws_iam.PolicyStatement({
                    effect: aws_cdk_lib_1.aws_iam.Effect.ALLOW,
                    actions: [
                        'logs:CreateLogGroup',
                        'logs:CreateLogStream',
                        'logs:PutLogEvents',
                    ],
                    resources: [
                        `arn:${aws_cdk_lib_1.Aws.PARTITION}:logs:${aws_cdk_lib_1.Aws.REGION}:${aws_cdk_lib_1.Aws.ACCOUNT_ID}:log-group:/aws/lambda/${this.functionName}`,
                        `arn:${aws_cdk_lib_1.Aws.PARTITION}:logs:${aws_cdk_lib_1.Aws.REGION}:${aws_cdk_lib_1.Aws.ACCOUNT_ID}:log-group:/aws/lambda/${this.functionName}:*`,
                    ],
                }),
            ],
        });
        cdk_nag_1.NagSuppressions.addResourceSuppressions(cloudwatchLogsPolicy, [{ id: 'AwsSolutions-IAM5', reason: 'Lambda requires CloudWatch logs permissions with log group name patterns' }]);
        role.attachInlinePolicy(cloudwatchLogsPolicy);
        // Permissions for BDA
        const bedrockBDAPolicy = new aws_cdk_lib_1.aws_iam.Policy(scope, `${id}BedrockBDAProcessingPolicy`, {
            statements: [
                new aws_cdk_lib_1.aws_iam.PolicyStatement({
                    effect: aws_cdk_lib_1.aws_iam.Effect.ALLOW,
                    actions: [
                        'bedrock:InvokeDataAutomationAsync',
                    ],
                    resources: ['*'],
                }),
            ],
        });
        cdk_nag_1.NagSuppressions.addResourceSuppressions(bedrockBDAPolicy, [{
                id: 'AwsSolutions-IAM5',
                reason: 'Invocation Lambda needs access for data processing operations',
            }], true);
        role.attachInlinePolicy(bedrockBDAPolicy);
        // Give Lambda access to the buckets
        if (this.role) {
            props.inputBucket.grantReadWrite(this.role);
            props.outputBucket.grantReadWrite(this.role);
        }
        cdk_nag_1.NagSuppressions.addResourceSuppressions(role, [{
                id: 'AwsSolutions-IAM5',
                reason: 'Lambda needs read access to process files from the input bucket',
            }], true);
    }
}
exports.BdaDataProcessingLambda = BdaDataProcessingLambda;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmRhLWRhdGEtcHJvY2Vzc2luZy1sYW1iZGEuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvcGF0dGVybnMvZ2VuLWFpL2F3cy1iZWRyb2NrLWRhdGEtYXV0b21hdGlvbi9iZGEtZGF0YS1wcm9jZXNzaW5nLWxhbWJkYS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7O0dBV0c7OztBQUVILDZCQUE2QjtBQUM3Qiw2Q0FBa0Y7QUFFbEYscUNBQTBDO0FBeUIxQzs7R0FFRztBQUNILE1BQWEsdUJBQXdCLFNBQVEsd0JBQU0sQ0FBQyxRQUFRO0lBQzFELFlBQVksS0FBZ0IsRUFBRSxFQUFVLEVBQUUsS0FBbUM7UUFDM0UsTUFBTSxJQUFJLEdBQUcsSUFBSSxxQkFBRyxDQUFDLElBQUksQ0FDdkIsS0FBSyxFQUNMLEdBQUcsRUFBRSxzQkFBc0IsRUFDM0I7WUFDRSxTQUFTLEVBQUUsSUFBSSxxQkFBRyxDQUFDLGdCQUFnQixDQUFDLHNCQUFzQixDQUFDO1NBQzVELENBQ0YsQ0FBQztRQUVGLEtBQUssQ0FBQyxLQUFLLEVBQUUsRUFBRSxFQUFFO1lBQ2YsT0FBTyxFQUFFLHdCQUFNLENBQUMsT0FBTyxDQUFDLFdBQVc7WUFDbkMsT0FBTyxFQUFFLGdCQUFnQixFQUFFLDJDQUEyQztZQUN0RSxvREFBb0Q7WUFDcEQsSUFBSSxFQUFFLHdCQUFNLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxnRUFBZ0UsQ0FBQyxDQUFDO1lBQ25ILE1BQU0sRUFBRSxLQUFLLENBQUMsWUFBWTtZQUMxQixXQUFXLEVBQUUscUNBQXFDO1lBQ2xELFdBQVcsRUFBRTtnQkFDWCxZQUFZLEVBQUUsS0FBSyxDQUFDLFdBQVcsQ0FBQyxVQUFVO2dCQUMxQyxhQUFhLEVBQUUsS0FBSyxDQUFDLFlBQVksQ0FBQyxVQUFVO2dCQUM1QyxlQUFlLEVBQUUsRUFBRTtnQkFDbkIsdUJBQXVCLEVBQUUsZ0JBQWdCO2FBQzFDO1lBQ0QsVUFBVSxFQUFFLElBQUk7WUFDaEIsSUFBSSxFQUFFLElBQUk7WUFDVixZQUFZLEVBQUUsd0JBQU0sQ0FBQyxZQUFZLENBQUMsTUFBTTtZQUN4QyxPQUFPLEVBQUUsc0JBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1NBQzlCLENBQUMsQ0FBQztRQUVILDRDQUE0QztRQUM1QyxNQUFNLG9CQUFvQixHQUFHLElBQUkscUJBQUcsQ0FBQyxNQUFNLENBQ3pDLEtBQUssRUFDTCxHQUFHLEVBQUUsdUJBQXVCLEVBQzVCO1lBQ0UsVUFBVSxFQUFFO2dCQUNWLElBQUkscUJBQUcsQ0FBQyxlQUFlLENBQUM7b0JBQ3RCLE1BQU0sRUFBRSxxQkFBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO29CQUN4QixPQUFPLEVBQUU7d0JBQ1AscUJBQXFCO3dCQUNyQixzQkFBc0I7d0JBQ3RCLG1CQUFtQjtxQkFDcEI7b0JBQ0QsU0FBUyxFQUFFO3dCQUNULE9BQU8saUJBQUcsQ0FBQyxTQUFTLFNBQVMsaUJBQUcsQ0FBQyxNQUFNLElBQUksaUJBQUcsQ0FBQyxVQUFVLDBCQUEwQixJQUFJLENBQUMsWUFBWSxFQUFFO3dCQUN0RyxPQUFPLGlCQUFHLENBQUMsU0FBUyxTQUFTLGlCQUFHLENBQUMsTUFBTSxJQUFJLGlCQUFHLENBQUMsVUFBVSwwQkFBMEIsSUFBSSxDQUFDLFlBQVksSUFBSTtxQkFDekc7aUJBQ0YsQ0FBQzthQUNIO1NBQ0YsQ0FDRixDQUFDO1FBRUYseUJBQWUsQ0FBQyx1QkFBdUIsQ0FDckMsb0JBQW9CLEVBQ3BCLENBQUMsRUFBRSxFQUFFLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxFQUFFLDBFQUEwRSxFQUFFLENBQUMsQ0FDbEgsQ0FBQztRQUVGLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxDQUFDO1FBRTlDLHNCQUFzQjtRQUN0QixNQUFNLGdCQUFnQixHQUFHLElBQUkscUJBQUcsQ0FBQyxNQUFNLENBQ3JDLEtBQUssRUFDTCxHQUFHLEVBQUUsNEJBQTRCLEVBQ2pDO1lBQ0UsVUFBVSxFQUFFO2dCQUNWLElBQUkscUJBQUcsQ0FBQyxlQUFlLENBQUM7b0JBQ3RCLE1BQU0sRUFBRSxxQkFBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLO29CQUN4QixPQUFPLEVBQUU7d0JBQ1AsbUNBQW1DO3FCQUNwQztvQkFDRCxTQUFTLEVBQUUsQ0FBQyxHQUFHLENBQUM7aUJBQ2pCLENBQUM7YUFDSDtTQUNGLENBQ0YsQ0FBQztRQUVGLHlCQUFlLENBQUMsdUJBQXVCLENBQ3JDLGdCQUFnQixFQUNoQixDQUFDO2dCQUNDLEVBQUUsRUFBRSxtQkFBbUI7Z0JBQ3ZCLE1BQU0sRUFBRSwrREFBK0Q7YUFDeEUsQ0FBQyxFQUNGLElBQUksQ0FDTCxDQUFDO1FBRUYsSUFBSSxDQUFDLGtCQUFrQixDQUFDLGdCQUFnQixDQUFDLENBQUM7UUFFMUMsb0NBQW9DO1FBQ3BDLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ2QsS0FBSyxDQUFDLFdBQVcsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzVDLEtBQUssQ0FBQyxZQUFZLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUMvQyxDQUFDO1FBRUQseUJBQWUsQ0FBQyx1QkFBdUIsQ0FDckMsSUFBSSxFQUNKLENBQUM7Z0JBQ0MsRUFBRSxFQUFFLG1CQUFtQjtnQkFDdkIsTUFBTSxFQUFFLGlFQUFpRTthQUMxRSxDQUFDLEVBQ0YsSUFBSSxDQUNMLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFyR0QsMERBcUdDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiAgQ29weXJpZ2h0IEFtYXpvbi5jb20sIEluYy4gb3IgaXRzIGFmZmlsaWF0ZXMuIEFsbCBSaWdodHMgUmVzZXJ2ZWQuXG4gKlxuICogIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIikuIFlvdSBtYXkgbm90IHVzZSB0aGlzIGZpbGUgZXhjZXB0IGluIGNvbXBsaWFuY2VcbiAqICB3aXRoIHRoZSBMaWNlbnNlLiBBIGNvcHkgb2YgdGhlIExpY2Vuc2UgaXMgbG9jYXRlZCBhdFxuICpcbiAqICAgICAgaHR0cDovL3d3dy5hcGFjaGUub3JnL2xpY2Vuc2VzL0xJQ0VOU0UtMi4wXG4gKlxuICogIG9yIGluIHRoZSAnbGljZW5zZScgZmlsZSBhY2NvbXBhbnlpbmcgdGhpcyBmaWxlLiBUaGlzIGZpbGUgaXMgZGlzdHJpYnV0ZWQgb24gYW4gJ0FTIElTJyBCQVNJUywgV0lUSE9VVCBXQVJSQU5USUVTXG4gKiAgT1IgQ09ORElUSU9OUyBPRiBBTlkgS0lORCwgZXhwcmVzcyBvciBpbXBsaWVkLiBTZWUgdGhlIExpY2Vuc2UgZm9yIHRoZSBzcGVjaWZpYyBsYW5ndWFnZSBnb3Zlcm5pbmcgcGVybWlzc2lvbnNcbiAqICBhbmQgbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGF3c19pYW0gYXMgaWFtLCBhd3NfbGFtYmRhIGFzIGxhbWJkYSwgRHVyYXRpb24sIEF3cyB9IGZyb20gJ2F3cy1jZGstbGliJztcbmltcG9ydCAqIGFzIHMzIGZyb20gJ2F3cy1jZGstbGliL2F3cy1zMyc7XG5pbXBvcnQgeyBOYWdTdXBwcmVzc2lvbnMgfSBmcm9tICdjZGstbmFnJztcbmltcG9ydCB7IENvbnN0cnVjdCB9IGZyb20gJ2NvbnN0cnVjdHMnO1xuXG4vKipcbiAqIFByb3BlcnRpZXMgZm9yIGNyZWF0aW5nIGEgQmRhQmx1ZXByaW50TGFtYmRhXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQmRhRGF0YVByb2Nlc3NpbmdMYW1iZGFQcm9wcyB7XG4gIC8qKlxuICAgKiBUaGUgUzMgYnVja2V0XG4gICAqIGZvciBpbnB1dCBkYXRhIHVzZWQgYnkgdGhlIEJlZHJvY2sgRGF0YSBBdXRvbWF0aW9uIHByb2Nlc3MuXG4gICAqIElmIG5vdCBwcm92aWRlZCwgYSBuZXcgYnVja2V0IHdpbGwgYmUgY3JlYXRlZC5cbiAgICovXG4gIHJlYWRvbmx5IGlucHV0QnVja2V0OiBzMy5JQnVja2V0O1xuICAvKipcbiAgICogVGhlIFMzIGJ1Y2tldFxuICAgKiBmb3IgaW5wdXQgZGF0YSB1c2VkIGJ5IHRoZSBCZWRyb2NrIERhdGEgQXV0b21hdGlvbiBwcm9jZXNzLlxuICAgKiBJZiBub3QgcHJvdmlkZWQsIGEgbmV3IGJ1Y2tldCB3aWxsIGJlIGNyZWF0ZWQuXG4gICAqL1xuICByZWFkb25seSBvdXRwdXRCdWNrZXQ6IHMzLklCdWNrZXQ7XG4gIC8qKlxuICAgKiBUaGUgbGF5ZXJzIHRvIGFwcGx5IHRvIHRoaXMgbGFtYmRhIGZ1bmN0aW9uLlxuICAgKi9cbiAgcmVhZG9ubHkgbGFtYmRhTGF5ZXJzOiBsYW1iZGEuSUxheWVyVmVyc2lvbltdO1xufVxuXG4vKipcbiAqIExhbWJkYSBmdW5jdGlvbiB0aGF0IG1hbmFnZXMgQkRBIGRhdGEgcHJvY2Vzc2luZ1xuICovXG5leHBvcnQgY2xhc3MgQmRhRGF0YVByb2Nlc3NpbmdMYW1iZGEgZXh0ZW5kcyBsYW1iZGEuRnVuY3Rpb24ge1xuICBjb25zdHJ1Y3RvcihzY29wZTogQ29uc3RydWN0LCBpZDogc3RyaW5nLCBwcm9wczogQmRhRGF0YVByb2Nlc3NpbmdMYW1iZGFQcm9wcykge1xuICAgIGNvbnN0IHJvbGUgPSBuZXcgaWFtLlJvbGUoXG4gICAgICBzY29wZSxcbiAgICAgIGAke2lkfWNyZWF0ZURhdGFQcm9jZXNzaW5nYCxcbiAgICAgIHtcbiAgICAgICAgYXNzdW1lZEJ5OiBuZXcgaWFtLlNlcnZpY2VQcmluY2lwYWwoJ2xhbWJkYS5hbWF6b25hd3MuY29tJyksXG4gICAgICB9LFxuICAgICk7XG5cbiAgICBzdXBlcihzY29wZSwgaWQsIHtcbiAgICAgIHJ1bnRpbWU6IGxhbWJkYS5SdW50aW1lLlBZVEhPTl8zXzEzLFxuICAgICAgaGFuZGxlcjogJ2xhbWJkYS5oYW5kbGVyJywgLy8gQWRqdXN0IHRoaXMgYmFzZWQgb24geW91ciBhY3R1YWwgaGFuZGxlclxuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEBjZGtsYWJzL25vLWludmFsaWQtcGF0aFxuICAgICAgY29kZTogbGFtYmRhLkNvZGUuZnJvbUFzc2V0KHBhdGguam9pbihfX2Rpcm5hbWUsICcuLi8uLi8uLi8uLi9sYW1iZGEvYXdzLWJlZHJvY2stZGF0YS1hdXRvbWF0aW9uL2RhdGFfcHJvY2Vzc2luZycpKSxcbiAgICAgIGxheWVyczogcHJvcHMubGFtYmRhTGF5ZXJzLFxuICAgICAgZGVzY3JpcHRpb246ICdCREEgcnVudGltZSBmb3IgQkRBIGRhdGEgcHJvY2Vzc2luZycsXG4gICAgICBlbnZpcm9ubWVudDoge1xuICAgICAgICBJTlBVVF9CVUNLRVQ6IHByb3BzLmlucHV0QnVja2V0LmJ1Y2tldE5hbWUsXG4gICAgICAgIE9VVFBVVF9CVUNLRVQ6IHByb3BzLm91dHB1dEJ1Y2tldC5idWNrZXROYW1lLFxuICAgICAgICBPVVRQVVRfRklMRU5BTUU6ICcnLFxuICAgICAgICBQT1dFUlRPT0xTX1NFUlZJQ0VfTkFNRTogJ0JFRFJPQ0tfSU5WT0tFJyxcbiAgICAgIH0sXG4gICAgICBtZW1vcnlTaXplOiAxMDI0LFxuICAgICAgcm9sZTogcm9sZSxcbiAgICAgIGFyY2hpdGVjdHVyZTogbGFtYmRhLkFyY2hpdGVjdHVyZS5YODZfNjQsXG4gICAgICB0aW1lb3V0OiBEdXJhdGlvbi5taW51dGVzKDE1KSxcbiAgICB9KTtcblxuICAgIC8vIEFkZCBiYXNpYyBwZXJtaXNzaW9ucyBmb3IgQ2xvdWRXYXRjaCBsb2dzXG4gICAgY29uc3QgY2xvdWR3YXRjaExvZ3NQb2xpY3kgPSBuZXcgaWFtLlBvbGljeShcbiAgICAgIHNjb3BlLFxuICAgICAgYCR7aWR9TGFtYmRhQmFzaWNFeGVjUG9saWN5YCxcbiAgICAgIHtcbiAgICAgICAgc3RhdGVtZW50czogW1xuICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgJ2xvZ3M6Q3JlYXRlTG9nR3JvdXAnLFxuICAgICAgICAgICAgICAnbG9nczpDcmVhdGVMb2dTdHJlYW0nLFxuICAgICAgICAgICAgICAnbG9nczpQdXRMb2dFdmVudHMnLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICAgIHJlc291cmNlczogW1xuICAgICAgICAgICAgICBgYXJuOiR7QXdzLlBBUlRJVElPTn06bG9nczoke0F3cy5SRUdJT059OiR7QXdzLkFDQ09VTlRfSUR9OmxvZy1ncm91cDovYXdzL2xhbWJkYS8ke3RoaXMuZnVuY3Rpb25OYW1lfWAsXG4gICAgICAgICAgICAgIGBhcm46JHtBd3MuUEFSVElUSU9OfTpsb2dzOiR7QXdzLlJFR0lPTn06JHtBd3MuQUNDT1VOVF9JRH06bG9nLWdyb3VwOi9hd3MvbGFtYmRhLyR7dGhpcy5mdW5jdGlvbk5hbWV9OipgLFxuICAgICAgICAgICAgXSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIE5hZ1N1cHByZXNzaW9ucy5hZGRSZXNvdXJjZVN1cHByZXNzaW9ucyhcbiAgICAgIGNsb3Vkd2F0Y2hMb2dzUG9saWN5LFxuICAgICAgW3sgaWQ6ICdBd3NTb2x1dGlvbnMtSUFNNScsIHJlYXNvbjogJ0xhbWJkYSByZXF1aXJlcyBDbG91ZFdhdGNoIGxvZ3MgcGVybWlzc2lvbnMgd2l0aCBsb2cgZ3JvdXAgbmFtZSBwYXR0ZXJucycgfV0sXG4gICAgKTtcblxuICAgIHJvbGUuYXR0YWNoSW5saW5lUG9saWN5KGNsb3Vkd2F0Y2hMb2dzUG9saWN5KTtcblxuICAgIC8vIFBlcm1pc3Npb25zIGZvciBCREFcbiAgICBjb25zdCBiZWRyb2NrQkRBUG9saWN5ID0gbmV3IGlhbS5Qb2xpY3koXG4gICAgICBzY29wZSxcbiAgICAgIGAke2lkfUJlZHJvY2tCREFQcm9jZXNzaW5nUG9saWN5YCxcbiAgICAgIHtcbiAgICAgICAgc3RhdGVtZW50czogW1xuICAgICAgICAgIG5ldyBpYW0uUG9saWN5U3RhdGVtZW50KHtcbiAgICAgICAgICAgIGVmZmVjdDogaWFtLkVmZmVjdC5BTExPVyxcbiAgICAgICAgICAgIGFjdGlvbnM6IFtcbiAgICAgICAgICAgICAgJ2JlZHJvY2s6SW52b2tlRGF0YUF1dG9tYXRpb25Bc3luYycsXG4gICAgICAgICAgICBdLFxuICAgICAgICAgICAgcmVzb3VyY2VzOiBbJyonXSxcbiAgICAgICAgICB9KSxcbiAgICAgICAgXSxcbiAgICAgIH0sXG4gICAgKTtcblxuICAgIE5hZ1N1cHByZXNzaW9ucy5hZGRSZXNvdXJjZVN1cHByZXNzaW9ucyhcbiAgICAgIGJlZHJvY2tCREFQb2xpY3ksXG4gICAgICBbe1xuICAgICAgICBpZDogJ0F3c1NvbHV0aW9ucy1JQU01JyxcbiAgICAgICAgcmVhc29uOiAnSW52b2NhdGlvbiBMYW1iZGEgbmVlZHMgYWNjZXNzIGZvciBkYXRhIHByb2Nlc3Npbmcgb3BlcmF0aW9ucycsXG4gICAgICB9XSxcbiAgICAgIHRydWUsXG4gICAgKTtcblxuICAgIHJvbGUuYXR0YWNoSW5saW5lUG9saWN5KGJlZHJvY2tCREFQb2xpY3kpO1xuXG4gICAgLy8gR2l2ZSBMYW1iZGEgYWNjZXNzIHRvIHRoZSBidWNrZXRzXG4gICAgaWYgKHRoaXMucm9sZSkge1xuICAgICAgcHJvcHMuaW5wdXRCdWNrZXQuZ3JhbnRSZWFkV3JpdGUodGhpcy5yb2xlKTtcbiAgICAgIHByb3BzLm91dHB1dEJ1Y2tldC5ncmFudFJlYWRXcml0ZSh0aGlzLnJvbGUpO1xuICAgIH1cblxuICAgIE5hZ1N1cHByZXNzaW9ucy5hZGRSZXNvdXJjZVN1cHByZXNzaW9ucyhcbiAgICAgIHJvbGUsXG4gICAgICBbe1xuICAgICAgICBpZDogJ0F3c1NvbHV0aW9ucy1JQU01JyxcbiAgICAgICAgcmVhc29uOiAnTGFtYmRhIG5lZWRzIHJlYWQgYWNjZXNzIHRvIHByb2Nlc3MgZmlsZXMgZnJvbSB0aGUgaW5wdXQgYnVja2V0JyxcbiAgICAgIH1dLFxuICAgICAgdHJ1ZSxcbiAgICApO1xuICB9XG59XG4iXX0=
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.RuleFilterSet = void 0;
/**
 * Caches the list of rule filters that are specified in the include and exclude options in awslint.json.
 */
class RuleFilterSet {
    /**
     * Rule filter format is code:scope e.g. 'docs-public-apis:aws-cdk-lib.TagType'.
     * Wildcards can be used in the following ways:
     *
     * 1. Match any code e.g.: '*:aws-cdk-lib.TagType'
     * 2. Match any scope e.g.: 'docs-public-apis:*'
     * 3. Match any scope prefix e.g.: 'docs-public-apis:aws-cdk-lib.Tag*'
     */
    codesToScopes = new Map(); // code -> list of scopes
    codesToScopePrefixes = new Map(); // code -> list of scope prefixes (wildcards)
    scopes = new Set(); // list of scopes with a wilcard code
    scopePrefixes = new Set(); // list of scope prefixes with a wildcard code
    _isEmpty = false;
    constructor(ruleFilterList) {
        if (!ruleFilterList || ruleFilterList.length == 0) {
            this._isEmpty = true;
        }
        for (let filter of ruleFilterList) {
            if (filter.indexOf(':') === -1) {
                filter += ':*'; // add "*" scope filter if there isn't one
            }
            const [code, scope] = filter.split(':');
            if (this.hasWildcard(code)) {
                if (code.length > 1) {
                    throw new Error(`Error parsing rule filter ${filter}: rule code can only be a single wildcard, or a complete string.`);
                }
                else {
                    if (this.hasWildcard(scope)) {
                        this.scopePrefixes.add(scope);
                    }
                    else {
                        this.scopes.add(scope);
                    }
                }
            }
            else {
                if (this.hasWildcard(scope)) {
                    this.addToMap(this.codesToScopePrefixes, code, scope);
                }
                else {
                    this.addToMap(this.codesToScopes, code, scope);
                }
            }
        }
    }
    matches(code, scope) {
        // Check complete filter
        const completeScopes = this.codesToScopes.get(code);
        if (completeScopes && completeScopes.has(scope)) {
            return true;
        }
        // Check if scope matches a prefix e.g. 'docs-public-apis:aws-cdk-lib.Tag*'
        const scopePrefixesForCode = this.codesToScopePrefixes.get(code);
        if (scopePrefixesForCode) {
            if (this.containsPrefix(scopePrefixesForCode, scope)) {
                return true;
            }
        }
        // Check if scope has a wildcard code e.g. '*:aws-cdk-lib.TagType'
        if (this.scopes.has(scope)) {
            return true;
        }
        // Check if scope matches a prefix with a wildcard code e.g. '*:aws-cdk-lib.TagType*'
        if (this.containsPrefix(this.scopePrefixes, scope)) {
            return true;
        }
        return false;
    }
    containsPrefix(prefixes, value) {
        for (const prefix of prefixes) {
            const prefixStr = prefix.slice(0, -1); // Strip the asterisk
            if (value.startsWith(prefixStr)) {
                return true;
            }
        }
        return false;
    }
    isEmpty() {
        return this._isEmpty;
    }
    addToMap(map, code, scope) {
        if (!map.has(code)) {
            map.set(code, new Set());
        }
        map.get(code)?.add(scope);
    }
    hasWildcard(value) {
        return value.indexOf('*') !== -1;
    }
}
exports.RuleFilterSet = RuleFilterSet;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVsZS1zcGVjcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJ1bGUtc3BlY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUE7O0dBRUc7QUFDSCxNQUFhLGFBQWE7SUFDeEI7Ozs7Ozs7T0FPRztJQUVLLGFBQWEsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQyxDQUFDLHlCQUF5QjtJQUV6RSxvQkFBb0IsR0FBRyxJQUFJLEdBQUcsRUFBdUIsQ0FBQyxDQUFDLDZDQUE2QztJQUVwRyxNQUFNLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQyxDQUFDLHFDQUFxQztJQUVqRSxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQVUsQ0FBQyxDQUFDLDhDQUE4QztJQUVqRixRQUFRLEdBQVksS0FBSyxDQUFDO0lBRWxDLFlBQVksY0FBd0I7UUFDbEMsSUFBSSxDQUFDLGNBQWMsSUFBSSxjQUFjLENBQUMsTUFBTSxJQUFJLENBQUMsRUFBRSxDQUFDO1lBQ2xELElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDO1FBQ3ZCLENBQUM7UUFFRCxLQUFLLElBQUksTUFBTSxJQUFJLGNBQWMsRUFBRSxDQUFDO1lBQ2xDLElBQUksTUFBTSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUMvQixNQUFNLElBQUksSUFBSSxDQUFDLENBQUMsMENBQTBDO1lBQzVELENBQUM7WUFFRCxNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFFeEMsSUFBSSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7Z0JBQzNCLElBQUksSUFBSSxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztvQkFDcEIsTUFBTSxJQUFJLEtBQUssQ0FBQyw2QkFBNkIsTUFBTSxrRUFBa0UsQ0FBQyxDQUFDO2dCQUN6SCxDQUFDO3FCQUFNLENB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QUFDO0lBQ25DLENBQUM7Q0FDRjtBQTFHRCxzQ0EwR0MiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENhY2hlcyB0aGUgbGlzdCBvZiBydWxlIGZpbHRlcnMgdGhhdCBhcmUgc3BlY2lmaWVkIGluIHRoZSBpbmNsdWRlIGFuZCBleGNsdWRlIG9wdGlvbnMgaW4gYXdzbGludC5qc29uLlxuICovXG5leHBvcnQgY2xhc3MgUnVsZUZpbHRlclNldCB7XG4gIC8qKlxuICAgKiBSdWxlIGZpbHRlciBmb3JtYXQgaXMgY29kZTpzY29wZSBlLmcuICdkb2NzLXB1YmxpYy1hcGlzOmF3cy1jZGstbGliLlRhZ1R5cGUnLlxuICAgKiBXaWxkY2FyZHMgY2FuIGJlIHVzZWQgaW4gdGhlIGZvbGxvd2luZyB3YXlzOlxuICAgKlxuICAgKiAxLiBNYXRjaCBhbnkgY29kZSBlLmcuOiAnKjphd3MtY2RrLWxpYi5UYWdUeXBlJ1xuICAgKiAyLiBNYXRjaCBhbnkgc2NvcGUgZS5nLjogJ2RvY3MtcHVibGljLWFwaXM6KidcbiAgICogMy4gTWF0Y2ggYW55IHNjb3BlIHByZWZpeCBlLmcuOiAnZG9jcy1wdWJsaWMtYXBpczphd3MtY2RrLWxpYi5UYWcqJ1xuICAgKi9cblxuICBwcml2YXRlIGNvZGVzVG9TY29wZXMgPSBuZXcgTWFwPHN0cmluZywgU2V0PHN0cmluZz4+KCk7IC8vIGNvZGUgLT4gbGlzdCBvZiBzY29wZXNcblxuICBwcml2YXRlIGNvZGVzVG9TY29wZVByZWZpeGVzID0gbmV3IE1hcDxzdHJpbmcsIFNldDxzdHJpbmc+PigpOyAvLyBjb2RlIC0+IGxpc3Qgb2Ygc2NvcGUgcHJlZml4ZXMgKHdpbGRjYXJkcylcblxuICBwcml2YXRlIHNjb3BlcyA9IG5ldyBTZXQ8c3RyaW5nPigpOyAvLyBsaXN0IG9mIHNjb3BlcyB3aXRoIGEgd2lsY2FyZCBjb2RlXG5cbiAgcHJpdmF0ZSBzY29wZVByZWZpeGVzID0gbmV3IFNldDxzdHJpbmc+KCk7IC8vIGxpc3Qgb2Ygc2NvcGUgcHJlZml4ZXMgd2l0aCBhIHdpbGRjYXJkIGNvZGVcblxuICBwcml2YXRlIF9pc0VtcHR5OiBib29sZWFuID0gZmFsc2U7XG5cbiAgY29uc3RydWN0b3IocnVsZUZpbHRlckxpc3Q6IHN0cmluZ1tdKSB7XG4gICAgaWYgKCFydWxlRmlsdGVyTGlzdCB8fCBydWxlRmlsdGVyTGlzdC5sZW5ndGggPT0gMCkge1xuICAgICAgdGhpcy5faXNFbXB0eSA9IHRydWU7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgZmlsdGVyIG9mIHJ1bGVGaWx0ZXJMaXN0KSB7XG4gICAgICBpZiAoZmlsdGVyLmluZGV4T2YoJzonKSA9PT0gLTEpIHtcbiAgICAgICAgZmlsdGVyICs9ICc6Kic7IC8vIGFkZCBcIipcIiBzY29wZSBmaWx0ZXIgaWYgdGhlcmUgaXNuJ3Qgb25lXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IFtjb2RlLCBzY29wZV0gPSBmaWx0ZXIuc3BsaXQoJzonKTtcblxuICAgICAgaWYgKHRoaXMuaGFzV2lsZGNhcmQoY29kZSkpIHtcbiAgICAgICAgaWYgKGNvZGUubGVuZ3RoID4gMSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXJyb3IgcGFyc2luZyBydWxlIGZpbHRlciAke2ZpbHRlcn06IHJ1bGUgY29kZSBjYW4gb25seSBiZSBhIHNpbmdsZSB3aWxkY2FyZCwgb3IgYSBjb21wbGV0ZSBzdHJpbmcuYCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgaWYgKHRoaXMuaGFzV2lsZGNhcmQoc2NvcGUpKSB7XG4gICAgICAgICAgICB0aGlzLnNjb3BlUHJlZml4ZXMuYWRkKHNjb3BlKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5zY29wZXMuYWRkKHNjb3BlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGlmICh0aGlzLmhhc1dpbGRjYXJkKHNjb3BlKSkge1xuICAgICAgICAgIHRoaXMuYWRkVG9NYXAodGhpcy5jb2Rlc1RvU2NvcGVQcmVmaXhlcywgY29kZSwgc2NvcGUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuYWRkVG9NYXAodGhpcy5jb2Rlc1RvU2NvcGVzLCBjb2RlLCBzY29wZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbWF0Y2hlcyhjb2RlOiBzdHJpbmcsIHNjb3BlOiBzdHJpbmcpIHtcbiAgICAvLyBDaGVjayBjb21wbGV0ZSBmaWx0ZXJcbiAgICBjb25zdCBjb21wbGV0ZVNjb3BlcyA9IHRoaXMuY29kZXNUb1Njb3Blcy5nZXQoY29kZSk7XG4gICAgaWYgKGNvbXBsZXRlU2NvcGVzICYmIGNvbXBsZXRlU2NvcGVzLmhhcyhzY29wZSkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHNjb3BlIG1hdGNoZXMgYSBwcmVmaXggZS5nLiAnZG9jcy1wdWJsaWMtYXBpczphd3MtY2RrLWxpYi5UYWcqJ1xuICAgIGNvbnN0IHNjb3BlUHJlZml4ZXNGb3JDb2RlID0gdGhpcy5jb2Rlc1RvU2NvcGVQcmVmaXhlcy5nZXQoY29kZSk7XG4gICAgaWYgKHNjb3BlUHJlZml4ZXNGb3JDb2RlKSB7XG4gICAgICBpZiAodGhpcy5jb250YWluc1ByZWZpeChzY29wZVByZWZpeGVzRm9yQ29kZSwgc2NvcGUpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHNjb3BlIGhhcyBhIHdpbGRjYXJkIGNvZGUgZS5nLiAnKjphd3MtY2RrLWxpYi5UYWdUeXBlJ1xuICAgIGlmICh0aGlzLnNjb3Blcy5oYXMoc2NvcGUpKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBzY29wZSBtYXRjaGVzIGEgcHJlZml4IHdpdGggYSB3aWxkY2FyZCBjb2RlIGUuZy4gJyo6YXdzLWNkay1saWIuVGFnVHlwZSonXG4gICAgaWYgKHRoaXMuY29udGFpbnNQcmVmaXgodGhpcy5zY29wZVByZWZpeGVzLCBzY29wZSkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgY29udGFpbnNQcmVmaXgocHJlZml4ZXM6IFNldDxzdHJpbmc+LCB2YWx1ZTogc3RyaW5nKSB7XG4gICAgZm9yIChjb25zdCBwcmVmaXggb2YgcHJlZml4ZXMpIHtcbiAgICAgIGNvbnN0IHByZWZpeFN0ciA9IHByZWZpeC5zbGljZSgwLCAtMSk7IC8vIFN0cmlwIHRoZSBhc3Rlcmlza1xuICAgICAgaWYgKHZhbHVlLnN0YXJ0c1dpdGgocHJlZml4U3RyKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwdWJsaWMgaXNFbXB0eSgpIHtcbiAgICByZXR1cm4gdGhpcy5faXNFbXB0eTtcbiAgfVxuXG4gIHByaXZhdGUgYWRkVG9NYXAobWFwOiBNYXA8c3RyaW5nLCBTZXQ8c3RyaW5nPj4sIGNvZGU6IHN0cmluZywgc2NvcGU6IHN0cmluZykge1xuICAgIGlmICghbWFwLmhhcyhjb2RlKSkge1xuICAgICAgbWFwLnNldChjb2RlLCBuZXcgU2V0PHN0cmluZz4oKSk7XG4gICAgfVxuXG4gICAgbWFwLmdldChjb2RlKT8uYWRkKHNjb3BlKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzV2lsZGNhcmQodmFsdWU6IHN0cmluZykge1xuICAgIHJldHVybiB2YWx1ZS5pbmRleE9mKCcqJykgIT09IC0xO1xuICB9XG59XG4iXX0=
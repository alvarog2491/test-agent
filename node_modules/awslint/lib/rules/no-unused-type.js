"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.noUnusedTypeLinter = void 0;
const linter_1 = require("../linter");
exports.noUnusedTypeLinter = new linter_1.Linter(assm => {
    // Only care about AWS Construct Library here...
    if (!assm.name.startsWith('@aws-cdk/aws-')) {
        return [];
    }
    const usedTypes = _collectUsedTypes(assm);
    const generatedFqnPrefix = `${assm.name}.Cfn`;
    return assm.types.filter(type => !type.isClassType())
        .filter(type => !type.fqn.startsWith(generatedFqnPrefix))
        .map(inspectedType => ({ inspectedType, usedTypes }));
});
exports.noUnusedTypeLinter.add({
    code: 'no-unused-type',
    message: 'type or enum is not used by exported classes',
    eval: evaluation => {
        evaluation.assert(evaluation.ctx.usedTypes.has(evaluation.ctx.inspectedType.fqn), evaluation.ctx.inspectedType.fqn, _formatLocation(evaluation.ctx.inspectedType.locationInModule));
    },
});
function _collectUsedTypes(assm) {
    const result = new Set();
    assm.types.filter(type => type.isClassType())
        .forEach(_visitType);
    return result;
    function _visitType(type) {
        if (typeof type === 'string') {
            const resolvedType = assm.tryFindType(type);
            if (!resolvedType) {
                return;
            }
            type = resolvedType;
        }
        if (result.has(type.fqn)) {
            return;
        }
        result.add(type.fqn);
        // Nothing else to do for enums
        if (type.isEnumType()) {
            return;
        }
        if (type.isClassType()) {
            if (type.base) {
                _visitType(type.base);
            }
            if (type.initializer) {
                for (const param of type.initializer.parameters) {
                    _visitTypeRef(param.type);
                }
            }
        }
        if (type.isClassType() || type.isInterfaceType()) {
            type.interfaces.forEach(_visitType);
            for (const prop of type.ownProperties) {
                _visitTypeRef(prop.type);
            }
            for (const meth of type.ownMethods) {
                _visitTypeRef(meth.returns.type);
                for (const param of meth.parameters) {
                    _visitTypeRef(param.type);
                }
            }
        }
    }
    function _visitTypeRef(typeRef) {
        if (typeRef.fqn) {
            const type = assm.tryFindType(typeRef.fqn);
            if (type) {
                _visitType(type);
            }
        }
        else if (typeRef.arrayOfType) {
            _visitTypeRef(typeRef.arrayOfType);
        }
        else if (typeRef.mapOfType) {
            _visitTypeRef(typeRef.mapOfType);
        }
        else if (typeRef.unionOfTypes) {
            typeRef.unionOfTypes.forEach(_visitTypeRef);
        }
    }
}
function _formatLocation(location) {
    if (!location) {
        return undefined;
    }
    return `(declared at ${location.filename}:${location.line})`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm8tdW51c2VkLXR5cGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJuby11bnVzZWQtdHlwZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxzQ0FBbUM7QUFFdEIsUUFBQSxrQkFBa0IsR0FBRyxJQUFJLGVBQU0sQ0FBQyxJQUFJLENBQUMsRUFBRTtJQUNsRCxnREFBZ0Q7SUFDaEQsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7UUFDM0MsT0FBTyxFQUFFLENBQUM7SUFDWixDQUFDO0lBQ0QsTUFBTSxTQUFTLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUMsTUFBTSxrQkFBa0IsR0FBRyxHQUFHLElBQUksQ0FBQyxJQUFJLE1BQU0sQ0FBQztJQUM5QyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDbEQsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO1NBQ3hELEdBQUcsQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxhQUFhLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO0FBQzFELENBQUMsQ0FBQyxDQUFDO0FBRUgsMEJBQWtCLENBQUMsR0FBRyxDQUFDO0lBQ3JCLElBQUksRUFBRSxnQkFBZ0I7SUFDdEIsT0FBTyxFQUFFLDhDQUE4QztJQUN2RCxJQUFJLEVBQUUsVUFBVSxDQUFDLEVBQUU7UUFDakIsVUFBVSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLEVBQzlFLFVBQVUsQ0FBQyxHQUFH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QUMsU0FBUyxFQUFFLENBQUM7WUFDN0IsYUFBYSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNuQyxDQUFDO2FBQU0sSUFBSSxPQUFPLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDaEMsT0FBTyxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDOUMsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsUUFBb0M7SUFDM0QsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQUMsT0FBTyxTQUFTLENBQUM7SUFBQyxDQUFDO0lBQ3BDLE9BQU8sZ0JBQWdCLFFBQVEsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLElBQUksR0FBRyxDQUFDO0FBQy9ELENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBc3NlbWJseSwgU291cmNlTG9jYXRpb24sIFR5cGUsIFR5cGVSZWZlcmVuY2UgfSBmcm9tICdqc2lpLXJlZmxlY3QnO1xuaW1wb3J0IHsgTGludGVyIH0gZnJvbSAnLi4vbGludGVyJztcblxuZXhwb3J0IGNvbnN0IG5vVW51c2VkVHlwZUxpbnRlciA9IG5ldyBMaW50ZXIoYXNzbSA9PiB7XG4gIC8vIE9ubHkgY2FyZSBhYm91dCBBV1MgQ29uc3RydWN0IExpYnJhcnkgaGVyZS4uLlxuICBpZiAoIWFzc20ubmFtZS5zdGFydHNXaXRoKCdAYXdzLWNkay9hd3MtJykpIHtcbiAgICByZXR1cm4gW107XG4gIH1cbiAgY29uc3QgdXNlZFR5cGVzID0gX2NvbGxlY3RVc2VkVHlwZXMoYXNzbSk7XG4gIGNvbnN0IGdlbmVyYXRlZEZxblByZWZpeCA9IGAke2Fzc20ubmFtZX0uQ2ZuYDtcbiAgcmV0dXJuIGFzc20udHlwZXMuZmlsdGVyKHR5cGUgPT4gIXR5cGUuaXNDbGFzc1R5cGUoKSlcbiAgICAuZmlsdGVyKHR5cGUgPT4gIXR5cGUuZnFuLnN0YXJ0c1dpdGgoZ2VuZXJhdGVkRnFuUHJlZml4KSlcbiAgICAubWFwKGluc3BlY3RlZFR5cGUgPT4gKHsgaW5zcGVjdGVkVHlwZSwgdXNlZFR5cGVzIH0pKTtcbn0pO1xuXG5ub1VudXNlZFR5cGVMaW50ZXIuYWRkKHtcbiAgY29kZTogJ25vLXVudXNlZC10eXBlJyxcbiAgbWVzc2FnZTogJ3R5cGUgb3IgZW51bSBpcyBub3QgdXNlZCBieSBleHBvcnRlZCBjbGFzc2VzJyxcbiAgZXZhbDogZXZhbHVhdGlvbiA9PiB7XG4gICAgZXZhbHVhdGlvbi5hc3NlcnQoZXZhbHVhdGlvbi5jdHgudXNlZFR5cGVzLmhhcyhldmFsdWF0aW9uLmN0eC5pbnNwZWN0ZWRUeXBlLmZxbiksXG4gICAgICBldmFsdWF0aW9uLmN0eC5pbnNwZWN0ZWRUeXBlLmZxbixcbiAgICAgIF9mb3JtYXRMb2NhdGlvbihldmFsdWF0aW9uLmN0eC5pbnNwZWN0ZWRUeXBlLmxvY2F0aW9uSW5Nb2R1bGUpKTtcbiAgfSxcbn0pO1xuXG5mdW5jdGlvbiBfY29sbGVjdFVzZWRUeXBlcyhhc3NtOiBBc3NlbWJseSk6IFNldDxzdHJpbmc+IHtcbiAgY29uc3QgcmVzdWx0ID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIGFzc20udHlwZXMuZmlsdGVyKHR5cGUgPT4gdHlwZS5pc0NsYXNzVHlwZSgpKVxuICAgIC5mb3JFYWNoKF92aXNpdFR5cGUpO1xuICByZXR1cm4gcmVzdWx0O1xuXG4gIGZ1bmN0aW9uIF92aXNpdFR5cGUodHlwZTogVHlwZSkge1xuICAgIGlmICh0eXBlb2YgdHlwZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgIGNvbnN0IHJlc29sdmVkVHlwZSA9IGFzc20udHJ5RmluZFR5cGUodHlwZSk7XG4gICAgICBpZiAoIXJlc29sdmVkVHlwZSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICB0eXBlID0gcmVzb2x2ZWRUeXBlO1xuICAgIH1cbiAgICBpZiAocmVzdWx0Lmhhcyh0eXBlLmZxbikpIHsgcmV0dXJuOyB9XG4gICAgcmVzdWx0LmFkZCh0eXBlLmZxbik7XG5cbiAgICAvLyBOb3RoaW5nIGVsc2UgdG8gZG8gZm9yIGVudW1zXG4gICAgaWYgKHR5cGUuaXNFbnVtVHlwZSgpKSB7IHJldHVybjsgfVxuXG4gICAgaWYgKHR5cGUuaXNDbGFzc1R5cGUoKSkge1xuICAgICAgaWYgKHR5cGUuYmFzZSkgeyBfdmlzaXRUeXBlKHR5cGUuYmFzZSk7IH1cbiAgICAgIGlmICh0eXBlLmluaXRpYWxpemVyKSB7XG4gICAgICAgIGZvciAoY29uc3QgcGFyYW0gb2YgdHlwZS5pbml0aWFsaXplci5wYXJhbWV0ZXJzKSB7XG4gICAgICAgICAgX3Zpc2l0VHlwZVJlZihwYXJhbS50eXBlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBpZiAodHlwZS5pc0NsYXNzVHlwZSgpIHx8IHR5cGUuaXNJbnRlcmZhY2VUeXBlKCkpIHtcbiAgICAgIHR5cGUuaW50ZXJmYWNlcy5mb3JFYWNoKF92aXNpdFR5cGUpO1xuICAgICAgZm9yIChjb25zdCBwcm9wIG9mIHR5cGUub3duUHJvcGVydGllcykge1xuICAgICAgICBfdmlzaXRUeXBlUmVmKHByb3AudHlwZSk7XG4gICAgICB9XG4gICAgICBmb3IgKGNvbnN0IG1ldGggb2YgdHlwZS5vd25NZXRob2RzKSB7XG4gICAgICAgIF92aXNpdFR5cGVSZWYobWV0aC5yZXR1cm5zLnR5cGUpO1xuICAgICAgICBmb3IgKGNvbnN0IHBhcmFtIG9mIG1ldGgucGFyYW1ldGVycykge1xuICAgICAgICAgIF92aXNpdFR5cGVSZWYocGFyYW0udHlwZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBfdmlzaXRUeXBlUmVmKHR5cGVSZWY6IFR5cGVSZWZlcmVuY2UpIHtcbiAgICBpZiAodHlwZVJlZi5mcW4pIHtcbiAgICAgIGNvbnN0IHR5cGUgPSBhc3NtLnRyeUZpbmRUeXBlKHR5cGVSZWYuZnFuKTtcbiAgICAgIGlmICh0eXBlKSB7IF92aXNpdFR5cGUodHlwZSk7IH1cbiAgICB9IGVsc2UgaWYgKHR5cGVSZWYuYXJyYXlPZlR5cGUpIHtcbiAgICAgIF92aXNpdFR5cGVSZWYodHlwZVJlZi5hcnJheU9mVHlwZSk7XG4gICAgfSBlbHNlIGlmICh0eXBlUmVmLm1hcE9mVHlwZSkge1xuICAgICAgX3Zpc2l0VHlwZVJlZih0eXBlUmVmLm1hcE9mVHlwZSk7XG4gICAgfSBlbHNlIGlmICh0eXBlUmVmLnVuaW9uT2ZUeXBlcykge1xuICAgICAgdHlwZVJlZi51bmlvbk9mVHlwZXMuZm9yRWFjaChfdmlzaXRUeXBlUmVmKTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gX2Zvcm1hdExvY2F0aW9uKGxvY2F0aW9uOiBTb3VyY2VMb2NhdGlvbiB8IHVuZGVmaW5lZCk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gIGlmICghbG9jYXRpb24pIHsgcmV0dXJuIHVuZGVmaW5lZDsgfVxuICByZXR1cm4gYChkZWNsYXJlZCBhdCAke2xvY2F0aW9uLmZpbGVuYW1lfToke2xvY2F0aW9uLmxpbmV9KWA7XG59XG4iXX0=
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.docsLinter = void 0;
const spec_1 = require("@jsii/spec");
const core_types_1 = require("./core-types");
const linter_1 = require("../linter");
exports.docsLinter = new linter_1.Linter(assembly => {
    return [
        ...flatMap(assembly.allClasses, classType => [
            { assembly, kind: 'type', documentable: classType, errorKey: classType.fqn },
            ...classType.ownProperties.map(property => ({ assembly, kind: 'class-property', containingType: classType, documentable: property, errorKey: `${classType.fqn}.${property.name}` })),
            ...classType.ownMethods.map(method => ({ assembly, kind: 'method', containingType: classType, documentable: method, errorKey: `${classType.fqn}.${method.name}` })),
        ]),
        ...flatMap(assembly.allInterfaces, interfaceType => [
            { assembly, kind: 'type', documentable: interfaceType, errorKey: interfaceType.fqn },
            ...interfaceType.ownProperties.map(property => ({ assembly, kind: 'interface-property', containingType: interfaceType, documentable: property, errorKey: `${interfaceType.fqn}.${property.name}` })),
            ...interfaceType.ownMethods.map(method => ({ assembly, kind: 'method', containingType: interfaceType, documentable: method, errorKey: `${interfaceType.fqn}.${method.name}` })),
        ]),
        ...flatMap(assembly.allEnums, enumType => [
            { assembly, kind: 'type', documentable: enumType, errorKey: enumType.fqn },
            ...enumType.members.map(member => ({ assembly, kind: 'enum-member', containingType: enumType, documentable: member, errorKey: `${enumType.fqn}.${member.name}` })),
        ]),
    ];
});
exports.docsLinter.add({
    code: 'docs-public-apis',
    message: 'Public API element must have a docstring',
    eval: e => {
        if (!isPublic(e.ctx)) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (isCfnType(e.ctx)) {
            return;
        }
        if (!e.ctx.documentable.docs.summary) {
            e.assert(e.ctx.documentable.docs.summary, e.ctx.errorKey);
        }
    },
});
exports.docsLinter.add({
    code: 'props-default-doc',
    message: 'Optional property must have @default documentation',
    eval: e => {
        if (e.ctx.kind !== 'interface-property') {
            return;
        }
        if (!e.ctx.containingType.isDataType()) {
            return;
        }
        // this rule does not apply to L1 constructs
        if (core_types_1.CoreTypes.isCfnType(e.ctx.containingType) || core_types_1.CoreTypes.isCfnNestedType(e.ctx.containingType)) {
            return;
        }
        const property = e.ctx.documentable;
        e.assert(!property.optional || property.docs.docs.default !== undefined, e.ctx.errorKey);
    },
});
exports.docsLinter.add({
    code: 'props-no-undefined-default',
    message: '\'@default undefined\' is not helpful. Users will know the VALUE is literally \'undefined\' if they don\'t specify it, but what is the BEHAVIOR if they do so?',
    eval: e => {
        if (e.ctx.kind !== 'interface-property') {
            return;
        }
        if (!e.ctx.containingType.isDataType()) {
            return;
        }
        const property = e.ctx.documentable;
        e.assert(property.docs.docs.default !== 'undefined', e.ctx.errorKey);
    },
});
exports.docsLinter.add({
    code: 'no-experimental-apis',
    message: 'The use of @experimental in not allowed',
    eval: e => {
        if (!isPublic(e.ctx)) {
            return;
        }
        // technically we should ban the use of @experimental in the codebase. Since jsii marks all symbols
        // of experimental modules as experimental we can't.
        if (isModuleExperimental(e.ctx.assembly)) {
            return;
        }
        if ((e.ctx.kind === 'type' && core_types_1.CoreTypes.isCfnType(e.ctx.documentable))
            || (e.ctx.kind === 'interface-property' && core_types_1.CoreTypes.isCfnType(e.ctx.containingType))) {
            return;
        }
        const sym = e.ctx.documentable;
        e.assert(sym.docs.docs.stability !== spec_1.Stability.Experimental, e.ctx.errorKey);
    },
});
function isPublic(ctx) {
    switch (ctx.kind) {
        case 'class-property':
        case 'interface-property':
        case 'method':
            return !ctx.documentable.protected;
        case 'enum-member':
        case 'type':
            return true;
    }
}
function isCfnType(ctx) {
    switch (ctx.kind) {
        case 'class-property':
        case 'interface-property':
        case 'method':
        case 'enum-member':
            return core_types_1.CoreTypes.isCfnType(ctx.containingType);
        case 'type':
            return core_types_1.CoreTypes.isCfnType(ctx.documentable);
    }
}
function isModuleExperimental(assembly) {
    return assembly.spec.docs?.stability === spec_1.Stability.Experimental;
}
function flatMap(array, callbackfn) {
    return Array.prototype.concat(...array.map(callbackfn));
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZG9jcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRvY3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEscUNBQXVDO0FBRXZDLDZDQUF5QztBQUN6QyxzQ0FBbUM7QUFZdEIsUUFBQSxVQUFVLEdBQUcsSUFBSSxlQUFNLENBQW9CLFFBQVEsQ0FBQyxFQUFFO0lBQ2pFLE9BQU87UUFDTCxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDM0MsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRSxZQUFZLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxTQUFTLENBQUMsR0FBRyxFQUFFO1lBQzVFLEdBQUcsU0FBUyxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxnQkFBZ0IsRUFBRSxjQUFjLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLEdBQUcsU0FBUyxDQUFDLEdBQUcsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3BMLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsY0FBYyxFQUFFLFNBQVMsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxHQUFHLFNBQVMsQ0FBQyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztTQUNwSyxDQUFDO1FBQ0YsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLGFBQWEsRUFBRSxhQUFhLENBQUMsRUFBRSxDQUFDO1lBQ2xELEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsWUFBWSxFQUFFLGFBQWEsRUFB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QyxHQUFHLENBQUMsY0FBYyxDQUFDLENBQUM7UUFFakQsS0FBSyxNQUFNO1lBQ1QsT0FBTyxzQkFBUyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDakQsQ0FBQztBQUNILENBQUM7QUFFRCxTQUFTLG9CQUFvQixDQUFDLFFBQTBCO0lBQ3RELE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsU0FBUyxLQUFLLGdCQUFTLENBQUMsWUFBWSxDQUFDO0FBQ2xFLENBQUM7QUFFRCxTQUFTLE9BQU8sQ0FBTyxLQUFtQixFQUFFLFVBQWlFO0lBQzNHLE9BQU8sS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUM7QUFDMUQsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0YWJpbGl0eSB9IGZyb20gJ0Bqc2lpL3NwZWMnO1xuaW1wb3J0ICogYXMgcmVmbGVjdCBmcm9tICdqc2lpLXJlZmxlY3QnO1xuaW1wb3J0IHsgQ29yZVR5cGVzIH0gZnJvbSAnLi9jb3JlLXR5cGVzJztcbmltcG9ydCB7IExpbnRlciB9IGZyb20gJy4uL2xpbnRlcic7XG5cbnR5cGUgRG9jc0xpbnRlckNvbnRleHQgPSB7XG4gIHJlYWRvbmx5IGFzc2VtYmx5OiByZWZsZWN0LkFzc2VtYmx5O1xuICByZWFkb25seSBlcnJvcktleTogc3RyaW5nO1xufSAmICh7IHJlYWRvbmx5IGtpbmQ6ICd0eXBlJzsgZG9jdW1lbnRhYmxlOiByZWZsZWN0LlR5cGUgfVxufCB7IHJlYWRvbmx5IGtpbmQ6ICdpbnRlcmZhY2UtcHJvcGVydHknOyBjb250YWluaW5nVHlwZTogcmVmbGVjdC5JbnRlcmZhY2VUeXBlOyBkb2N1bWVudGFibGU6IHJlZmxlY3QuUHJvcGVydHkgfVxufCB7IHJlYWRvbmx5IGtpbmQ6ICdjbGFzcy1wcm9wZXJ0eSc7IGNvbnRhaW5pbmdUeXBlOiByZWZsZWN0LkNsYXNzVHlwZTsgZG9jdW1lbnRhYmxlOiByZWZsZWN0LlByb3BlcnR5IH1cbnwgeyByZWFkb25seSBraW5kOiAnbWV0aG9kJzsgY29udGFpbmluZ1R5cGU6IHJlZmxlY3QuUmVmZXJlbmNlVHlwZTsgZG9jdW1lbnRhYmxlOiByZWZsZWN0Lk1ldGhvZCB9XG58IHsgcmVhZG9ubHkga2luZDogJ2VudW0tbWVtYmVyJzsgY29udGFpbmluZ1R5cGU6IHJlZmxlY3QuRW51bVR5cGU7IGRvY3VtZW50YWJsZTogcmVmbGVjdC5FbnVtTWVtYmVyIH1cbik7XG5cbmV4cG9ydCBjb25zdCBkb2NzTGludGVyID0gbmV3IExpbnRlcjxEb2NzTGludGVyQ29udGV4dD4oYXNzZW1ibHkgPT4ge1xuICByZXR1cm4gW1xuICAgIC4uLmZsYXRNYXAoYXNzZW1ibHkuYWxsQ2xhc3NlcywgY2xhc3NUeXBlID0+IFtcbiAgICAgIHsgYXNzZW1ibHksIGtpbmQ6ICd0eXBlJywgZG9jdW1lbnRhYmxlOiBjbGFzc1R5cGUsIGVycm9yS2V5OiBjbGFzc1R5cGUuZnFuIH0sXG4gICAgICAuLi5jbGFzc1R5cGUub3duUHJvcGVydGllcy5tYXAocHJvcGVydHkgPT4gKHsgYXNzZW1ibHksIGtpbmQ6ICdjbGFzcy1wcm9wZXJ0eScsIGNvbnRhaW5pbmdUeXBlOiBjbGFzc1R5cGUsIGRvY3VtZW50YWJsZTogcHJvcGVydHksIGVycm9yS2V5OiBgJHtjbGFzc1R5cGUuZnFufS4ke3Byb3BlcnR5Lm5hbWV9YCB9KSksXG4gICAgICAuLi5jbGFzc1R5cGUub3duTWV0aG9kcy5tYXAobWV0aG9kID0+ICh7IGFzc2VtYmx5LCBraW5kOiAnbWV0aG9kJywgY29udGFpbmluZ1R5cGU6IGNsYXNzVHlwZSwgZG9jdW1lbnRhYmxlOiBtZXRob2QsIGVycm9yS2V5OiBgJHtjbGFzc1R5cGUuZnFufS4ke21ldGhvZC5uYW1lfWAgfSkpLFxuICAgIF0pLFxuICAgIC4uLmZsYXRNYXAoYXNzZW1ibHkuYWxsSW50ZXJmYWNlcywgaW50ZXJmYWNlVHlwZSA9PiBbXG4gICAgICB7IGFzc2VtYmx5LCBraW5kOiAndHlwZScsIGRvY3VtZW50YWJsZTogaW50ZXJmYWNlVHlwZSwgZXJyb3JLZXk6IGludGVyZmFjZVR5cGUuZnFuIH0sXG4gICAgICAuLi5pbnRlcmZhY2VUeXBlLm93blByb3BlcnRpZXMubWFwKHByb3BlcnR5ID0+ICh7IGFzc2VtYmx5LCBraW5kOiAnaW50ZXJmYWNlLXByb3BlcnR5JywgY29udGFpbmluZ1R5cGU6IGludGVyZmFjZVR5cGUsIGRvY3VtZW50YWJsZTogcHJvcGVydHksIGVycm9yS2V5OiBgJHtpbnRlcmZhY2VUeXBlLmZxbn0uJHtwcm9wZXJ0eS5uYW1lfWAgfSkpLFxuICAgICAgLi4uaW50ZXJmYWNlVHlwZS5vd25NZXRob2RzLm1hcChtZXRob2QgPT4gKHsgYXNzZW1ibHksIGtpbmQ6ICdtZXRob2QnLCBjb250YWluaW5nVHlwZTogaW50ZXJmYWNlVHlwZSwgZG9jdW1lbnRhYmxlOiBtZXRob2QsIGVycm9yS2V5OiBgJHtpbnRlcmZhY2VUeXBlLmZxbn0uJHttZXRob2QubmFtZX1gIH0pKSxcbiAgICBdKSxcbiAgICAuLi5mbGF0TWFwKGFzc2VtYmx5LmFsbEVudW1zLCBlbnVtVHlwZSA9PiBbXG4gICAgICB7IGFzc2VtYmx5LCBraW5kOiAndHlwZScsIGRvY3VtZW50YWJsZTogZW51bVR5cGUsIGVycm9yS2V5OiBlbnVtVHlwZS5mcW4gfSxcbiAgICAgIC4uLmVudW1UeXBlLm1lbWJlcnMubWFwKG1lbWJlciA9PiAoeyBhc3NlbWJseSwga2luZDogJ2VudW0tbWVtYmVyJywgY29udGFpbmluZ1R5cGU6IGVudW1UeXBlLCBkb2N1bWVudGFibGU6IG1lbWJlciwgZXJyb3JLZXk6IGAke2VudW1UeXBlLmZxbn0uJHttZW1iZXIubmFtZX1gIH0pKSxcbiAgICBdKSxcbiAgXSBhcyBEb2NzTGludGVyQ29udGV4dFtdO1xufSk7XG5cbmRvY3NMaW50ZXIuYWRkKHtcbiAgY29kZTogJ2RvY3MtcHVibGljLWFwaXMnLFxuICBtZXNzYWdlOiAnUHVibGljIEFQSSBlbGVtZW50IG11c3QgaGF2ZSBhIGRvY3N0cmluZycsXG4gIGV2YWw6IGUgPT4ge1xuICAgIGlmICghaXNQdWJsaWMoZS5jdHgpKSB7IHJldHVybjsgfVxuICAgIC8vIHRoaXMgcnVsZSBkb2VzIG5vdCBhcHBseSB0byBMMSBjb25zdHJ1Y3RzXG4gICAgaWYgKGlzQ2ZuVHlwZShlLmN0eCkpIHsgcmV0dXJuOyB9XG5cbiAgICBpZiAoIWUuY3R4LmRvY3VtZW50YWJsZS5kb2NzLnN1bW1hcnkpIHtcbiAgICAgIGUuYXNzZXJ0KGUuY3R4LmRvY3VtZW50YWJsZS5kb2NzLnN1bW1hcnksIGUuY3R4LmVycm9yS2V5KTtcbiAgICB9XG4gIH0sXG59KTtcblxuZG9jc0xpbnRlci5hZGQoe1xuICBjb2RlOiAncHJvcHMtZGVmYXVsdC1kb2MnLFxuICBtZXNzYWdlOiAnT3B0aW9uYWwgcHJvcGVydHkgbXVzdCBoYXZlIEBkZWZhdWx0IGRvY3VtZW50YXRpb24nLFxuICBldmFsOiBlID0+IHtcbiAgICBpZiAoZS5jdHgua2luZCAhPT0gJ2ludGVyZmFjZS1wcm9wZXJ0eScpIHsgcmV0dXJuOyB9XG4gICAgaWYgKCFlLmN0eC5jb250YWluaW5nVHlwZS5pc0RhdGFUeXBlKCkpIHsgcmV0dXJuOyB9XG4gICAgLy8gdGhpcyBydWxlIGRvZXMgbm90IGFwcGx5IHRvIEwxIGNvbnN0cnVjdHNcbiAgICBpZiAoQ29yZVR5cGVzLmlzQ2ZuVHlwZShlLmN0eC5jb250YWluaW5nVHlwZSkgfHwgQ29yZVR5cGVzLmlzQ2ZuTmVzdGVkVHlwZShlLmN0eC5jb250YWluaW5nVHlwZSkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBwcm9wZXJ0eSA9IGUuY3R4LmRvY3VtZW50YWJsZTtcbiAgICBlLmFzc2VydCghcHJvcGVydHkub3B0aW9uYWwgfHwgcHJvcGVydHkuZG9jcy5kb2NzLmRlZmF1bHQgIT09IHVuZGVmaW5lZCwgZS5jdHguZXJyb3JLZXkpO1xuICB9LFxufSk7XG5cbmRvY3NMaW50ZXIuYWRkKHtcbiAgY29kZTogJ3Byb3BzLW5vLXVuZGVmaW5lZC1kZWZhdWx0JyxcbiAgbWVzc2FnZTogJ1xcJ0BkZWZhdWx0IHVuZGVmaW5lZFxcJyBpcyBub3QgaGVscGZ1bC4gVXNlcnMgd2lsbCBrbm93IHRoZSBWQUxVRSBpcyBsaXRlcmFsbHkgXFwndW5kZWZpbmVkXFwnIGlmIHRoZXkgZG9uXFwndCBzcGVjaWZ5IGl0LCBidXQgd2hhdCBpcyB0aGUgQkVIQVZJT1IgaWYgdGhleSBkbyBzbz8nLFxuICBldmFsOiBlID0+IHtcbiAgICBpZiAoZS5jdHgua2luZCAhPT0gJ2ludGVyZmFjZS1wcm9wZXJ0eScpIHsgcmV0dXJuOyB9XG4gICAgaWYgKCFlLmN0eC5jb250YWluaW5nVHlwZS5pc0RhdGFUeXBlKCkpIHsgcmV0dXJuOyB9XG5cbiAgICBjb25zdCBwcm9wZXJ0eSA9IGUuY3R4LmRvY3VtZW50YWJsZTtcbiAgICBlLmFzc2VydChwcm9wZXJ0eS5kb2NzLmRvY3MuZGVmYXVsdCAhPT0gJ3VuZGVmaW5lZCcsIGUuY3R4LmVycm9yS2V5KTtcbiAgfSxcbn0pO1xuXG5kb2NzTGludGVyLmFkZCh7XG4gIGNvZGU6ICduby1leHBlcmltZW50YWwtYXBpcycsXG4gIG1lc3NhZ2U6ICdUaGUgdXNlIG9mIEBleHBlcmltZW50YWwgaW4gbm90IGFsbG93ZWQnLFxuICBldmFsOiBlID0+IHtcbiAgICBpZiAoIWlzUHVibGljKGUuY3R4KSkgeyByZXR1cm47IH1cbiAgICAvLyB0ZWNobmljYWxseSB3ZSBzaG91bGQgYmFuIHRoZSB1c2Ugb2YgQGV4cGVyaW1lbnRhbCBpbiB0aGUgY29kZWJhc2UuIFNpbmNlIGpzaWkgbWFya3MgYWxsIHN5bWJvbHNcbiAgICAvLyBvZiBleHBlcmltZW50YWwgbW9kdWxlcyBhcyBleHBlcmltZW50YWwgd2UgY2FuJ3QuXG4gICAgaWYgKGlzTW9kdWxlRXhwZXJpbWVudGFsKGUuY3R4LmFzc2VtYmx5KSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoKGUuY3R4LmtpbmQgPT09ICd0eXBlJyAmJiBDb3JlVHlwZXMuaXNDZm5UeXBlKGUuY3R4LmRvY3VtZW50YWJsZSkpXG4gICAgfHwgKGUuY3R4LmtpbmQgPT09ICdpbnRlcmZhY2UtcHJvcGVydHknICYmIENvcmVUeXBlcy5pc0NmblR5cGUoZS5jdHguY29udGFpbmluZ1R5cGUpKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBzeW0gPSBlLmN0eC5kb2N1bWVudGFibGU7XG4gICAgZS5hc3NlcnQoc3ltLmRvY3MuZG9jcy5zdGFiaWxpdHkgIT09IFN0YWJpbGl0eS5FeHBlcmltZW50YWwsIGUuY3R4LmVycm9yS2V5KTtcbiAgfSxcbn0pO1xuXG5mdW5jdGlvbiBpc1B1YmxpYyhjdHg6IERvY3NMaW50ZXJDb250ZXh0KSB7XG4gIHN3aXRjaCAoY3R4LmtpbmQpIHtcbiAgICBjYXNlICdjbGFzcy1wcm9wZXJ0eSc6XG4gICAgY2FzZSAnaW50ZXJmYWNlLXByb3BlcnR5JzpcbiAgICBjYXNlICdtZXRob2QnOlxuICAgICAgcmV0dXJuICFjdHguZG9jdW1lbnRhYmxlLnByb3RlY3RlZDtcblxuICAgIGNhc2UgJ2VudW0tbWVtYmVyJzpcbiAgICBjYXNlICd0eXBlJzpcbiAgICAgIHJldHVybiB0cnVlO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzQ2ZuVHlwZShjdHg6IERvY3NMaW50ZXJDb250ZXh0KSB7XG4gIHN3aXRjaCAoY3R4LmtpbmQpIHtcbiAgICBjYXNlICdjbGFzcy1wcm9wZXJ0eSc6XG4gICAgY2FzZSAnaW50ZXJmYWNlLXByb3BlcnR5JzpcbiAgICBjYXNlICdtZXRob2QnOlxuICAgIGNhc2UgJ2VudW0tbWVtYmVyJzpcbiAgICAgIHJldHVybiBDb3JlVHlwZXMuaXNDZm5UeXBlKGN0eC5jb250YWluaW5nVHlwZSk7XG5cbiAgICBjYXNlICd0eXBlJzpcbiAgICAgIHJldHVybiBDb3JlVHlwZXMuaXNDZm5UeXBlKGN0eC5kb2N1bWVudGFibGUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGlzTW9kdWxlRXhwZXJpbWVudGFsKGFzc2VtYmx5OiByZWZsZWN0LkFzc2VtYmx5KSB7XG4gIHJldHVybiBhc3NlbWJseS5zcGVjLmRvY3M/LnN0YWJpbGl0eSA9PT0gU3RhYmlsaXR5LkV4cGVyaW1lbnRhbDtcbn1cblxuZnVuY3Rpb24gZmxhdE1hcDxULCBVPihhcnJheTogcmVhZG9ubHkgVFtdLCBjYWxsYmFja2ZuOiAodmFsdWU6IFQsIGluZGV4OiBudW1iZXIsIGFycmF5OiByZWFkb25seSBUW10pID0+IFVbXSk6IFVbXSB7XG4gIHJldHVybiBBcnJheS5wcm90b3R5cGUuY29uY2F0KC4uLmFycmF5Lm1hcChjYWxsYmFja2ZuKSk7XG59XG4iXX0=
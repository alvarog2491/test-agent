"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.apiLinter = void 0;
const construct_1 = require("./construct");
const core_types_1 = require("./core-types");
const linter_1 = require("../linter");
const CLASS_ON_PURPOSE_RULE = 'ref-via-interface';
const L2_INTERFACE_ON_PURPOSE_RULE = 'prefer-ref-interface';
// lint all constructs that are not L1 resources
exports.apiLinter = new linter_1.Linter(a => construct_1.ConstructReflection
    .findAllConstructs(a)
    .filter(c => !core_types_1.CoreTypes.isCfnResource(c.classType)));
exports.apiLinter.add({
    code: CLASS_ON_PURPOSE_RULE,
    message: 'API should use interface (preferably IxxxRef, otherwise Ixxx) and not the concrete class (%s). ' +
        `If this is intentional, add "${ignoreTag(CLASS_ON_PURPOSE_RULE)}" to element's jsdoc`,
    eval: e => {
        visitParameters(e.ctx.classType, {
            visitType: function (type, docs, scope) {
                // allow exclusion of this rule
                if (docHasIgnoreTag(docs, CLASS_ON_PURPOSE_RULE)) {
                    return;
                }
                // Assert that all types that reference classes are not resource constructs. Those
                // should be referenced via Interface.
                e.assert(!type.type
                    || !type.type.isClassType()
                    || !core_types_1.CoreTypes.isResourceClass(type.type)
                    // Make an exception for `constructs.Construct`.
                    || type.type.fqn === e.ctx.core.baseConstructClassFqn, scope, type.type?.fqn);
            },
        });
    },
});
exports.apiLinter.add({
    code: L2_INTERFACE_ON_PURPOSE_RULE,
    message: 'API should prefer to use the L1 reference interface (IxxxRef) and not the L2 interface (%s). ' +
        `If this is intentional, add "${ignoreTag(L2_INTERFACE_ON_PURPOSE_RULE)}" to element's jsdoc`,
    eval: e => {
        visitParameters(e.ctx.classType, {
            visitType: function (type, docs, scope) {
                // allow exclusion of this rule
                if (docHasIgnoreTag(docs, L2_INTERFACE_ON_PURPOSE_RULE)) {
                    return;
                }
                // Assert that all types that interfaces are not L2 interfaces. This is actually not checking
                // that they ARE Ref interfaces, just that they aren't L2 interfaces (could also be service-
                // specific non-resource interfaces, and those are fine too)
                e.assert(!type.type
                    || !type.type.isInterfaceType()
                    || type.type.datatype
                    || !core_types_1.CoreTypes.isL2Interface(type.type), scope, type.type?.fqn);
            },
        });
    },
});
function ignoreTag(rule) {
    return `[disable-awslint:${rule}]`;
}
function docHasIgnoreTag(docs, rule) {
    const tag = ignoreTag(rule);
    return docs.summary.includes(tag) || docs.remarks.includes(tag);
}
/**
 * Visit all types in the API of a given type
 *
 * This visits method parameters and members of structs of method parameters.
 */
function visitParameters(root, visitor) {
    const visited = new Set();
    if (root.isClassType()) {
        assertClass(root);
    }
    else if (root.isInterfaceType()) {
        assertInterface(root);
    }
    else {
        throw new Error(`invalid type: ${root.toString()}`);
    }
    function assertClass(type) {
        if (visited.has(type.fqn)) {
            return;
        }
        visited.add(type.fqn);
        for (const method of type.allMethods) {
            assertMethod(method);
        }
        if (type.initializer) {
            assertMethod(type.initializer);
        }
    }
    function assertDataType(type) {
        for (const property of type.allProperties) {
            assertProperty(property);
        }
    }
    function assertInterface(type) {
        if (visited.has(type.fqn)) {
            return;
        }
        visited.add(type.fqn);
        if (type.datatype) {
            assertDataType(type);
        }
        for (const method of type.allMethods) {
            assertMethod(method);
        }
    }
    function assertProperty(property) {
        if (property.protected) {
            return;
        }
        const site = property.overrides ? property.overrides : property.parentType;
        assertType(property.type, property.docs, `${site.fqn}.${property.name}`);
    }
    function assertMethod(method) {
        if (method.protected) {
            return;
        }
        const site = method.overrides ? method.overrides : method.parentType;
        const scope = `${site.fqn}.${method.name}`;
        let firstMethod = site.isClassType() || site.isInterfaceType()
            ? site.allMethods.find(m => m.name === method.name)
            : undefined;
        if (!firstMethod) {
            firstMethod = method;
        }
        for (const param of firstMethod.parameters) {
            assertType(param.type, param.docs, `${scope}.${param.name}`);
        }
        // note that we do not require that return values will use an interface
    }
    function assertType(type, docs, scope) {
        visitor.visitType(type, docs, scope);
        // And recurse
        if (type.arrayOfType) {
            return assertType(type.arrayOfType, docs, scope);
        }
        if (type.mapOfType) {
            return assertType(type.mapOfType, docs, scope);
        }
        if (type.unionOfTypes) {
            for (const t of type.unionOfTypes) {
                assertType(t, docs, scope);
            }
            return;
        }
        // interfaces are okay
        if (type.type && type.type.isInterfaceType()) {
            return assertInterface(type.type);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBpLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDJDQUFrRDtBQUNsRCw2Q0FBeUM7QUFDekMsc0NBQW1DO0FBRW5DLE1BQU0scUJBQXFCLEdBQUcsbUJBQW1CLENBQUM7QUFDbEQsTUFBTSw0QkFBNEIsR0FBRyxzQkFBc0IsQ0FBQztBQUU1RCxnREFBZ0Q7QUFDbkMsUUFBQSxTQUFTLEdBQUcsSUFBSSxlQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQywrQkFBbUI7S0FDekQsaUJBQWlCLENBQUMsQ0FBQyxDQUFDO0tBQ3BCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsc0JBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUV2RCxpQkFBUyxDQUFDLEdBQUcsQ0FBQztJQUNaLElBQUksRUFBRSxxQkFBcUI7SUFDM0IsT0FBTyxFQUFFLGlHQUFpRztRQUN4RyxnQ0FBZ0MsU0FBUyxDQUFDLHFCQUFxQixDQUFDLHNCQUFzQjtJQUN4RixJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUU7UUFDUixlQUFlLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUU7WUFDL0IsU0FBUyxFQUFFLFVBQVUsSUFBMkIsRUFBRSxJQUFrQixFQUFFLEtBQWE7Z0JBQ2pGLCtCQUErQjtnQkFDL0IsSUFBSSxlQUFlLENBQUMsSUFBSSxFQUFFLHFCQUFxQixDQUFDLEVBQUUsQ0FBQztvQkFDakQsT0FBTztnQkFDVCxDQUFDO2dCQUVELGtGQUFrRjtnQkFDbEYsc0NBQXNDO2dCQUN0QyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUk7dUJBQ2QsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRTt1QkFDeEIsQ0FBQyxzQkFBUyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDO29C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Q0FBQztRQUVELElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO1lBQ3RCLEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUNsQyxVQUFVLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztZQUM3QixDQUFDO1lBQ0QsT0FBTztRQUNULENBQUM7UUFFRCxzQkFBc0I7UUFDdEIsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLEVBQUUsQ0FBQztZQUM3QyxPQUFPLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEMsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgcmVmbGVjdCBmcm9tICdqc2lpLXJlZmxlY3QnO1xuaW1wb3J0IHsgQ29uc3RydWN0UmVmbGVjdGlvbiB9IGZyb20gJy4vY29uc3RydWN0JztcbmltcG9ydCB7IENvcmVUeXBlcyB9IGZyb20gJy4vY29yZS10eXBlcyc7XG5pbXBvcnQgeyBMaW50ZXIgfSBmcm9tICcuLi9saW50ZXInO1xuXG5jb25zdCBDTEFTU19PTl9QVVJQT1NFX1JVTEUgPSAncmVmLXZpYS1pbnRlcmZhY2UnO1xuY29uc3QgTDJfSU5URVJGQUNFX09OX1BVUlBPU0VfUlVMRSA9ICdwcmVmZXItcmVmLWludGVyZmFjZSc7XG5cbi8vIGxpbnQgYWxsIGNvbnN0cnVjdHMgdGhhdCBhcmUgbm90IEwxIHJlc291cmNlc1xuZXhwb3J0IGNvbnN0IGFwaUxpbnRlciA9IG5ldyBMaW50ZXIoYSA9PiBDb25zdHJ1Y3RSZWZsZWN0aW9uXG4gIC5maW5kQWxsQ29uc3RydWN0cyhhKVxuICAuZmlsdGVyKGMgPT4gIUNvcmVUeXBlcy5pc0NmblJlc291cmNlKGMuY2xhc3NUeXBlKSkpO1xuXG5hcGlMaW50ZXIuYWRkKHtcbiAgY29kZTogQ0xBU1NfT05fUFVSUE9TRV9SVUxFLFxuICBtZXNzYWdlOiAnQVBJIHNob3VsZCB1c2UgaW50ZXJmYWNlIChwcmVmZXJhYmx5IEl4eHhSZWYsIG90aGVyd2lzZSBJeHh4KSBhbmQgbm90IHRoZSBjb25jcmV0ZSBjbGFzcyAoJXMpLiAnICtcbiAgICBgSWYgdGhpcyBpcyBpbnRlbnRpb25hbCwgYWRkIFwiJHtpZ25vcmVUYWcoQ0xBU1NfT05fUFVSUE9TRV9SVUxFKX1cIiB0byBlbGVtZW50J3MganNkb2NgLFxuICBldmFsOiBlID0+IHtcbiAgICB2aXNpdFBhcmFtZXRlcnMoZS5jdHguY2xhc3NUeXBlLCB7XG4gICAgICB2aXNpdFR5cGU6IGZ1bmN0aW9uICh0eXBlOiByZWZsZWN0LlR5cGVSZWZlcmVuY2UsIGRvY3M6IHJlZmxlY3QuRG9jcywgc2NvcGU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICAvLyBhbGxvdyBleGNsdXNpb24gb2YgdGhpcyBydWxlXG4gICAgICAgIGlmIChkb2NIYXNJZ25vcmVUYWcoZG9jcywgQ0xBU1NfT05fUFVSUE9TRV9SVUxFKSkge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEFzc2VydCB0aGF0IGFsbCB0eXBlcyB0aGF0IHJlZmVyZW5jZSBjbGFzc2VzIGFyZSBub3QgcmVzb3VyY2UgY29uc3RydWN0cy4gVGhvc2VcbiAgICAgICAgLy8gc2hvdWxkIGJlIHJlZmVyZW5jZWQgdmlhIEludGVyZmFjZS5cbiAgICAgICAgZS5hc3NlcnQoIXR5cGUudHlwZVxuICAgICAgICAgIHx8ICF0eXBlLnR5cGUuaXNDbGFzc1R5cGUoKVxuICAgICAgICAgIHx8ICFDb3JlVHlwZXMuaXNSZXNvdXJjZUNsYXNzKHR5cGUudHlwZSlcbiAgICAgICAgICAvLyBNYWtlIGFuIGV4Y2VwdGlvbiBmb3IgYGNvbnN0cnVjdHMuQ29uc3RydWN0YC5cbiAgICAgICAgICB8fCB0eXBlLnR5cGUuZnFuID09PSBlLmN0eC5jb3JlLmJhc2VDb25zdHJ1Y3RDbGFzc0ZxbixcbiAgICAgICAgc2NvcGUsXG4gICAgICAgIHR5cGUudHlwZT8uZnFuLFxuICAgICAgICApO1xuICAgICAgfSxcbiAgICB9KTtcbiAgfSxcbn0pO1xuXG5hcGlMaW50ZXIuYWRkKHtcbiAgY29kZTogTDJfSU5URVJGQUNFX09OX1BVUlBPU0VfUlVMRSxcbiAgbWVzc2FnZTogJ0FQSSBzaG91bGQgcHJlZmVyIHRvIHVzZSB0aGUgTDEgcmVmZXJlbmNlIGludGVyZmFjZSAoSXh4eFJlZikgYW5kIG5vdCB0aGUgTDIgaW50ZXJmYWNlICglcykuICcgK1xuICAgIGBJZiB0aGlzIGlzIGludGVudGlvbmFsLCBhZGQgXCIke2lnbm9yZVRhZyhMMl9JTlRFUkZBQ0VfT05fUFVSUE9TRV9SVUxFKX1cIiB0byBlbGVtZW50J3MganNkb2NgLFxuICBldmFsOiBlID0+IHtcbiAgICB2aXNpdFBhcmFtZXRlcnMoZS5jdHguY2xhc3NUeXBlLCB7XG4gICAgICB2aXNpdFR5cGU6IGZ1bmN0aW9uICh0eXBlOiByZWZsZWN0LlR5cGVSZWZlcmVuY2UsIGRvY3M6IHJlZmxlY3QuRG9jcywgc2NvcGU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICAvLyBhbGxvdyBleGNsdXNpb24gb2YgdGhpcyBydWxlXG4gICAgICAgIGlmIChkb2NIYXNJZ25vcmVUYWcoZG9jcywgTDJfSU5URVJGQUNFX09OX1BVUlBPU0VfUlVMRSkpIHtcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBc3NlcnQgdGhhdCBhbGwgdHlwZXMgdGhhdCBpbnRlcmZhY2VzIGFyZSBub3QgTDIgaW50ZXJmYWNlcy4gVGhpcyBpcyBhY3R1YWxseSBub3QgY2hlY2tpbmdcbiAgICAgICAgLy8gdGhhdCB0aGV5IEFSRSBSZWYgaW50ZXJmYWNlcywganVzdCB0aGF0IHRoZXkgYXJlbid0IEwyIGludGVyZmFjZXMgKGNvdWxkIGFsc28gYmUgc2VydmljZS1cbiAgICAgICAgLy8gc3BlY2lmaWMgbm9uLXJlc291cmNlIGludGVyZmFjZXMsIGFuZCB0aG9zZSBhcmUgZmluZSB0b28pXG4gICAgICAgIGUuYXNzZXJ0KCF0eXBlLnR5cGVcbiAgICAgICAgICB8fCAhdHlwZS50eXBlLmlzSW50ZXJmYWNlVHlwZSgpXG4gICAgICAgICAgfHwgdHlwZS50eXBlLmRhdGF0eXBlXG4gICAgICAgICAgfHwgIUNvcmVUeXBlcy5pc0wySW50ZXJmYWNlKHR5cGUudHlwZSksXG4gICAgICAgIHNjb3BlLFxuICAgICAgICB0eXBlLnR5cGU/LmZxbixcbiAgICAgICAgKTtcbiAgICAgIH0sXG4gICAgfSk7XG4gIH0sXG59KTtcblxuZnVuY3Rpb24gaWdub3JlVGFnKHJ1bGU6IHN0cmluZykge1xuICByZXR1cm4gYFtkaXNhYmxlLWF3c2xpbnQ6JHtydWxlfV1gO1xufVxuXG5mdW5jdGlvbiBkb2NIYXNJZ25vcmVUYWcoZG9jczogcmVmbGVjdC5Eb2NzLCBydWxlOiBzdHJpbmcpIHtcbiAgY29uc3QgdGFnID0gaWdub3JlVGFnKHJ1bGUpO1xuICByZXR1cm4gZG9jcy5zdW1tYXJ5LmluY2x1ZGVzKHRhZykgfHwgZG9jcy5yZW1hcmtzLmluY2x1ZGVzKHRhZyk7XG59XG5cbi8qKlxuICogVmlzaXQgYWxsIHR5cGVzIGluIHRoZSBBUEkgb2YgYSBnaXZlbiB0eXBlXG4gKlxuICogVGhpcyB2aXNpdHMgbWV0aG9kIHBhcmFtZXRlcnMgYW5kIG1lbWJlcnMgb2Ygc3RydWN0cyBvZiBtZXRob2QgcGFyYW1ldGVycy5cbiAqL1xuZnVuY3Rpb24gdmlzaXRQYXJhbWV0ZXJzKHJvb3Q6IHJlZmxlY3QuVHlwZSwgdmlzaXRvcjogVHlwZVZpc2l0b3IpIHtcbiAgY29uc3QgdmlzaXRlZCA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuXG4gIGlmIChyb290LmlzQ2xhc3NUeXBlKCkpIHtcbiAgICBhc3NlcnRDbGFzcyhyb290KTtcbiAgfSBlbHNlIGlmIChyb290LmlzSW50ZXJmYWNlVHlwZSgpKSB7XG4gICAgYXNzZXJ0SW50ZXJmYWNlKHJvb3QpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCB0eXBlOiAke3Jvb3QudG9TdHJpbmcoKX1gKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGFzc2VydENsYXNzKHR5cGU6IHJlZmxlY3QuQ2xhc3NUeXBlKTogdm9pZCB7XG4gICAgaWYgKHZpc2l0ZWQuaGFzKHR5cGUuZnFuKSkgeyByZXR1cm47IH1cbiAgICB2aXNpdGVkLmFkZCh0eXBlLmZxbik7XG5cbiAgICBmb3IgKGNvbnN0IG1ldGhvZCBvZiB0eXBlLmFsbE1ldGhvZHMpIHtcbiAgICAgIGFzc2VydE1ldGhvZChtZXRob2QpO1xuICAgIH1cblxuICAgIGlmICh0eXBlLmluaXRpYWxpemVyKSB7XG4gICAgICBhc3NlcnRNZXRob2QodHlwZS5pbml0aWFsaXplcik7XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gYXNzZXJ0RGF0YVR5cGUodHlwZTogcmVmbGVjdC5JbnRlcmZhY2VUeXBlKTogdm9pZCB7XG4gICAgZm9yIChjb25zdCBwcm9wZXJ0eSBvZiB0eXBlLmFsbFByb3BlcnRpZXMpIHtcbiAgICAgIGFzc2VydFByb3BlcnR5KHByb3BlcnR5KTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBhc3NlcnRJbnRlcmZhY2UodHlwZTogcmVmbGVjdC5JbnRlcmZhY2VUeXBlKTogdm9pZCB7XG4gICAgaWYgKHZpc2l0ZWQuaGFzKHR5cGUuZnFuKSkgeyByZXR1cm47IH1cbiAgICB2aXNpdGVkLmFkZCh0eXBlLmZxbik7XG5cbiAgICBpZiAodHlwZS5kYXRhdHlwZSkge1xuICAgICAgYXNzZXJ0RGF0YVR5cGUodHlwZSk7XG4gICAgfVxuXG4gICAgZm9yIChjb25zdCBtZXRob2Qgb2YgdHlwZS5hbGxNZXRob2RzKSB7XG4gICAgICBhc3NlcnRNZXRob2QobWV0aG9kKTtcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBhc3NlcnRQcm9wZXJ0eShwcm9wZXJ0eTogcmVmbGVjdC5Qcm9wZXJ0eSkge1xuICAgIGlmIChwcm9wZXJ0eS5wcm90ZWN0ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzaXRlID0gcHJvcGVydHkub3ZlcnJpZGVzID8gcHJvcGVydHkub3ZlcnJpZGVzIDogcHJvcGVydHkucGFyZW50VHlwZTtcbiAgICBhc3NlcnRUeXBlKHByb3BlcnR5LnR5cGUsIHByb3BlcnR5LmRvY3MsIGAke3NpdGUuZnFufS4ke3Byb3BlcnR5Lm5hbWV9YCk7XG4gIH1cblxuICBmdW5jdGlvbiBhc3NlcnRNZXRob2QobWV0aG9kOiByZWZsZWN0LkNhbGxhYmxlKSB7XG4gICAgaWYgKG1ldGhvZC5wcm90ZWN0ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCBzaXRlID0gbWV0aG9kLm92ZXJyaWRlcyA/IG1ldGhvZC5vdmVycmlkZXMgOiBtZXRob2QucGFyZW50VHlwZTtcbiAgICBjb25zdCBzY29wZSA9IGAke3NpdGUuZnFufS4ke21ldGhvZC5uYW1lfWA7XG5cbiAgICBsZXQgZmlyc3RNZXRob2Q6IHJlZmxlY3QuQ2FsbGFibGUgfCB1bmRlZmluZWQgPSBzaXRlLmlzQ2xhc3NUeXBlKCkgfHwgc2l0ZS5pc0ludGVyZmFjZVR5cGUoKVxuICAgICAgPyBzaXRlLmFsbE1ldGhvZHMuZmluZChtID0+IG0ubmFtZSA9PT0gbWV0aG9kLm5hbWUpXG4gICAgICA6IHVuZGVmaW5lZDtcblxuICAgIGlmICghZmlyc3RNZXRob2QpIHtcbiAgICAgIGZpcnN0TWV0aG9kID0gbWV0aG9kO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgcGFyYW0gb2YgZmlyc3RNZXRob2QucGFyYW1ldGVycykge1xuICAgICAgYXNzZXJ0VHlwZShwYXJhbS50eXBlLCBwYXJhbS5kb2NzLCBgJHtzY29wZX0uJHtwYXJhbS5uYW1lfWApO1xuICAgIH1cblxuICAgIC8vIG5vdGUgdGhhdCB3ZSBkbyBub3QgcmVxdWlyZSB0aGF0IHJldHVybiB2YWx1ZXMgd2lsbCB1c2UgYW4gaW50ZXJmYWNlXG4gIH1cblxuICBmdW5jdGlvbiBhc3NlcnRUeXBlKHR5cGU6IHJlZmxlY3QuVHlwZVJlZmVyZW5jZSwgZG9jczogcmVmbGVjdC5Eb2NzLCBzY29wZTogc3RyaW5nKTogdm9pZCB7XG4gICAgdmlzaXRvci52aXNpdFR5cGUodHlwZSwgZG9jcywgc2NvcGUpO1xuXG4gICAgLy8gQW5kIHJlY3Vyc2VcbiAgICBpZiAodHlwZS5hcnJheU9mVHlwZSkge1xuICAgICAgcmV0dXJuIGFzc2VydFR5cGUodHlwZS5hcnJheU9mVHlwZSwgZG9jcywgc2NvcGUpO1xuICAgIH1cblxuICAgIGlmICh0eXBlLm1hcE9mVHlwZSkge1xuICAgICAgcmV0dXJuIGFzc2VydFR5cGUodHlwZS5tYXBPZlR5cGUsIGRvY3MsIHNjb3BlKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZS51bmlvbk9mVHlwZXMpIHtcbiAgICAgIGZvciAoY29uc3QgdCBvZiB0eXBlLnVuaW9uT2ZUeXBlcykge1xuICAgICAgICBhc3NlcnRUeXBlKHQsIGRvY3MsIHNjb3BlKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBpbnRlcmZhY2VzIGFyZSBva2F5XG4gICAgaWYgKHR5cGUudHlwZSAmJiB0eXBlLnR5cGUuaXNJbnRlcmZhY2VUeXBlKCkpIHtcbiAgICAgIHJldHVybiBhc3NlcnRJbnRlcmZhY2UodHlwZS50eXBlKTtcbiAgICB9XG4gIH1cbn1cblxuaW50ZXJmYWNlIFR5cGVWaXNpdG9yIHtcbiAgdmlzaXRUeXBlKHR5cGU6IHJlZmxlY3QuVHlwZVJlZmVyZW5jZSwgZG9jczogcmVmbGVjdC5Eb2NzLCBzY29wZTogc3RyaW5nKTogdm9pZDtcbn1cbiJdfQ==
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.CoreTypes = void 0;
const util_1 = require("./util");
const CORE_MODULE = 'aws-cdk-lib';
var CoreTypesFqn;
(function (CoreTypesFqn) {
    CoreTypesFqn["CfnResource"] = "aws-cdk-lib.CfnResource";
    CoreTypesFqn["Resource"] = "aws-cdk-lib.Resource";
    CoreTypesFqn["ResourceInterface"] = "aws-cdk-lib.IResource";
    CoreTypesFqn["ResolvableInterface"] = "aws-cdk-lib.IResolvable";
    CoreTypesFqn["PhysicalName"] = "aws-cdk-lib.PhysicalName";
    CoreTypesFqn["Construct"] = "constructs.Construct";
    CoreTypesFqn["ConstructInterface"] = "constructs.IConstruct";
})(CoreTypesFqn || (CoreTypesFqn = {}));
class CoreTypes {
    /**
     * @returns true if assembly has the Core module
     */
    static hasCoreModule(assembly) {
        return (!assembly.system.assemblies.find(a => a.name === CORE_MODULE));
    }
    /**
     * @returns true if `classType` represents an L1 Cfn Resource
     */
    static isCfnResource(c) {
        if (!c.system.includesAssembly(CORE_MODULE)) {
            return false;
        }
        // skip CfnResource itself
        if (c.fqn === CoreTypesFqn.CfnResource) {
            return false;
        }
        if (!this.isConstructClass(c)) {
            return false;
        }
        const cfnResourceClass = c.system.findFqn(CoreTypesFqn.CfnResource);
        if (!c.extends(cfnResourceClass)) {
            return false;
        }
        return c.name.startsWith('Cfn');
    }
    /**
     * @returns true if `classType` represents a Construct
     */
    static isConstructClass(c) {
        if (!c.system.includesAssembly(CORE_MODULE)) {
            return false;
        }
        if (!c.isClassType()) {
            return false;
        }
        if (c.abstract) {
            return false;
        }
        return c.extends(c.system.findFqn(CoreTypesFqn.Construct));
    }
    /**
     * @returns true if `classType` represents an AWS resource (i.e. extends `cdk.Resource`).
     */
    static isResourceClass(classType) {
        const baseResource = classType.system.findClass(CoreTypesFqn.Resource);
        return classType.extends(baseResource) || (0, util_1.getDocTag)(classType, 'resource');
    }
    /**
     * @returns true if `interfaceType` looks like an L2 interface (`IBucket`)
     */
    static isL2Interface(interfaceType) {
        // We determine this by it being a behavioral interface, and it inheriting from `IResource`.
        const baseInterface = interfaceType.system.findInterface(CoreTypesFqn.ResourceInterface);
        return !interfaceType.datatype && interfaceExtends(interfaceType, baseInterface);
    }
    /**
     * @returns true if `interfaceType` looks like an L1 Ref interface (`IBucketRef)`
     */
    static isL1RefInterface(interfaceType) {
        // We determine this by it being a behavioral interface, and it living inside the `aws-cdk-lib.interfaces` namespace
        // with a name ending in `Ref`.
        return !interfaceType.datatype && interfaceType.fqn.startsWith('aws-cdk-lib.interfaces.') && interfaceType.name.endsWith('Ref');
    }
    /**
     * Return true if the nesting parent of the given interface is a CFN class
     */
    static isCfnNestedType(interfaceType) {
        return interfaceType.nestingParent && CoreTypes.isCfnType(interfaceType.nestingParent);
    }
    /**
     * Return true if the given interface type is a CFN class, prop type or interface
     */
    static isCfnType(interfaceType) {
        // aws_service.CfnTheResource
        if (interfaceType.name.startsWith('Cfn')) {
            return true;
        }
        // aws_service.ITheResourceRf
        if (/^I\w+Ref/.test(interfaceType.name)) {
            return true;
        }
        if (interfaceType.namespace) {
            if (interfaceType.namespace.startsWith('Cfn')) {
                return true;
            }
            const namespaceParts = interfaceType.namespace.split('.');
            // aws_service.CfnTheResource.SubType
            if (namespaceParts.at(1)?.startsWith('Cfn')) {
                return true;
            }
            // aws_service.mixins.CfnTheResource.SubType
            if (namespaceParts.at(1) === 'mixins' && namespaceParts.at(2)?.startsWith('Cfn')) {
                return true;
            }
        }
        return false;
    }
    /**
     * @returns `classType` for the core type Construct
     * @deprecated - use `baseConstructClass()`
     */
    get constructClass() {
        return this.baseConstructClass;
    }
    /**
     * @returns `classType` for the core type Construct
     */
    get baseConstructClass() {
        return this.sys.findClass(this.baseConstructClassFqn);
    }
    /**
     * @returns `classType` for the core type Construct
     */
    get baseConstructClassFqn() {
        return CoreTypesFqn.Construct;
    }
    /**
     * @returns `interfacetype` for the core type Construct
     * @deprecated - use `baseConstructInterface()`
     */
    get constructInterface() {
        return this.baseConstructInterface;
    }
    /**
     * @returns `interfacetype` for the core type Construct
     */
    get baseConstructInterface() {
        return this.sys.findInterface(this.baseConstructInterfaceFqn);
    }
    /**
     * @returns fqn for for the core Construct interface
     */
    get baseConstructInterfaceFqn() {
        return CoreTypesFqn.ConstructInterface;
    }
    /**
     * @returns `classType` for the core type Resource
     */
    get resourceClass() {
        return this.sys.findClass(this.resourceClassFqn);
    }
    /**
     * @returns fqn for the core type Resource
     */
    get resourceClassFqn() {
        return CoreTypesFqn.Resource;
    }
    /**
     * @returns fqn for the core Resource interface
     */
    get resourceInterface() {
        return this.sys.findInterface(this.resourceInterfaceFqn);
    }
    /**
     * @returns `interfaceType` for the core type Resource
     */
    get resourceInterfaceFqn() {
        return CoreTypesFqn.ResourceInterface;
    }
    /**
     * @returns `classType` for the core type Token
     */
    get tokenInterface() {
        return this.sys.findInterface(this.tokenInterfaceFqn);
    }
    /**
     * @returns fqn for the core type Token
     */
    get tokenInterfaceFqn() {
        return CoreTypesFqn.ResolvableInterface;
    }
    get physicalNameClass() {
        return this.sys.findClass(CoreTypesFqn.PhysicalName);
    }
    sys;
    constructor(sys) {
        this.sys = sys;
        if (!sys.includesAssembly(CORE_MODULE)) {
            // disable-all-checks
            return;
        }
    }
}
exports.CoreTypes = CoreTypes;
function interfaceExtends(interfaceType, baseInterface) {
    return interfaceType.getInterfaces(true).some(i => i.fqn === baseInterface.fqn);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29yZS10eXBlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImNvcmUtdHlwZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsaUNBQW1DO0FBRW5DLE1BQU0sV0FBVyxHQUFHLGFBQWEsQ0FBQztBQUNsQyxJQUFLLFlBU0o7QUFURCxXQUFLLFlBQVk7SUFDZix1REFBdUMsQ0FBQTtJQUN2QyxpREFBaUMsQ0FBQTtJQUNqQywyREFBMkMsQ0FBQTtJQUMzQywrREFBK0MsQ0FBQTtJQUMvQyx5REFBeUMsQ0FBQTtJQUV6QyxrREFBa0MsQ0FBQTtJQUNsQyw0REFBNEMsQ0FBQTtBQUM5QyxDQUFDLEVBVEksWUFBWSxLQUFaLFlBQVksUUFTaEI7QUFFRCxNQUFhLFNBQVM7SUFDcEI7O09BRUc7SUFDSSxNQUFNLENBQUMsYUFBYSxDQUFDLFFBQTBCO1FBQ3BELE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLEtBQUssV0FBVyxDQUFDLENBQUMsQ0FBQztJQUN6RSxDQUFDO0lBRUQ7O09BRUc7SUFDSSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQW9CO1FBQzlDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsQ0FBQyxFQUFFLENBQUM7WUFDNUMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsMEJBQTBCO1FBQzFCLElBQUksQ0FBQyxDQUFDLEdBQUcsS0FBSyxZQUFZLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDdkMsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO1lBQzlCLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxDQUFDLE1BQU0sQ0FB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QUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyByZWZsZWN0IGZyb20gJ2pzaWktcmVmbGVjdCc7XG5pbXBvcnQgeyBnZXREb2NUYWcgfSBmcm9tICcuL3V0aWwnO1xuXG5jb25zdCBDT1JFX01PRFVMRSA9ICdhd3MtY2RrLWxpYic7XG5lbnVtIENvcmVUeXBlc0ZxbiB7XG4gIENmblJlc291cmNlID0gJ2F3cy1jZGstbGliLkNmblJlc291cmNlJyxcbiAgUmVzb3VyY2UgPSAnYXdzLWNkay1saWIuUmVzb3VyY2UnLFxuICBSZXNvdXJjZUludGVyZmFjZSA9ICdhd3MtY2RrLWxpYi5JUmVzb3VyY2UnLFxuICBSZXNvbHZhYmxlSW50ZXJmYWNlID0gJ2F3cy1jZGstbGliLklSZXNvbHZhYmxlJyxcbiAgUGh5c2ljYWxOYW1lID0gJ2F3cy1jZGstbGliLlBoeXNpY2FsTmFtZScsXG5cbiAgQ29uc3RydWN0ID0gJ2NvbnN0cnVjdHMuQ29uc3RydWN0JyxcbiAgQ29uc3RydWN0SW50ZXJmYWNlID0gJ2NvbnN0cnVjdHMuSUNvbnN0cnVjdCcsXG59XG5cbmV4cG9ydCBjbGFzcyBDb3JlVHlwZXMge1xuICAvKipcbiAgICogQHJldHVybnMgdHJ1ZSBpZiBhc3NlbWJseSBoYXMgdGhlIENvcmUgbW9kdWxlXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGhhc0NvcmVNb2R1bGUoYXNzZW1ibHk6IHJlZmxlY3QuQXNzZW1ibHkpIHtcbiAgICByZXR1cm4gKCFhc3NlbWJseS5zeXN0ZW0uYXNzZW1ibGllcy5maW5kKGEgPT4gYS5uYW1lID09PSBDT1JFX01PRFVMRSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHRydWUgaWYgYGNsYXNzVHlwZWAgcmVwcmVzZW50cyBhbiBMMSBDZm4gUmVzb3VyY2VcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgaXNDZm5SZXNvdXJjZShjOiByZWZsZWN0LkNsYXNzVHlwZSkge1xuICAgIGlmICghYy5zeXN0ZW0uaW5jbHVkZXNBc3NlbWJseShDT1JFX01PRFVMRSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBza2lwIENmblJlc291cmNlIGl0c2VsZlxuICAgIGlmIChjLmZxbiA9PT0gQ29yZVR5cGVzRnFuLkNmblJlc291cmNlKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLmlzQ29uc3RydWN0Q2xhc3MoYykpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBjZm5SZXNvdXJjZUNsYXNzID0gYy5zeXN0ZW0uZmluZEZxbihDb3JlVHlwZXNGcW4uQ2ZuUmVzb3VyY2UpO1xuICAgIGlmICghYy5leHRlbmRzKGNmblJlc291cmNlQ2xhc3MpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIGMubmFtZS5zdGFydHNXaXRoKCdDZm4nKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB0cnVlIGlmIGBjbGFzc1R5cGVgIHJlcHJlc2VudHMgYSBDb25zdHJ1Y3RcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgaXNDb25zdHJ1Y3RDbGFzcyhjOiByZWZsZWN0LkNsYXNzVHlwZSkge1xuICAgIGlmICghYy5zeXN0ZW0uaW5jbHVkZXNBc3NlbWJseShDT1JFX01PRFVMRSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBpZiAoIWMuaXNDbGFzc1R5cGUoKSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGlmIChjLmFic3RyYWN0KSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIGMuZXh0ZW5kcyhjLnN5c3RlbS5maW5kRnFuKENvcmVUeXBlc0Zxbi5Db25zdHJ1Y3QpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyB0cnVlIGlmIGBjbGFzc1R5cGVgIHJlcHJlc2VudHMgYW4gQVdTIHJlc291cmNlIChpLmUuIGV4dGVuZHMgYGNkay5SZXNvdXJjZWApLlxuICAgKi9cbiAgcHVibGljIHN0YXRpYyBpc1Jlc291cmNlQ2xhc3MoY2xhc3NUeXBlOiByZWZsZWN0LkNsYXNzVHlwZSkge1xuICAgIGNvbnN0IGJhc2VSZXNvdXJjZSA9IGNsYXNzVHlwZS5zeXN0ZW0uZmluZENsYXNzKENvcmVUeXBlc0Zxbi5SZXNvdXJjZSk7XG4gICAgcmV0dXJuIGNsYXNzVHlwZS5leHRlbmRzKGJhc2VSZXNvdXJjZSkgfHwgZ2V0RG9jVGFnKGNsYXNzVHlwZSwgJ3Jlc291cmNlJyk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgdHJ1ZSBpZiBgaW50ZXJmYWNlVHlwZWAgbG9va3MgbGlrZSBhbiBMMiBpbnRlcmZhY2UgKGBJQnVja2V0YClcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgaXNMMkludGVyZmFjZShpbnRlcmZhY2VUeXBlOiByZWZsZWN0LkludGVyZmFjZVR5cGUpIHtcbiAgICAvLyBXZSBkZXRlcm1pbmUgdGhpcyBieSBpdCBiZWluZyBhIGJlaGF2aW9yYWwgaW50ZXJmYWNlLCBhbmQgaXQgaW5oZXJpdGluZyBmcm9tIGBJUmVzb3VyY2VgLlxuICAgIGNvbnN0IGJhc2VJbnRlcmZhY2UgPSBpbnRlcmZhY2VUeXBlLnN5c3RlbS5maW5kSW50ZXJmYWNlKENvcmVUeXBlc0Zxbi5SZXNvdXJjZUludGVyZmFjZSk7XG4gICAgcmV0dXJuICFpbnRlcmZhY2VUeXBlLmRhdGF0eXBlICYmIGludGVyZmFjZUV4dGVuZHMoaW50ZXJmYWNlVHlwZSwgYmFzZUludGVyZmFjZSk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgdHJ1ZSBpZiBgaW50ZXJmYWNlVHlwZWAgbG9va3MgbGlrZSBhbiBMMSBSZWYgaW50ZXJmYWNlIChgSUJ1Y2tldFJlZilgXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGlzTDFSZWZJbnRlcmZhY2UoaW50ZXJmYWNlVHlwZTogcmVmbGVjdC5JbnRlcmZhY2VUeXBlKSB7XG4gICAgLy8gV2UgZGV0ZXJtaW5lIHRoaXMgYnkgaXQgYmVpbmcgYSBiZWhhdmlvcmFsIGludGVyZmFjZSwgYW5kIGl0IGxpdmluZyBpbnNpZGUgdGhlIGBhd3MtY2RrLWxpYi5pbnRlcmZhY2VzYCBuYW1lc3BhY2VcbiAgICAvLyB3aXRoIGEgbmFtZSBlbmRpbmcgaW4gYFJlZmAuXG4gICAgcmV0dXJuICFpbnRlcmZhY2VUeXBlLmRhdGF0eXBlICYmIGludGVyZmFjZVR5cGUuZnFuLnN0YXJ0c1dpdGgoJ2F3cy1jZGstbGliLmludGVyZmFjZXMuJykgJiYgaW50ZXJmYWNlVHlwZS5uYW1lLmVuZHNXaXRoKCdSZWYnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gdHJ1ZSBpZiB0aGUgbmVzdGluZyBwYXJlbnQgb2YgdGhlIGdpdmVuIGludGVyZmFjZSBpcyBhIENGTiBjbGFzc1xuICAgKi9cbiAgcHVibGljIHN0YXRpYyBpc0Nmbk5lc3RlZFR5cGUoaW50ZXJmYWNlVHlwZTogcmVmbGVjdC5UeXBlKSB7XG4gICAgcmV0dXJuIGludGVyZmFjZVR5cGUubmVzdGluZ1BhcmVudCAmJiBDb3JlVHlwZXMuaXNDZm5UeXBlKGludGVyZmFjZVR5cGUubmVzdGluZ1BhcmVudCk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIHRydWUgaWYgdGhlIGdpdmVuIGludGVyZmFjZSB0eXBlIGlzIGEgQ0ZOIGNsYXNzLCBwcm9wIHR5cGUgb3IgaW50ZXJmYWNlXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGlzQ2ZuVHlwZShpbnRlcmZhY2VUeXBlOiByZWZsZWN0LlR5cGUpOiBib29sZWFuIHtcbiAgICAvLyBhd3Nfc2VydmljZS5DZm5UaGVSZXNvdXJjZVxuICAgIGlmIChpbnRlcmZhY2VUeXBlLm5hbWUuc3RhcnRzV2l0aCgnQ2ZuJykpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIGF3c19zZXJ2aWNlLklUaGVSZXNvdXJjZVJmXG4gICAgaWYgKC9eSVxcdytSZWYvLnRlc3QoaW50ZXJmYWNlVHlwZS5uYW1lKSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgaWYgKGludGVyZmFjZVR5cGUubmFtZXNwYWNlKSB7XG4gICAgICBpZiAoaW50ZXJmYWNlVHlwZS5uYW1lc3BhY2Uuc3RhcnRzV2l0aCgnQ2ZuJykpIHtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IG5hbWVzcGFjZVBhcnRzID0gaW50ZXJmYWNlVHlwZS5uYW1lc3BhY2Uuc3BsaXQoJy4nKTtcblxuICAgICAgLy8gYXdzX3NlcnZpY2UuQ2ZuVGhlUmVzb3VyY2UuU3ViVHlwZVxuICAgICAgaWYgKG5hbWVzcGFjZVBhcnRzLmF0KDEpPy5zdGFydHNXaXRoKCdDZm4nKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgLy8gYXdzX3NlcnZpY2UubWl4aW5zLkNmblRoZVJlc291cmNlLlN1YlR5cGVcbiAgICAgIGlmIChuYW1lc3BhY2VQYXJ0cy5hdCgxKSA9PT0gJ21peGlucycgJiYgbmFtZXNwYWNlUGFydHMuYXQoMik/LnN0YXJ0c1dpdGgoJ0NmbicpKSB7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyBgY2xhc3NUeXBlYCBmb3IgdGhlIGNvcmUgdHlwZSBDb25zdHJ1Y3RcbiAgICogQGRlcHJlY2F0ZWQgLSB1c2UgYGJhc2VDb25zdHJ1Y3RDbGFzcygpYFxuICAgKi9cbiAgcHVibGljIGdldCBjb25zdHJ1Y3RDbGFzcygpIHtcbiAgICByZXR1cm4gdGhpcy5iYXNlQ29uc3RydWN0Q2xhc3M7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgYGNsYXNzVHlwZWAgZm9yIHRoZSBjb3JlIHR5cGUgQ29uc3RydWN0XG4gICAqL1xuICBwdWJsaWMgZ2V0IGJhc2VDb25zdHJ1Y3RDbGFzcygpIHtcbiAgICByZXR1cm4gdGhpcy5zeXMuZmluZENsYXNzKHRoaXMuYmFzZUNvbnN0cnVjdENsYXNzRnFuKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcmV0dXJucyBgY2xhc3NUeXBlYCBmb3IgdGhlIGNvcmUgdHlwZSBDb25zdHJ1Y3RcbiAgICovXG4gIHB1YmxpYyBnZXQgYmFzZUNvbnN0cnVjdENsYXNzRnFuKCkge1xuICAgIHJldHVybiBDb3JlVHlwZXNGcW4uQ29uc3RydWN0O1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIGBpbnRlcmZhY2V0eXBlYCBmb3IgdGhlIGNvcmUgdHlwZSBDb25zdHJ1Y3RcbiAgICogQGRlcHJlY2F0ZWQgLSB1c2UgYGJhc2VDb25zdHJ1Y3RJbnRlcmZhY2UoKWBcbiAgICovXG4gIHB1YmxpYyBnZXQgY29uc3RydWN0SW50ZXJmYWNlKCkge1xuICAgIHJldHVybiB0aGlzLmJhc2VDb25zdHJ1Y3RJbnRlcmZhY2U7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgYGludGVyZmFjZXR5cGVgIGZvciB0aGUgY29yZSB0eXBlIENvbnN0cnVjdFxuICAgKi9cbiAgcHVibGljIGdldCBiYXNlQ29uc3RydWN0SW50ZXJmYWNlKCkge1xuICAgIHJldHVybiB0aGlzLnN5cy5maW5kSW50ZXJmYWNlKHRoaXMuYmFzZUNvbnN0cnVjdEludGVyZmFjZUZxbik7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgZnFuIGZvciBmb3IgdGhlIGNvcmUgQ29uc3RydWN0IGludGVyZmFjZVxuICAgKi9cbiAgcHVibGljIGdldCBiYXNlQ29uc3RydWN0SW50ZXJmYWNlRnFuKCkge1xuICAgIHJldHVybiBDb3JlVHlwZXNGcW4uQ29uc3RydWN0SW50ZXJmYWNlO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIGBjbGFzc1R5cGVgIGZvciB0aGUgY29yZSB0eXBlIFJlc291cmNlXG4gICAqL1xuICBwdWJsaWMgZ2V0IHJlc291cmNlQ2xhc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3lzLmZpbmRDbGFzcyh0aGlzLnJlc291cmNlQ2xhc3NGcW4pO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIGZxbiBmb3IgdGhlIGNvcmUgdHlwZSBSZXNvdXJjZVxuICAgKi9cbiAgcHVibGljIGdldCByZXNvdXJjZUNsYXNzRnFuKCkge1xuICAgIHJldHVybiBDb3JlVHlwZXNGcW4uUmVzb3VyY2U7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgZnFuIGZvciB0aGUgY29yZSBSZXNvdXJjZSBpbnRlcmZhY2VcbiAgICovXG4gIHB1YmxpYyBnZXQgcmVzb3VyY2VJbnRlcmZhY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3lzLmZpbmRJbnRlcmZhY2UodGhpcy5yZXNvdXJjZUludGVyZmFjZUZxbik7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgYGludGVyZmFjZVR5cGVgIGZvciB0aGUgY29yZSB0eXBlIFJlc291cmNlXG4gICAqL1xuICBwdWJsaWMgZ2V0IHJlc291cmNlSW50ZXJmYWNlRnFuKCkge1xuICAgIHJldHVybiBDb3JlVHlwZXNGcW4uUmVzb3VyY2VJbnRlcmZhY2U7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgYGNsYXNzVHlwZWAgZm9yIHRoZSBjb3JlIHR5cGUgVG9rZW5cbiAgICovXG4gIHB1YmxpYyBnZXQgdG9rZW5JbnRlcmZhY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3lzLmZpbmRJbnRlcmZhY2UodGhpcy50b2tlbkludGVyZmFjZUZxbik7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMgZnFuIGZvciB0aGUgY29yZSB0eXBlIFRva2VuXG4gICAqL1xuICBwdWJsaWMgZ2V0IHRva2VuSW50ZXJmYWNlRnFuKCkge1xuICAgIHJldHVybiBDb3JlVHlwZXNGcW4uUmVzb2x2YWJsZUludGVyZmFjZTtcbiAgfVxuXG4gIHB1YmxpYyBnZXQgcGh5c2ljYWxOYW1lQ2xhc3MoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3lzLmZpbmRDbGFzcyhDb3JlVHlwZXNGcW4uUGh5c2ljYWxOYW1lKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVhZG9ubHkgc3lzOiByZWZsZWN0LlR5cGVTeXN0ZW07XG5cbiAgY29uc3RydWN0b3Ioc3lzOiByZWZsZWN0LlR5cGVTeXN0ZW0pIHtcbiAgICB0aGlzLnN5cyA9IHN5cztcbiAgICBpZiAoIXN5cy5pbmNsdWRlc0Fzc2VtYmx5KENPUkVfTU9EVUxFKSkge1xuICAgICAgLy8gZGlzYWJsZS1hbGwtY2hlY2tzXG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGludGVyZmFjZUV4dGVuZHMoaW50ZXJmYWNlVHlwZTogcmVmbGVjdC5JbnRlcmZhY2VUeXBlLCBiYXNlSW50ZXJmYWNlOiByZWZsZWN0LkludGVyZmFjZVR5cGUpIHtcbiAgcmV0dXJuIGludGVyZmFjZVR5cGUuZ2V0SW50ZXJmYWNlcyh0cnVlKS5zb21lKGkgPT4gaS5mcW4gPT09IGJhc2VJbnRlcmZhY2UuZnFuKTtcbn1cbiJdfQ==
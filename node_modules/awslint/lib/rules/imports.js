"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.importsLinter = void 0;
const resource_1 = require("./resource");
const linter_1 = require("../linter");
exports.importsLinter = new linter_1.Linter(assembly => resource_1.ResourceReflection
    .findAll(assembly)
    .filter(r => r.construct && r.construct.interfaceType) // only resources that have an interface can have "fromXxx" methods
    .map(construct => new ImportsReflection(construct)));
class ImportsReflection {
    resource;
    fromMethods;
    prefix;
    fromAttributesMethodName;
    fromAttributesMethod;
    attributesStructName;
    attributesStruct;
    constructor(resource) {
        this.resource = resource;
        const sys = resource.sys;
        this.prefix = `from${resource.basename}`;
        const classType = resource.construct.classType;
        this.fromAttributesMethodName = `${this.prefix}Attributes`;
        this.fromAttributesMethod = classType.allMethods.find(x => x.name === this.fromAttributesMethodName);
        this.fromMethods = classType.allMethods.filter(x => x.static
            && x.name.match(`^${this.prefix}[A-Z]`)
            && x.name !== this.fromAttributesMethodName);
        const attributesStructFqn = `${classType.fqn}Attributes`;
        const attributesStruct = sys.tryFindFqn(attributesStructFqn);
        if (attributesStruct) {
            if (!attributesStruct.isInterfaceType() || !attributesStruct.isDataType()) {
                throw new Error(`Attributes type ${attributesStructFqn} must be an interface struct`);
            }
        }
        this.attributesStructName = attributesStructFqn;
        this.attributesStruct = attributesStruct;
    }
}
exports.importsLinter.add({
    code: 'no-static-import',
    message: 'static "import" methods are deprecated in favor of "fromAttributes" (see guidelines)',
    eval: e => {
        const hasImport = e.ctx.resource.construct.classType.allMethods.find(x => x.static && x.name === 'import');
        e.assert(!hasImport, e.ctx.resource.fqn + '.import');
    },
});
exports.importsLinter.add({
    code: 'from-method',
    message: 'resource should have at least one "fromXxx" static method or "fromXxxAttributes"',
    eval: e => {
        // no attributes are defined on the interface, so we don't expect any "from" methods.
        if (!e.ctx.resource.attributes.some(a => a.site === resource_1.AttributeSite.Interface)) {
            return;
        }
        e.assert(e.ctx.fromMethods.length > 0 || e.ctx.fromAttributesMethod, e.ctx.resource.fqn);
    },
});
exports.importsLinter.add({
    code: 'from-signature',
    message: 'invalid method signature for fromXxx method. ' + baseConstructAddendum(),
    eval: e => {
        for (const method of e.ctx.fromMethods) {
            // "fromRoleArn" => "roleArn"
            const argName = e.ctx.resource.basename[0].toLocaleLowerCase() + method.name.slice('from'.length + 1);
            const baseType = e.ctx.resource.core.baseConstructClass;
            e.assertSignature(method, {
                parameters: [
                    { name: 'scope', type: baseType },
                    { name: 'id', type: 'string' },
                    { name: argName, type: 'string' },
                ],
                returns: e.ctx.resource.construct.interfaceType,
            });
        }
    },
});
exports.importsLinter.add({
    code: 'from-attributes',
    message: 'static fromXxxAttributes is a factory of IXxx from its primitive attributes. ' + baseConstructAddendum(),
    eval: e => {
        if (!e.ctx.fromAttributesMethod) {
            return;
        }
        const baseType = e.ctx.resource.core.baseConstructClass;
        e.assertSignature(e.ctx.fromAttributesMethod, {
            parameters: [
                { name: 'scope', type: baseType },
                { name: 'id', type: 'string' },
                { name: 'attrs', type: e.ctx.attributesStruct },
            ],
        });
    },
});
exports.importsLinter.add({
    code: 'from-attributes-struct',
    message: 'resource should have an XxxAttributes struct',
    eval: e => {
        if (!e.ctx.fromAttributesMethod) {
            return; // no "fromAttributes" method
        }
        e.assert(e.ctx.attributesStruct, e.ctx.attributesStructName);
    },
});
function baseConstructAddendum() {
    if (!process.env.AWSLINT_BASE_CONSTRUCT) {
        return 'If the construct is using the "constructs" module, set the environment variable "AWSLINT_BASE_CONSTRUCT" and re-run';
    }
    return '';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1wb3J0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImltcG9ydHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EseUNBQStEO0FBQy9ELHNDQUFtQztBQUV0QixRQUFBLGFBQWEsR0FBRyxJQUFJLGVBQU0sQ0FBb0IsUUFBUSxDQUFDLEVBQUUsQ0FBQyw2QkFBa0I7S0FDdEYsT0FBTyxDQUFDLFFBQVEsQ0FBQztLQUNqQixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUMsYUFBYSxDQUFDLENBQUMsbUVBQW1FO0tBQ3pILEdBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDLElBQUksaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRXZELE1BQU0saUJBQWlCO0lBUU87SUFQWixXQUFXLENBQW1CO0lBQzlCLE1BQU0sQ0FBUztJQUNmLHdCQUF3QixDQUFTO0lBQ2pDLG9CQUFvQixDQUFrQjtJQUN0QyxvQkFBb0IsQ0FBUztJQUM3QixnQkFBZ0IsQ0FBeUI7SUFFekQsWUFBNEIsUUFBNEI7UUFBNUIsYUFBUSxHQUFSLFFBQVEsQ0FBb0I7UUFDdEQsTUFBTSxHQUFHLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQztRQUN6QixJQUFJLENBQUMsTUFBTSxHQUFHLE9BQU8sUUFBUSxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBQ3pDLE1BQU0sU0FBUyxHQUFHLFFBQVEsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDO1FBQy9DLElBQUksQ0FBQyx3QkFBd0IsR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLFlBQVksQ0FBQztRQUMzRCxJQUFJLENBQUMsb0JBQW9CLEdBQUcsU0FBUyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyx3QkFBd0IsQ0FBQyxDQUFDO1FBRXJH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LEVBQUU7YUFDaEQ7U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0YsQ0FBQyxDQUFDO0FBRUgscUJBQWEsQ0FBQyxHQUFHLENBQUM7SUFDaEIsSUFBSSxFQUFFLHdCQUF3QjtJQUM5QixPQUFPLEVBQUUsOENBQThDO0lBQ3ZELElBQUksRUFBRSxDQUFDLENBQUMsRUFBRTtRQUNSLElBQUksQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLG9CQUFvQixFQUFFLENBQUM7WUFDaEMsT0FBTyxDQUFDLDZCQUE2QjtRQUN2QyxDQUFDO1FBRUQsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxHQUFHLENBQUMsb0JBQW9CLENBQUMsQ0FBQztJQUMvRCxDQUFDO0NBQ0YsQ0FBQyxDQUFDO0FBRUgsU0FBUyxxQkFBcUI7SUFDNUIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUN4QyxPQUFPLHFIQUFxSCxDQUFDO0lBQy9ILENBQUM7SUFDRCxPQUFPLEVBQUUsQ0FBQztBQUNaLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyByZWZsZWN0IGZyb20gJ2pzaWktcmVmbGVjdCc7XG5pbXBvcnQgeyBBdHRyaWJ1dGVTaXRlLCBSZXNvdXJjZVJlZmxlY3Rpb24gfSBmcm9tICcuL3Jlc291cmNlJztcbmltcG9ydCB7IExpbnRlciB9IGZyb20gJy4uL2xpbnRlcic7XG5cbmV4cG9ydCBjb25zdCBpbXBvcnRzTGludGVyID0gbmV3IExpbnRlcjxJbXBvcnRzUmVmbGVjdGlvbj4oYXNzZW1ibHkgPT4gUmVzb3VyY2VSZWZsZWN0aW9uXG4gIC5maW5kQWxsKGFzc2VtYmx5KVxuICAuZmlsdGVyKHIgPT4gci5jb25zdHJ1Y3QgJiYgci5jb25zdHJ1Y3QuaW50ZXJmYWNlVHlwZSkgLy8gb25seSByZXNvdXJjZXMgdGhhdCBoYXZlIGFuIGludGVyZmFjZSBjYW4gaGF2ZSBcImZyb21YeHhcIiBtZXRob2RzXG4gIC5tYXAoY29uc3RydWN0ID0+IG5ldyBJbXBvcnRzUmVmbGVjdGlvbihjb25zdHJ1Y3QpKSk7XG5cbmNsYXNzIEltcG9ydHNSZWZsZWN0aW9uIHtcbiAgcHVibGljIHJlYWRvbmx5IGZyb21NZXRob2RzOiByZWZsZWN0Lk1ldGhvZFtdO1xuICBwdWJsaWMgcmVhZG9ubHkgcHJlZml4OiBzdHJpbmc7XG4gIHB1YmxpYyByZWFkb25seSBmcm9tQXR0cmlidXRlc01ldGhvZE5hbWU6IHN0cmluZztcbiAgcHVibGljIHJlYWRvbmx5IGZyb21BdHRyaWJ1dGVzTWV0aG9kPzogcmVmbGVjdC5NZXRob2Q7XG4gIHB1YmxpYyByZWFkb25seSBhdHRyaWJ1dGVzU3RydWN0TmFtZTogc3RyaW5nO1xuICBwdWJsaWMgcmVhZG9ubHkgYXR0cmlidXRlc1N0cnVjdD86IHJlZmxlY3QuSW50ZXJmYWNlVHlwZTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgcmVzb3VyY2U6IFJlc291cmNlUmVmbGVjdGlvbikge1xuICAgIGNvbnN0IHN5cyA9IHJlc291cmNlLnN5cztcbiAgICB0aGlzLnByZWZpeCA9IGBmcm9tJHtyZXNvdXJjZS5iYXNlbmFtZX1gO1xuICAgIGNvbnN0IGNsYXNzVHlwZSA9IHJlc291cmNlLmNvbnN0cnVjdC5jbGFzc1R5cGU7XG4gICAgdGhpcy5mcm9tQXR0cmlidXRlc01ldGhvZE5hbWUgPSBgJHt0aGlzLnByZWZpeH1BdHRyaWJ1dGVzYDtcbiAgICB0aGlzLmZyb21BdHRyaWJ1dGVzTWV0aG9kID0gY2xhc3NUeXBlLmFsbE1ldGhvZHMuZmluZCh4ID0+IHgubmFtZSA9PT0gdGhpcy5mcm9tQXR0cmlidXRlc01ldGhvZE5hbWUpO1xuXG4gICAgdGhpcy5mcm9tTWV0aG9kcyA9IGNsYXNzVHlwZS5hbGxNZXRob2RzLmZpbHRlcih4ID0+XG4gICAgICB4LnN0YXRpY1xuICAgICAgICAmJiB4Lm5hbWUubWF0Y2goYF4ke3RoaXMucHJlZml4fVtBLVpdYClcbiAgICAgICAgJiYgeC5uYW1lICE9PSB0aGlzLmZyb21BdHRyaWJ1dGVzTWV0aG9kTmFtZSk7XG5cbiAgICBjb25zdCBhdHRyaWJ1dGVzU3RydWN0RnFuID0gYCR7Y2xhc3NUeXBlLmZxbn1BdHRyaWJ1dGVzYDtcbiAgICBjb25zdCBhdHRyaWJ1dGVzU3RydWN0ID0gc3lzLnRyeUZpbmRGcW4oYXR0cmlidXRlc1N0cnVjdEZxbik7XG4gICAgaWYgKGF0dHJpYnV0ZXNTdHJ1Y3QpIHtcbiAgICAgIGlmICghYXR0cmlidXRlc1N0cnVjdC5pc0ludGVyZmFjZVR5cGUoKSB8fCAhYXR0cmlidXRlc1N0cnVjdC5pc0RhdGFUeXBlKCkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBBdHRyaWJ1dGVzIHR5cGUgJHthdHRyaWJ1dGVzU3RydWN0RnFufSBtdXN0IGJlIGFuIGludGVyZmFjZSBzdHJ1Y3RgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5hdHRyaWJ1dGVzU3RydWN0TmFtZSA9IGF0dHJpYnV0ZXNTdHJ1Y3RGcW47XG4gICAgdGhpcy5hdHRyaWJ1dGVzU3RydWN0ID0gYXR0cmlidXRlc1N0cnVjdDtcbiAgfVxufVxuXG5pbXBvcnRzTGludGVyLmFkZCh7XG4gIGNvZGU6ICduby1zdGF0aWMtaW1wb3J0JyxcbiAgbWVzc2FnZTogJ3N0YXRpYyBcImltcG9ydFwiIG1ldGhvZHMgYXJlIGRlcHJlY2F0ZWQgaW4gZmF2b3Igb2YgXCJmcm9tQXR0cmlidXRlc1wiIChzZWUgZ3VpZGVsaW5lcyknLFxuICBldmFsOiBlID0+IHtcbiAgICBjb25zdCBoYXNJbXBvcnQgPSBlLmN0eC5yZXNvdXJjZS5jb25zdHJ1Y3QuY2xhc3NUeXBlLmFsbE1ldGhvZHMuZmluZCh4ID0+IHguc3RhdGljICYmIHgubmFtZSA9PT0gJ2ltcG9ydCcpO1xuICAgIGUuYXNzZXJ0KCFoYXNJbXBvcnQsIGUuY3R4LnJlc291cmNlLmZxbiArICcuaW1wb3J0Jyk7XG4gIH0sXG59KTtcblxuaW1wb3J0c0xpbnRlci5hZGQoe1xuICBjb2RlOiAnZnJvbS1tZXRob2QnLFxuICBtZXNzYWdlOiAncmVzb3VyY2Ugc2hvdWxkIGhhdmUgYXQgbGVhc3Qgb25lIFwiZnJvbVh4eFwiIHN0YXRpYyBtZXRob2Qgb3IgXCJmcm9tWHh4QXR0cmlidXRlc1wiJyxcbiAgZXZhbDogZSA9PiB7XG4gICAgLy8gbm8gYXR0cmlidXRlcyBhcmUgZGVmaW5lZCBvbiB0aGUgaW50ZXJmYWNlLCBzbyB3ZSBkb24ndCBleHBlY3QgYW55IFwiZnJvbVwiIG1ldGhvZHMuXG4gICAgaWYgKCFlLmN0eC5yZXNvdXJjZS5hdHRyaWJ1dGVzLnNvbWUoYSA9PiBhLnNpdGUgPT09IEF0dHJpYnV0ZVNpdGUuSW50ZXJmYWNlKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGUuYXNzZXJ0KGUuY3R4LmZyb21NZXRob2RzLmxlbmd0aCA+IDAgfHwgZS5jdHguZnJvbUF0dHJpYnV0ZXNNZXRob2QsIGUuY3R4LnJlc291cmNlLmZxbik7XG4gIH0sXG59KTtcblxuaW1wb3J0c0xpbnRlci5hZGQoe1xuICBjb2RlOiAnZnJvbS1zaWduYXR1cmUnLFxuICBtZXNzYWdlOiAnaW52YWxpZCBtZXRob2Qgc2lnbmF0dXJlIGZvciBmcm9tWHh4IG1ldGhvZC4gJyArIGJhc2VDb25zdHJ1Y3RBZGRlbmR1bSgpLFxuICBldmFsOiBlID0+IHtcbiAgICBmb3IgKGNvbnN0IG1ldGhvZCBvZiBlLmN0eC5mcm9tTWV0aG9kcykge1xuICAgICAgLy8gXCJmcm9tUm9sZUFyblwiID0+IFwicm9sZUFyblwiXG4gICAgICBjb25zdCBhcmdOYW1lID0gZS5jdHgucmVzb3VyY2UuYmFzZW5hbWVbMF0udG9Mb2NhbGVMb3dlckNhc2UoKSArIG1ldGhvZC5uYW1lLnNsaWNlKCdmcm9tJy5sZW5ndGggKyAxKTtcblxuICAgICAgY29uc3QgYmFzZVR5cGUgPSBlLmN0eC5yZXNvdXJjZS5jb3JlLmJhc2VDb25zdHJ1Y3RDbGFzcztcbiAgICAgIGUuYXNzZXJ0U2lnbmF0dXJlKG1ldGhvZCwge1xuICAgICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgICAgICAgeyBuYW1lOiAnc2NvcGUnLCB0eXBlOiBiYXNlVHlwZSB9LFxuICAgICAgICAgIHsgbmFtZTogJ2lkJywgdHlwZTogJ3N0cmluZycgfSxcbiAgICAgICAgICB7IG5hbWU6IGFyZ05hbWUsIHR5cGU6ICdzdHJpbmcnIH0sXG4gICAgICAgIF0sXG4gICAgICAgIHJldHVybnM6IGUuY3R4LnJlc291cmNlLmNvbnN0cnVjdC5pbnRlcmZhY2VUeXBlLFxuICAgICAgfSk7XG4gICAgfVxuICB9LFxufSk7XG5cbmltcG9ydHNMaW50ZXIuYWRkKHtcbiAgY29kZTogJ2Zyb20tYXR0cmlidXRlcycsXG4gIG1lc3NhZ2U6ICdzdGF0aWMgZnJvbVh4eEF0dHJpYnV0ZXMgaXMgYSBmYWN0b3J5IG9mIElYeHggZnJvbSBpdHMgcHJpbWl0aXZlIGF0dHJpYnV0ZXMuICcgKyBiYXNlQ29uc3RydWN0QWRkZW5kdW0oKSxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5mcm9tQXR0cmlidXRlc01ldGhvZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGJhc2VUeXBlID0gZS5jdHgucmVzb3VyY2UuY29yZS5iYXNlQ29uc3RydWN0Q2xhc3M7XG4gICAgZS5hc3NlcnRTaWduYXR1cmUoZS5jdHguZnJvbUF0dHJpYnV0ZXNNZXRob2QsIHtcbiAgICAgIHBhcmFtZXRlcnM6IFtcbiAgICAgICAgeyBuYW1lOiAnc2NvcGUnLCB0eXBlOiBiYXNlVHlwZSB9LFxuICAgICAgICB7IG5hbWU6ICdpZCcsIHR5cGU6ICdzdHJpbmcnIH0sXG4gICAgICAgIHsgbmFtZTogJ2F0dHJzJywgdHlwZTogZS5jdHguYXR0cmlidXRlc1N0cnVjdCB9LFxuICAgICAgXSxcbiAgICB9KTtcbiAgfSxcbn0pO1xuXG5pbXBvcnRzTGludGVyLmFkZCh7XG4gIGNvZGU6ICdmcm9tLWF0dHJpYnV0ZXMtc3RydWN0JyxcbiAgbWVzc2FnZTogJ3Jlc291cmNlIHNob3VsZCBoYXZlIGFuIFh4eEF0dHJpYnV0ZXMgc3RydWN0JyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5mcm9tQXR0cmlidXRlc01ldGhvZCkge1xuICAgICAgcmV0dXJuOyAvLyBubyBcImZyb21BdHRyaWJ1dGVzXCIgbWV0aG9kXG4gICAgfVxuXG4gICAgZS5hc3NlcnQoZS5jdHguYXR0cmlidXRlc1N0cnVjdCwgZS5jdHguYXR0cmlidXRlc1N0cnVjdE5hbWUpO1xuICB9LFxufSk7XG5cbmZ1bmN0aW9uIGJhc2VDb25zdHJ1Y3RBZGRlbmR1bSgpOiBzdHJpbmcge1xuICBpZiAoIXByb2Nlc3MuZW52LkFXU0xJTlRfQkFTRV9DT05TVFJVQ1QpIHtcbiAgICByZXR1cm4gJ0lmIHRoZSBjb25zdHJ1Y3QgaXMgdXNpbmcgdGhlIFwiY29uc3RydWN0c1wiIG1vZHVsZSwgc2V0IHRoZSBlbnZpcm9ubWVudCB2YXJpYWJsZSBcIkFXU0xJTlRfQkFTRV9DT05TVFJVQ1RcIiBhbmQgcmUtcnVuJztcbiAgfVxuICByZXR1cm4gJyc7XG59XG4iXX0=
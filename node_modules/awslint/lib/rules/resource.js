"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ResourceReflection = exports.AttributeSite = exports.resourceLinter = void 0;
const cfn_resource_1 = require("./cfn-resource");
const construct_1 = require("./construct");
const core_types_1 = require("./core-types");
const util_1 = require("./util");
const case_1 = require("../case");
const linter_1 = require("../linter");
const GRANT_RESULT_FQN = '@aws-cdk/aws-iam.Grant';
exports.resourceLinter = new linter_1.Linter(a => ResourceReflection.findAll(a));
var AttributeSite;
(function (AttributeSite) {
    AttributeSite["Interface"] = "interface";
    AttributeSite["Class"] = "class";
})(AttributeSite || (exports.AttributeSite = AttributeSite = {}));
class ResourceReflection {
    construct;
    /**
     * @returns all resource constructs (everything that extends `cdk.Resource`)
     */
    static findAll(assembly) {
        if (core_types_1.CoreTypes.hasCoreModule(assembly)) {
            return []; // not part of the dep stack
        }
        return assembly.allClasses
            .filter(c => core_types_1.CoreTypes.isConstructClass(c) && core_types_1.CoreTypes.isResourceClass(c))
            .map(c => new ResourceReflection(new construct_1.ConstructReflection(c)));
    }
    attributes; // actual attribute props
    fqn; // expected fqn of resource class
    assembly;
    sys;
    cfn;
    basename; // i.e. Bucket
    core;
    physicalNameProp;
    constructor(construct) {
        this.construct = construct;
        this.assembly = construct.classType.assembly;
        this.sys = this.assembly.system;
        const cfn = tryResolveCfnResource(construct.classType);
        if (!cfn) {
            throw new Error(`Cannot find L1 class for L2 ${construct.fqn}. ` +
                `Is "${guessResourceName(construct.fqn)}" an actual CloudFormation resource. ` +
                'If not, use the "@resource" doc tag to indicate the full resource name (e.g. "@resource AWS::Route53::HostedZone")');
        }
        this.core = new core_types_1.CoreTypes(this.sys);
        this.cfn = cfn;
        this.basename = construct.classType.name;
        this.fqn = construct.fqn;
        this.attributes = this.findAttributeProperties();
        this.physicalNameProp = this.findPhysicalNameProp();
    }
    findPhysicalNameProp() {
        if (!this.construct.propsType) {
            return undefined;
        }
        const resourceName = (0, case_1.camelize)(this.cfn.basename);
        // if resource name ends with "Name" (e.g. DomainName, then just use it as-is, otherwise append "Name")
        const physicalNameProp = resourceName.endsWith('Name') ? resourceName : `${resourceName}Name`;
        return this.construct.propsType.allProperties.find(x => x.name === physicalNameProp);
    }
    /**
     * Attribute properties are all the properties that begin with the type name (e.g. bucketXxx).
     *
     * We are adding a `bucketRef` property as well that we don't necessarily want to hold to the same linter
     * rules as the other attributes, so we don't consider it an attribute.
     */
    findAttributeProperties() {
        const result = new Array();
        for (const p of this.construct.classType.allProperties) {
            if (p.protected) {
                continue; // skip any protected properties
            }
            if (p.name.endsWith('Ref')) {
                continue; // skip any "Ref" properties, these are not attributes
            }
            const basename = (0, case_1.camelize)(this.cfn.basename);
            // an attribute property is a property which starts with the type name
            // (e.g. "bucketXxx") and/or has an @attribute doc tag.
            const tag = (0, util_1.getDocTag)(p, 'attribute');
            if (!p.name.startsWith(basename) && !tag) {
                continue;
            }
            let cfnAttributeNames;
            if (tag && tag !== 'true') {
                // if there's an `@attribute` doc tag with a value other than "true"
                // it should be used as the CFN attribute name instead of the property name
                // multiple attribute names can be listed as a comma-delimited list
                cfnAttributeNames = tag.split(',');
            }
            else {
                // okay, we don't have an explicit CFN attribute name, so we'll guess it
                // from the name of the property.
                const name = (0, case_1.pascalize)(p.name);
                if (this.cfn.attributeNames.includes(name)) {
                    // special case: there is a cloudformation resource type in the attribute name
                    // for example 'RoleId'.
                    cfnAttributeNames = [name];
                }
                else if (p.name.startsWith(basename)) {
                    // begins with the resource name, just trim it
                    cfnAttributeNames = [name.substring(this.cfn.basename.length)];
                }
                else {
                    // we couldn't determine CFN attribute name, so we don't account for this
                    // as an attribute. this could be, for example, when a construct implements
                    // an interface that represents another resource (e.g. `lambda.Alias` implements `IFunction`).
                    continue;
                }
            }
            // check if this attribute is defined on an interface or on a class
            const property = findDeclarationSite(p);
            const site = property.parentType.isInterfaceType() ? AttributeSite.Interface : AttributeSite.Class;
            result.push({
                site,
                cfnAttributeNames,
                property,
            });
        }
        return result;
    }
}
exports.ResourceReflection = ResourceReflection;
function findDeclarationSite(prop) {
    if (!prop.overrides || (!prop.overrides.isClassType() && !prop.overrides.isInterfaceType())) {
        if (!prop.parentType.isClassType() && !prop.parentType.isInterfaceType()) {
            throw new Error('invalid parent type');
        }
        return prop;
    }
    const overridesProp = prop.overrides.allProperties.find(p => p.name === prop.name);
    if (!overridesProp) {
        throw new Error(`Cannot find property ${prop.name} in override site ${prop.overrides.fqn}`);
    }
    return findDeclarationSite(overridesProp);
}
exports.resourceLinter.add({
    code: 'resource-class-extends-resource',
    message: 'resource classes must extend "cdk.Resource" directly or indirectly',
    eval: e => {
        const resourceBase = e.ctx.sys.findClass(e.ctx.core.resourceClassFqn);
        e.assert(e.ctx.construct.classType.extends(resourceBase), e.ctx.construct.fqn);
    },
});
exports.resourceLinter.add({
    code: 'resource-interface',
    warning: true,
    message: 'every resource must have a resource interface',
    eval: e => {
        e.assert(e.ctx.construct.interfaceType, e.ctx.construct.fqn);
    },
});
exports.resourceLinter.add({
    code: 'resource-interface-extends-resource',
    message: 'construct interfaces of AWS resources must extend cdk.IResource',
    eval: e => {
        const resourceInterface = e.ctx.construct.interfaceType;
        if (!resourceInterface) {
            return;
        }
        const resourceInterfaceFqn = e.ctx.core.resourceInterfaceFqn;
        const interfaceBase = e.ctx.sys.findInterface(resourceInterfaceFqn);
        e.assert(resourceInterface.extends(interfaceBase), resourceInterface.fqn);
    },
});
/*
// This rule is the worst
resourceLinter.add({
  code: 'resource-attribute',
  message:
    'resources must represent all cloudformation attributes as attribute properties. ' +
    '"@attribute ATTR[,ATTR]" can be used to tag non-standard attribute names. ' +
    'missing property:',
  eval: e => {
    for (const name of e.ctx.cfn.attributeNames) {
      const expected = camelcase(name).startsWith(camelcase(e.ctx.cfn.basename))
        ? camelcase(name)
        : camelcase(e.ctx.cfn.basename + name);

      const found = e.ctx.attributes.find(a => a.cfnAttributeNames.includes(name));
      e.assert(found, `${e.ctx.fqn}.${expected}`, expected);
    }
  },
});
*/
exports.resourceLinter.add({
    code: 'grant-result',
    message: `"grant" method must return ${GRANT_RESULT_FQN}`,
    eval: e => {
        const grantResultType = e.ctx.sys.tryFindFqn(GRANT_RESULT_FQN);
        // this implies that we are at a lower layer (i.e. @aws-cdk/core)
        if (!grantResultType) {
            return;
        }
        const grantMethods = e.ctx.construct.classType.allMethods.filter(m => m.name.startsWith('grant'));
        for (const grantMethod of grantMethods) {
            e.assertSignature(grantMethod, {
                returns: grantResultType,
            });
        }
    },
});
exports.resourceLinter.add({
    code: 'props-physical-name',
    message: 'Every Resource must have a single physical name construction property, ' +
        'with a name that is an ending substring of <cfnResource>Name',
    eval: e => {
        if (!e.ctx.construct.propsType) {
            return;
        }
        e.assert(e.ctx.physicalNameProp, e.ctx.construct.propsFqn);
    },
});
exports.resourceLinter.add({
    code: 'props-physical-name-type',
    message: 'The type of the physical name prop should always be a "string"',
    eval: e => {
        if (!e.ctx.physicalNameProp) {
            return;
        }
        const prop = e.ctx.physicalNameProp;
        e.assertTypesEqual(e.ctx.sys, prop.type, 'string', `${e.ctx.construct.propsFqn}.${prop.name}`);
    },
});
function tryResolveCfnResource(resourceClass) {
    const sys = resourceClass.system;
    // if there is a @resource doc tag, it takes precedece
    const tag = resourceClass.docs.customTag('resource');
    if (tag) {
        return cfn_resource_1.CfnResourceReflection.findByName(sys, tag);
    }
    // parse the FQN of the class name and see if we can find a matching CFN resource
    const guess = guessResourceName(resourceClass.fqn);
    if (guess) {
        const cfn = cfn_resource_1.CfnResourceReflection.findByName(sys, guess);
        if (cfn) {
            return cfn;
        }
    }
    // try to resolve through ancestors
    for (const base of resourceClass.ancestors) {
        const ret = tryResolveCfnResource(base);
        if (ret) {
            return ret;
        }
    }
    // failed misrably
    return undefined;
}
function guessResourceName(fqn) {
    // Strip any version suffixes e.g. 'TableV2' becomes 'Table'
    let match = /^(.+?)(V[0-9]+)?$/.exec(fqn);
    if (!match) {
        return undefined;
    }
    const [, versionless] = match;
    match = /aws-cdk-lib\.([a-z]+)_([a-z0-9]+)\.([A-Z][a-zA-Z0-9]+)/.exec(versionless);
    if (!match) {
        // Alpha name
        match = /@aws-cdk\/([a-z]+)-([a-z0-9]+)-alpha\.([A-Z][a-zA-Z0-9]+)/.exec(fqn);
    }
    if (!match) {
        return undefined;
    }
    const [, org, ns, rs] = match;
    if (!org || !ns || !rs) {
        return undefined;
    }
    return `${org}::${ns}::${rs}`;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzb3VyY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJyZXNvdXJjZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxpREFBdUQ7QUFDdkQsMkNBQWtEO0FBQ2xELDZDQUF5QztBQUN6QyxpQ0FBbUM7QUFDbkMsa0NBQThDO0FBQzlDLHNDQUFtQztBQUVuQyxNQUFNLGdCQUFnQixHQUFHLHdCQUF3QixDQUFDO0FBRXJDLFFBQUEsY0FBYyxHQUFHLElBQUksZUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFRN0UsSUFBWSxhQUdYO0FBSEQsV0FBWSxhQUFhO0lBQ3ZCLHdDQUF1QixDQUFBO0lBQ3ZCLGdDQUFlLENBQUE7QUFDakIsQ0FBQyxFQUhXLGFBQWEsNkJBQWIsYUFBYSxRQUd4QjtBQUVELE1BQWEsa0JBQWtCO0lBd0JEO0lBdkI1Qjs7T0FFRztJQUNJLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBMEI7UUFDOUMsSUFBSSxzQkFBUyxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1lBQ3RDLE9BQU8sRUFBRSxDQUFDLENBQUMsNEJBQTRCO1FBQ3pDLENBQUM7UUFFRCxPQUFPLFFBQVEsQ0FBQyxVQUFVO2FBQ3ZCLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLHNCQUFTLENBQUMsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDLElBQUksc0JBQVMsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDMUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxrQkFBa0IsQ0FBQyxJQUFJLCtCQUFtQixDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRWUsVUFBVSxDQUFjLENBQUMseUJBQXlCO0lBQ2xELEdBQUcsQ0FBUyxDQUFDLGlDQUFpQztJQUU5QyxRQUFRLENBQW1CO0lBQzNCLEdB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Y2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyByZWZsZWN0IGZyb20gJ2pzaWktcmVmbGVjdCc7XG5pbXBvcnQgeyBDZm5SZXNvdXJjZVJlZmxlY3Rpb24gfSBmcm9tICcuL2Nmbi1yZXNvdXJjZSc7XG5pbXBvcnQgeyBDb25zdHJ1Y3RSZWZsZWN0aW9uIH0gZnJvbSAnLi9jb25zdHJ1Y3QnO1xuaW1wb3J0IHsgQ29yZVR5cGVzIH0gZnJvbSAnLi9jb3JlLXR5cGVzJztcbmltcG9ydCB7IGdldERvY1RhZyB9IGZyb20gJy4vdXRpbCc7XG5pbXBvcnQgeyBjYW1lbGl6ZSwgcGFzY2FsaXplIH0gZnJvbSAnLi4vY2FzZSc7XG5pbXBvcnQgeyBMaW50ZXIgfSBmcm9tICcuLi9saW50ZXInO1xuXG5jb25zdCBHUkFOVF9SRVNVTFRfRlFOID0gJ0Bhd3MtY2RrL2F3cy1pYW0uR3JhbnQnO1xuXG5leHBvcnQgY29uc3QgcmVzb3VyY2VMaW50ZXIgPSBuZXcgTGludGVyKGEgPT4gUmVzb3VyY2VSZWZsZWN0aW9uLmZpbmRBbGwoYSkpO1xuXG5leHBvcnQgaW50ZXJmYWNlIEF0dHJpYnV0ZSB7XG4gIHNpdGU6IEF0dHJpYnV0ZVNpdGU7XG4gIHByb3BlcnR5OiByZWZsZWN0LlByb3BlcnR5O1xuICBjZm5BdHRyaWJ1dGVOYW1lczogc3RyaW5nW107IC8vIGJ1Y2tldEFyblxufVxuXG5leHBvcnQgZW51bSBBdHRyaWJ1dGVTaXRlIHtcbiAgSW50ZXJmYWNlID0gJ2ludGVyZmFjZScsXG4gIENsYXNzID0gJ2NsYXNzJyxcbn1cblxuZXhwb3J0IGNsYXNzIFJlc291cmNlUmVmbGVjdGlvbiB7XG4gIC8qKlxuICAgKiBAcmV0dXJucyBhbGwgcmVzb3VyY2UgY29uc3RydWN0cyAoZXZlcnl0aGluZyB0aGF0IGV4dGVuZHMgYGNkay5SZXNvdXJjZWApXG4gICAqL1xuICBwdWJsaWMgc3RhdGljIGZpbmRBbGwoYXNzZW1ibHk6IHJlZmxlY3QuQXNzZW1ibHkpIHtcbiAgICBpZiAoQ29yZVR5cGVzLmhhc0NvcmVNb2R1bGUoYXNzZW1ibHkpKSB7XG4gICAgICByZXR1cm4gW107IC8vIG5vdCBwYXJ0IG9mIHRoZSBkZXAgc3RhY2tcbiAgICB9XG5cbiAgICByZXR1cm4gYXNzZW1ibHkuYWxsQ2xhc3Nlc1xuICAgICAgLmZpbHRlcihjID0+IENvcmVUeXBlcy5pc0NvbnN0cnVjdENsYXNzKGMpICYmIENvcmVUeXBlcy5pc1Jlc291cmNlQ2xhc3MoYykpXG4gICAgICAubWFwKGMgPT4gbmV3IFJlc291cmNlUmVmbGVjdGlvbihuZXcgQ29uc3RydWN0UmVmbGVjdGlvbihjKSkpO1xuICB9XG5cbiAgcHVibGljIHJlYWRvbmx5IGF0dHJpYnV0ZXM6IEF0dHJpYnV0ZVtdOyAvLyBhY3R1YWwgYXR0cmlidXRlIHByb3BzXG4gIHB1YmxpYyByZWFkb25seSBmcW46IHN0cmluZzsgLy8gZXhwZWN0ZWQgZnFuIG9mIHJlc291cmNlIGNsYXNzXG5cbiAgcHVibGljIHJlYWRvbmx5IGFzc2VtYmx5OiByZWZsZWN0LkFzc2VtYmx5O1xuICBwdWJsaWMgcmVhZG9ubHkgc3lzOiByZWZsZWN0LlR5cGVTeXN0ZW07XG4gIHB1YmxpYyByZWFkb25seSBjZm46IENmblJlc291cmNlUmVmbGVjdGlvbjtcbiAgcHVibGljIHJlYWRvbmx5IGJhc2VuYW1lOiBzdHJpbmc7IC8vIGkuZS4gQnVja2V0XG4gIHB1YmxpYyByZWFkb25seSBjb3JlOiBDb3JlVHlwZXM7XG4gIHB1YmxpYyByZWFkb25seSBwaHlzaWNhbE5hbWVQcm9wPzogcmVmbGVjdC5Qcm9wZXJ0eTtcblxuICBjb25zdHJ1Y3RvcihwdWJsaWMgcmVhZG9ubHkgY29uc3RydWN0OiBDb25zdHJ1Y3RSZWZsZWN0aW9uKSB7XG4gICAgdGhpcy5hc3NlbWJseSA9IGNvbnN0cnVjdC5jbGFzc1R5cGUuYXNzZW1ibHk7XG4gICAgdGhpcy5zeXMgPSB0aGlzLmFzc2VtYmx5LnN5c3RlbTtcblxuICAgIGNvbnN0IGNmbiA9IHRyeVJlc29sdmVDZm5SZXNvdXJjZShjb25zdHJ1Y3QuY2xhc3NUeXBlKTtcbiAgICBpZiAoIWNmbikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZmluZCBMMSBjbGFzcyBmb3IgTDIgJHtjb25zdHJ1Y3QuZnFufS4gYCArXG4gICAgICAgIGBJcyBcIiR7Z3Vlc3NSZXNvdXJjZU5hbWUoY29uc3RydWN0LmZxbil9XCIgYW4gYWN0dWFsIENsb3VkRm9ybWF0aW9uIHJlc291cmNlLiBgICtcbiAgICAgICAgJ0lmIG5vdCwgdXNlIHRoZSBcIkByZXNvdXJjZVwiIGRvYyB0YWcgdG8gaW5kaWNhdGUgdGhlIGZ1bGwgcmVzb3VyY2UgbmFtZSAoZS5nLiBcIkByZXNvdXJjZSBBV1M6OlJvdXRlNTM6Okhvc3RlZFpvbmVcIiknKTtcbiAgICB9XG5cbiAgICB0aGlzLmNvcmUgPSBuZXcgQ29yZVR5cGVzKHRoaXMuc3lzKTtcbiAgICB0aGlzLmNmbiA9IGNmbjtcbiAgICB0aGlzLmJhc2VuYW1lID0gY29uc3RydWN0LmNsYXNzVHlwZS5uYW1lO1xuICAgIHRoaXMuZnFuID0gY29uc3RydWN0LmZxbjtcbiAgICB0aGlzLmF0dHJpYnV0ZXMgPSB0aGlzLmZpbmRBdHRyaWJ1dGVQcm9wZXJ0aWVzKCk7XG4gICAgdGhpcy5waHlzaWNhbE5hbWVQcm9wID0gdGhpcy5maW5kUGh5c2ljYWxOYW1lUHJvcCgpO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kUGh5c2ljYWxOYW1lUHJvcCgpIHtcbiAgICBpZiAoIXRoaXMuY29uc3RydWN0LnByb3BzVHlwZSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBjb25zdCByZXNvdXJjZU5hbWUgPSBjYW1lbGl6ZSh0aGlzLmNmbi5iYXNlbmFtZSk7XG5cbiAgICAvLyBpZiByZXNvdXJjZSBuYW1lIGVuZHMgd2l0aCBcIk5hbWVcIiAoZS5nLiBEb21haW5OYW1lLCB0aGVuIGp1c3QgdXNlIGl0IGFzLWlzLCBvdGhlcndpc2UgYXBwZW5kIFwiTmFtZVwiKVxuICAgIGNvbnN0IHBoeXNpY2FsTmFtZVByb3AgPSByZXNvdXJjZU5hbWUuZW5kc1dpdGgoJ05hbWUnKSA/IHJlc291cmNlTmFtZSA6IGAke3Jlc291cmNlTmFtZX1OYW1lYDtcbiAgICByZXR1cm4gdGhpcy5jb25zdHJ1Y3QucHJvcHNUeXBlLmFsbFByb3BlcnRpZXMuZmluZCh4ID0+IHgubmFtZSA9PT0gcGh5c2ljYWxOYW1lUHJvcCk7XG4gIH1cblxuICAvKipcbiAgICogQXR0cmlidXRlIHByb3BlcnRpZXMgYXJlIGFsbCB0aGUgcHJvcGVydGllcyB0aGF0IGJlZ2luIHdpdGggdGhlIHR5cGUgbmFtZSAoZS5nLiBidWNrZXRYeHgpLlxuICAgKlxuICAgKiBXZSBhcmUgYWRkaW5nIGEgYGJ1Y2tldFJlZmAgcHJvcGVydHkgYXMgd2VsbCB0aGF0IHdlIGRvbid0IG5lY2Vzc2FyaWx5IHdhbnQgdG8gaG9sZCB0byB0aGUgc2FtZSBsaW50ZXJcbiAgICogcnVsZXMgYXMgdGhlIG90aGVyIGF0dHJpYnV0ZXMsIHNvIHdlIGRvbid0IGNvbnNpZGVyIGl0IGFuIGF0dHJpYnV0ZS5cbiAgICovXG4gIHByaXZhdGUgZmluZEF0dHJpYnV0ZVByb3BlcnRpZXMoKTogQXR0cmlidXRlW10ge1xuICAgIGNvbnN0IHJlc3VsdCA9IG5ldyBBcnJheTxBdHRyaWJ1dGU+KCk7XG5cbiAgICBmb3IgKGNvbnN0IHAgb2YgdGhpcy5jb25zdHJ1Y3QuY2xhc3NUeXBlLmFsbFByb3BlcnRpZXMpIHtcbiAgICAgIGlmIChwLnByb3RlY3RlZCkge1xuICAgICAgICBjb250aW51ZTsgLy8gc2tpcCBhbnkgcHJvdGVjdGVkIHByb3BlcnRpZXNcbiAgICAgIH1cbiAgICAgIGlmIChwLm5hbWUuZW5kc1dpdGgoJ1JlZicpKSB7XG4gICAgICAgIGNvbnRpbnVlOyAvLyBza2lwIGFueSBcIlJlZlwiIHByb3BlcnRpZXMsIHRoZXNlIGFyZSBub3QgYXR0cmlidXRlc1xuICAgICAgfVxuXG4gICAgICBjb25zdCBiYXNlbmFtZSA9IGNhbWVsaXplKHRoaXMuY2ZuLmJhc2VuYW1lKTtcblxuICAgICAgLy8gYW4gYXR0cmlidXRlIHByb3BlcnR5IGlzIGEgcHJvcGVydHkgd2hpY2ggc3RhcnRzIHdpdGggdGhlIHR5cGUgbmFtZVxuICAgICAgLy8gKGUuZy4gXCJidWNrZXRYeHhcIikgYW5kL29yIGhhcyBhbiBAYXR0cmlidXRlIGRvYyB0YWcuXG4gICAgICBjb25zdCB0YWcgPSBnZXREb2NUYWcocCwgJ2F0dHJpYnV0ZScpO1xuICAgICAgaWYgKCFwLm5hbWUuc3RhcnRzV2l0aChiYXNlbmFtZSkgJiYgIXRhZykge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgbGV0IGNmbkF0dHJpYnV0ZU5hbWVzO1xuICAgICAgaWYgKHRhZyAmJiB0YWcgIT09ICd0cnVlJykge1xuICAgICAgICAvLyBpZiB0aGVyZSdzIGFuIGBAYXR0cmlidXRlYCBkb2MgdGFnIHdpdGggYSB2YWx1ZSBvdGhlciB0aGFuIFwidHJ1ZVwiXG4gICAgICAgIC8vIGl0IHNob3VsZCBiZSB1c2VkIGFzIHRoZSBDRk4gYXR0cmlidXRlIG5hbWUgaW5zdGVhZCBvZiB0aGUgcHJvcGVydHkgbmFtZVxuICAgICAgICAvLyBtdWx0aXBsZSBhdHRyaWJ1dGUgbmFtZXMgY2FuIGJlIGxpc3RlZCBhcyBhIGNvbW1hLWRlbGltaXRlZCBsaXN0XG4gICAgICAgIGNmbkF0dHJpYnV0ZU5hbWVzID0gdGFnLnNwbGl0KCcsJyk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBva2F5LCB3ZSBkb24ndCBoYXZlIGFuIGV4cGxpY2l0IENGTiBhdHRyaWJ1dGUgbmFtZSwgc28gd2UnbGwgZ3Vlc3MgaXRcbiAgICAgICAgLy8gZnJvbSB0aGUgbmFtZSBvZiB0aGUgcHJvcGVydHkuXG5cbiAgICAgICAgY29uc3QgbmFtZSA9IHBhc2NhbGl6ZShwLm5hbWUpO1xuICAgICAgICBpZiAodGhpcy5jZm4uYXR0cmlidXRlTmFtZXMuaW5jbHVkZXMobmFtZSkpIHtcbiAgICAgICAgICAvLyBzcGVjaWFsIGNhc2U6IHRoZXJlIGlzIGEgY2xvdWRmb3JtYXRpb24gcmVzb3VyY2UgdHlwZSBpbiB0aGUgYXR0cmlidXRlIG5hbWVcbiAgICAgICAgICAvLyBmb3IgZXhhbXBsZSAnUm9sZUlkJy5cbiAgICAgICAgICBjZm5BdHRyaWJ1dGVOYW1lcyA9IFtuYW1lXTtcbiAgICAgICAgfSBlbHNlIGlmIChwLm5hbWUuc3RhcnRzV2l0aChiYXNlbmFtZSkpIHtcbiAgICAgICAgICAvLyBiZWdpbnMgd2l0aCB0aGUgcmVzb3VyY2UgbmFtZSwganVzdCB0cmltIGl0XG4gICAgICAgICAgY2ZuQXR0cmlidXRlTmFtZXMgPSBbbmFtZS5zdWJzdHJpbmcodGhpcy5jZm4uYmFzZW5hbWUubGVuZ3RoKV07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gd2UgY291bGRuJ3QgZGV0ZXJtaW5lIENGTiBhdHRyaWJ1dGUgbmFtZSwgc28gd2UgZG9uJ3QgYWNjb3VudCBmb3IgdGhpc1xuICAgICAgICAgIC8vIGFzIGFuIGF0dHJpYnV0ZS4gdGhpcyBjb3VsZCBiZSwgZm9yIGV4YW1wbGUsIHdoZW4gYSBjb25zdHJ1Y3QgaW1wbGVtZW50c1xuICAgICAgICAgIC8vIGFuIGludGVyZmFjZSB0aGF0IHJlcHJlc2VudHMgYW5vdGhlciByZXNvdXJjZSAoZS5nLiBgbGFtYmRhLkFsaWFzYCBpbXBsZW1lbnRzIGBJRnVuY3Rpb25gKS5cbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBjaGVjayBpZiB0aGlzIGF0dHJpYnV0ZSBpcyBkZWZpbmVkIG9uIGFuIGludGVyZmFjZSBvciBvbiBhIGNsYXNzXG4gICAgICBjb25zdCBwcm9wZXJ0eSA9IGZpbmREZWNsYXJhdGlvblNpdGUocCk7XG4gICAgICBjb25zdCBzaXRlID0gcHJvcGVydHkucGFyZW50VHlwZS5pc0ludGVyZmFjZVR5cGUoKSA/IEF0dHJpYnV0ZVNpdGUuSW50ZXJmYWNlIDogQXR0cmlidXRlU2l0ZS5DbGFzcztcblxuICAgICAgcmVzdWx0LnB1c2goe1xuICAgICAgICBzaXRlLFxuICAgICAgICBjZm5BdHRyaWJ1dGVOYW1lcyxcbiAgICAgICAgcHJvcGVydHksXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG59XG5cbmZ1bmN0aW9uIGZpbmREZWNsYXJhdGlvblNpdGUocHJvcDogcmVmbGVjdC5Qcm9wZXJ0eSk6IHJlZmxlY3QuUHJvcGVydHkge1xuICBpZiAoIXByb3Aub3ZlcnJpZGVzIHx8ICghcHJvcC5vdmVycmlkZXMuaXNDbGFzc1R5cGUoKSAmJiAhcHJvcC5vdmVycmlkZXMuaXNJbnRlcmZhY2VUeXBlKCkpKSB7XG4gICAgaWYgKCFwcm9wLnBhcmVudFR5cGUuaXNDbGFzc1R5cGUoKSAmJiAhcHJvcC5wYXJlbnRUeXBlLmlzSW50ZXJmYWNlVHlwZSgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ2ludmFsaWQgcGFyZW50IHR5cGUnKTtcbiAgICB9XG4gICAgcmV0dXJuIHByb3A7XG4gIH1cblxuICBjb25zdCBvdmVycmlkZXNQcm9wID0gcHJvcC5vdmVycmlkZXMuYWxsUHJvcGVydGllcy5maW5kKHAgPT4gcC5uYW1lID09PSBwcm9wLm5hbWUpO1xuICBpZiAoIW92ZXJyaWRlc1Byb3ApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kIHByb3BlcnR5ICR7cHJvcC5uYW1lfSBpbiBvdmVycmlkZSBzaXRlICR7cHJvcC5vdmVycmlkZXMuZnFufWApO1xuICB9XG4gIHJldHVybiBmaW5kRGVjbGFyYXRpb25TaXRlKG92ZXJyaWRlc1Byb3ApO1xufVxuXG5yZXNvdXJjZUxpbnRlci5hZGQoe1xuICBjb2RlOiAncmVzb3VyY2UtY2xhc3MtZXh0ZW5kcy1yZXNvdXJjZScsXG4gIG1lc3NhZ2U6ICdyZXNvdXJjZSBjbGFzc2VzIG11c3QgZXh0ZW5kIFwiY2RrLlJlc291cmNlXCIgZGlyZWN0bHkgb3IgaW5kaXJlY3RseScsXG4gIGV2YWw6IGUgPT4ge1xuICAgIGNvbnN0IHJlc291cmNlQmFzZSA9IGUuY3R4LnN5cy5maW5kQ2xhc3MoZS5jdHguY29yZS5yZXNvdXJjZUNsYXNzRnFuKTtcbiAgICBlLmFzc2VydChlLmN0eC5jb25zdHJ1Y3QuY2xhc3NUeXBlLmV4dGVuZHMocmVzb3VyY2VCYXNlKSwgZS5jdHguY29uc3RydWN0LmZxbik7XG4gIH0sXG59KTtcblxucmVzb3VyY2VMaW50ZXIuYWRkKHtcbiAgY29kZTogJ3Jlc291cmNlLWludGVyZmFjZScsXG4gIHdhcm5pbmc6IHRydWUsXG4gIG1lc3NhZ2U6ICdldmVyeSByZXNvdXJjZSBtdXN0IGhhdmUgYSByZXNvdXJjZSBpbnRlcmZhY2UnLFxuICBldmFsOiBlID0+IHtcbiAgICBlLmFzc2VydChlLmN0eC5jb25zdHJ1Y3QuaW50ZXJmYWNlVHlwZSwgZS5jdHguY29uc3RydWN0LmZxbik7XG4gIH0sXG59KTtcblxucmVzb3VyY2VMaW50ZXIuYWRkKHtcbiAgY29kZTogJ3Jlc291cmNlLWludGVyZmFjZS1leHRlbmRzLXJlc291cmNlJyxcbiAgbWVzc2FnZTogJ2NvbnN0cnVjdCBpbnRlcmZhY2VzIG9mIEFXUyByZXNvdXJjZXMgbXVzdCBleHRlbmQgY2RrLklSZXNvdXJjZScsXG4gIGV2YWw6IGUgPT4ge1xuICAgIGNvbnN0IHJlc291cmNlSW50ZXJmYWNlID0gZS5jdHguY29uc3RydWN0LmludGVyZmFjZVR5cGU7XG4gICAgaWYgKCFyZXNvdXJjZUludGVyZmFjZSkgeyByZXR1cm47IH1cblxuICAgIGNvbnN0IHJlc291cmNlSW50ZXJmYWNlRnFuID0gZS5jdHguY29yZS5yZXNvdXJjZUludGVyZmFjZUZxbjtcbiAgICBjb25zdCBpbnRlcmZhY2VCYXNlID0gZS5jdHguc3lzLmZpbmRJbnRlcmZhY2UocmVzb3VyY2VJbnRlcmZhY2VGcW4pO1xuICAgIGUuYXNzZXJ0KHJlc291cmNlSW50ZXJmYWNlLmV4dGVuZHMoaW50ZXJmYWNlQmFzZSksIHJlc291cmNlSW50ZXJmYWNlLmZxbik7XG4gIH0sXG59KTtcblxuLypcbi8vIFRoaXMgcnVsZSBpcyB0aGUgd29yc3RcbnJlc291cmNlTGludGVyLmFkZCh7XG4gIGNvZGU6ICdyZXNvdXJjZS1hdHRyaWJ1dGUnLFxuICBtZXNzYWdlOlxuICAgICdyZXNvdXJjZXMgbXVzdCByZXByZXNlbnQgYWxsIGNsb3VkZm9ybWF0aW9uIGF0dHJpYnV0ZXMgYXMgYXR0cmlidXRlIHByb3BlcnRpZXMuICcgK1xuICAgICdcIkBhdHRyaWJ1dGUgQVRUUlssQVRUUl1cIiBjYW4gYmUgdXNlZCB0byB0YWcgbm9uLXN0YW5kYXJkIGF0dHJpYnV0ZSBuYW1lcy4gJyArXG4gICAgJ21pc3NpbmcgcHJvcGVydHk6JyxcbiAgZXZhbDogZSA9PiB7XG4gICAgZm9yIChjb25zdCBuYW1lIG9mIGUuY3R4LmNmbi5hdHRyaWJ1dGVOYW1lcykge1xuICAgICAgY29uc3QgZXhwZWN0ZWQgPSBjYW1lbGNhc2UobmFtZSkuc3RhcnRzV2l0aChjYW1lbGNhc2UoZS5jdHguY2ZuLmJhc2VuYW1lKSlcbiAgICAgICAgPyBjYW1lbGNhc2UobmFtZSlcbiAgICAgICAgOiBjYW1lbGNhc2UoZS5jdHguY2ZuLmJhc2VuYW1lICsgbmFtZSk7XG5cbiAgICAgIGNvbnN0IGZvdW5kID0gZS5jdHguYXR0cmlidXRlcy5maW5kKGEgPT4gYS5jZm5BdHRyaWJ1dGVOYW1lcy5pbmNsdWRlcyhuYW1lKSk7XG4gICAgICBlLmFzc2VydChmb3VuZCwgYCR7ZS5jdHguZnFufS4ke2V4cGVjdGVkfWAsIGV4cGVjdGVkKTtcbiAgICB9XG4gIH0sXG59KTtcbiovXG5cbnJlc291cmNlTGludGVyLmFkZCh7XG4gIGNvZGU6ICdncmFudC1yZXN1bHQnLFxuICBtZXNzYWdlOiBgXCJncmFudFwiIG1ldGhvZCBtdXN0IHJldHVybiAke0dSQU5UX1JFU1VMVF9GUU59YCxcbiAgZXZhbDogZSA9PiB7XG4gICAgY29uc3QgZ3JhbnRSZXN1bHRUeXBlID0gZS5jdHguc3lzLnRyeUZpbmRGcW4oR1JBTlRfUkVTVUxUX0ZRTik7XG5cbiAgICAvLyB0aGlzIGltcGxpZXMgdGhhdCB3ZSBhcmUgYXQgYSBsb3dlciBsYXllciAoaS5lLiBAYXdzLWNkay9jb3JlKVxuICAgIGlmICghZ3JhbnRSZXN1bHRUeXBlKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgZ3JhbnRNZXRob2RzID0gZS5jdHguY29uc3RydWN0LmNsYXNzVHlwZS5hbGxNZXRob2RzLmZpbHRlcihtID0+IG0ubmFtZS5zdGFydHNXaXRoKCdncmFudCcpKTtcblxuICAgIGZvciAoY29uc3QgZ3JhbnRNZXRob2Qgb2YgZ3JhbnRNZXRob2RzKSB7XG4gICAgICBlLmFzc2VydFNpZ25hdHVyZShncmFudE1ldGhvZCwge1xuICAgICAgICByZXR1cm5zOiBncmFudFJlc3VsdFR5cGUsXG4gICAgICB9KTtcbiAgICB9XG4gIH0sXG59KTtcblxucmVzb3VyY2VMaW50ZXIuYWRkKHtcbiAgY29kZTogJ3Byb3BzLXBoeXNpY2FsLW5hbWUnLFxuICBtZXNzYWdlOiAnRXZlcnkgUmVzb3VyY2UgbXVzdCBoYXZlIGEgc2luZ2xlIHBoeXNpY2FsIG5hbWUgY29uc3RydWN0aW9uIHByb3BlcnR5LCAnICtcbiAgICAnd2l0aCBhIG5hbWUgdGhhdCBpcyBhbiBlbmRpbmcgc3Vic3RyaW5nIG9mIDxjZm5SZXNvdXJjZT5OYW1lJyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5jb25zdHJ1Y3QucHJvcHNUeXBlKSB7IHJldHVybjsgfVxuICAgIGUuYXNzZXJ0KGUuY3R4LnBoeXNpY2FsTmFtZVByb3AsIGUuY3R4LmNvbnN0cnVjdC5wcm9wc0Zxbik7XG4gIH0sXG59KTtcblxucmVzb3VyY2VMaW50ZXIuYWRkKHtcbiAgY29kZTogJ3Byb3BzLXBoeXNpY2FsLW5hbWUtdHlwZScsXG4gIG1lc3NhZ2U6ICdUaGUgdHlwZSBvZiB0aGUgcGh5c2ljYWwgbmFtZSBwcm9wIHNob3VsZCBhbHdheXMgYmUgYSBcInN0cmluZ1wiJyxcbiAgZXZhbDogZSA9PiB7XG4gICAgaWYgKCFlLmN0eC5waHlzaWNhbE5hbWVQcm9wKSB7IHJldHVybjsgfVxuICAgIGNvbnN0IHByb3AgPSBlLmN0eC5waHlzaWNhbE5hbWVQcm9wO1xuICAgIGUuYXNzZXJ0VHlwZXNFcXVhbChlLmN0eC5zeXMsIHByb3AudHlwZSwgJ3N0cmluZycsIGAke2UuY3R4LmNvbnN0cnVjdC5wcm9wc0Zxbn0uJHtwcm9wLm5hbWV9YCk7XG4gIH0sXG59KTtcblxuZnVuY3Rpb24gdHJ5UmVzb2x2ZUNmblJlc291cmNlKHJlc291cmNlQ2xhc3M6IHJlZmxlY3QuQ2xhc3NUeXBlKTogQ2ZuUmVzb3VyY2VSZWZsZWN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgY29uc3Qgc3lzID0gcmVzb3VyY2VDbGFzcy5zeXN0ZW07XG5cbiAgLy8gaWYgdGhlcmUgaXMgYSBAcmVzb3VyY2UgZG9jIHRhZywgaXQgdGFrZXMgcHJlY2VkZWNlXG4gIGNvbnN0IHRhZyA9IHJlc291cmNlQ2xhc3MuZG9jcy5jdXN0b21UYWcoJ3Jlc291cmNlJyk7XG4gIGlmICh0YWcpIHtcbiAgICByZXR1cm4gQ2ZuUmVzb3VyY2VSZWZsZWN0aW9uLmZpbmRCeU5hbWUoc3lzLCB0YWcpO1xuICB9XG5cbiAgLy8gcGFyc2UgdGhlIEZRTiBvZiB0aGUgY2xhc3MgbmFtZSBhbmQgc2VlIGlmIHdlIGNhbiBmaW5kIGEgbWF0Y2hpbmcgQ0ZOIHJlc291cmNlXG4gIGNvbnN0IGd1ZXNzID0gZ3Vlc3NSZXNvdXJjZU5hbWUocmVzb3VyY2VDbGFzcy5mcW4pO1xuICBpZiAoZ3Vlc3MpIHtcbiAgICBjb25zdCBjZm4gPSBDZm5SZXNvdXJjZVJlZmxlY3Rpb24uZmluZEJ5TmFtZShzeXMsIGd1ZXNzKTtcbiAgICBpZiAoY2ZuKSB7XG4gICAgICByZXR1cm4gY2ZuO1xuICAgIH1cbiAgfVxuXG4gIC8vIHRyeSB0byByZXNvbHZlIHRocm91Z2ggYW5jZXN0b3JzXG4gIGZvciAoY29uc3QgYmFzZSBvZiByZXNvdXJjZUNsYXNzLmFuY2VzdG9ycykge1xuICAgIGNvbnN0IHJldCA9IHRyeVJlc29sdmVDZm5SZXNvdXJjZShiYXNlKTtcbiAgICBpZiAocmV0KSB7XG4gICAgICByZXR1cm4gcmV0O1xuICAgIH1cbiAgfVxuXG4gIC8vIGZhaWxlZCBtaXNyYWJseVxuICByZXR1cm4gdW5kZWZpbmVkO1xufVxuXG5mdW5jdGlvbiBndWVzc1Jlc291cmNlTmFtZShmcW46IHN0cmluZykge1xuICAvLyBTdHJpcCBhbnkgdmVyc2lvbiBzdWZmaXhlcyBlLmcuICdUYWJsZVYyJyBiZWNvbWVzICdUYWJsZSdcbiAgbGV0IG1hdGNoID0gL14oLis/KShWWzAtOV0rKT8kLy5leGVjKGZxbik7XG4gIGlmICghbWF0Y2gpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfVxuICBjb25zdCBbLCB2ZXJzaW9ubGVzc10gPSBtYXRjaDtcblxuICBtYXRjaCA9IC9hd3MtY2RrLWxpYlxcLihbYS16XSspXyhbYS16MC05XSspXFwuKFtBLVpdW2EtekEtWjAtOV0rKS8uZXhlYyh2ZXJzaW9ubGVzcyk7XG5cbiAgaWYgKCFtYXRjaCkge1xuICAgIC8vIEFscGhhIG5hbWVcbiAgICBtYXRjaCA9IC9AYXdzLWNka1xcLyhbYS16XSspLShbYS16MC05XSspLWFscGhhXFwuKFtBLVpdW2EtekEtWjAtOV0rKS8uZXhlYyhmcW4pO1xuICB9XG5cbiAgaWYgKCFtYXRjaCkge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25zdCBbLCBvcmcsIG5zLCByc10gPSBtYXRjaDtcbiAgaWYgKCFvcmcgfHwgIW5zIHx8ICFycykgeyByZXR1cm4gdW5kZWZpbmVkOyB9XG5cbiAgcmV0dXJuIGAke29yZ306OiR7bnN9Ojoke3JzfWA7XG59XG4iXX0=
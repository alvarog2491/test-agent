"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.moduleLinter = void 0;
const cfn_resource_1 = require("./cfn-resource");
const linter_1 = require("../linter");
exports.moduleLinter = new linter_1.Linter(assembly => {
    const cfnResources = cfn_resource_1.CfnResourceReflection.findAll(assembly);
    if (cfnResources.length === 0) {
        return undefined; // no resources
    }
    const namespaces = new Set();
    for (const cfnResource of cfnResources) {
        namespaces.add(cfnResource.namespace);
    }
    return {
        assembly,
        namespaces,
    };
});
exports.moduleLinter.add({
    code: 'module-name',
    message: 'module name must be @aws-cdk/aws-<namespace>',
    eval: e => {
        if (!e.ctx.namespaces) {
            return;
        }
        if (!e.ctx.assembly) {
            return;
        }
        const cdkNamespaces = Array
            .from(e.ctx.namespaces)
            .map(ns => `@aws-cdk/${overrideNamespace(ns.toLocaleLowerCase().replace('::', '-'))}`);
        for (const cdkNamespace of cdkNamespaces) {
            if (e.ctx.assembly.name === cdkNamespace) {
                return;
            }
        }
        e.assert(false, e.ctx.assembly.name, ` expected '${e.ctx.assembly.name}' to be ` +
            (cdkNamespaces.length === 1
                ? `'${cdkNamespaces[0]}'`
                : `one of: ${cdkNamespaces.join(', ')}`));
    },
});
/**
 * Overrides special-case namespaces like aws-serverless=>aws-sam
 */
function overrideNamespace(namespace) {
    if (namespace === 'aws-serverless') {
        return 'aws-sam';
    }
    return namespace;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9kdWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibW9kdWxlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLGlEQUF1RDtBQUN2RCxzQ0FBbUM7QUFPdEIsUUFBQSxZQUFZLEdBQUcsSUFBSSxlQUFNLENBQXNCLFFBQVEsQ0FBQyxFQUFFO0lBQ3JFLE1BQU0sWUFBWSxHQUFHLG9DQUFxQixDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUM3RCxJQUFJLFlBQVksQ0FBQyxNQUFNLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDOUIsT0FBTyxTQUFTLENBQUMsQ0FBQyxlQUFlO0lBQ25DLENBQUM7SUFFRCxNQUFNLFVBQVUsR0FBRyxJQUFJLEdBQUcsRUFBVSxDQUFDO0lBQ3JDLEtBQUssTUFBTSxXQUFXLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdkMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsU0FBUyxDQUFDLENBQUM7SUFDeEMsQ0FBQztJQUNELE9BQU87UUFDTCxRQUFRO1FBQ1IsVUFBVTtLQUNYLENBQUM7QUFDSixDQUFDLENBQUMsQ0FBQztBQUVILG9CQUFZLENBQUMsR0FBRyxDQUFFO0lBQ2hCLElBQUksRUFBRSxhQUFhO0lBQ25CLE9BQU8sRUFBRSw4Q0FBOEM7SUFDdkQsSUFBSSxFQUFFLENBQUMsQ0FBQyxFQUFFO1FBQ1IsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUM7WUFBQyxPQUFPO1FBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUFDLE9BQU87UUFBQyxDQUFDO1FBRWhDLE1BQU0sYUFBYSxHQUFHLEtBQUs7YUFDeEIsSUFBSSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDO2FBQ3RCLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFlBQVksaUJBQWlCLENBQUMsRUFBRSxDQUFDLGlCQUFpQixFQUFFLENBQUMsT0FBTyxDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUN6RixLQUFLLE1BQU0sWUFBWSxJQUFJLGFBQWEsRUFBRSxDQUFDO1lBQ3pDLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLFlBQVksRUFBRSxDQUFDO2dCQUN6QyxPQUFPO1lBQ1QsQ0FBQztRQUNILENBQUM7UUFFRCxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsY0FBYyxDQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxJQUFJLFVBQVU7WUFDOUUsQ0FBQyxhQUFhLENBQUMsTUFBTSxLQUFLLENBQUM7Z0JBQ3pCLENBQUMsQ0FBQyxJQUFJLGFBQWEsQ0FBQyxDQUFDLENBQUMsR0FBRztnQkFDekIsQ0FBQyxDQUFDLFdBQVcsYUFBYSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNoRCxDQUFDO0NBQ0YsQ0FBQyxDQUFDO0FBRUg7O0dBRUc7QUFDSCxTQUFTLGlCQUFpQixDQUFDLFNBQWlCO0lBQzFDLElBQUksU0FBUyxLQUFLLGdCQUFnQixFQUFFLENBQUM7UUFDbkMsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztJQUNELE9BQU8sU0FBUyxDQUFDO0FBQ25CLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyByZWZsZWN0IGZyb20gJ2pzaWktcmVmbGVjdCc7XG5pbXBvcnQgeyBDZm5SZXNvdXJjZVJlZmxlY3Rpb24gfSBmcm9tICcuL2Nmbi1yZXNvdXJjZSc7XG5pbXBvcnQgeyBMaW50ZXIgfSBmcm9tICcuLi9saW50ZXInO1xuXG5pbnRlcmZhY2UgTW9kdWxlTGludGVyQ29udGV4dCB7XG4gIHJlYWRvbmx5IGFzc2VtYmx5OiByZWZsZWN0LkFzc2VtYmx5O1xuICByZWFkb25seSBuYW1lc3BhY2VzOiBTZXQ8c3RyaW5nPjtcbn1cblxuZXhwb3J0IGNvbnN0IG1vZHVsZUxpbnRlciA9IG5ldyBMaW50ZXI8TW9kdWxlTGludGVyQ29udGV4dD4oYXNzZW1ibHkgPT4ge1xuICBjb25zdCBjZm5SZXNvdXJjZXMgPSBDZm5SZXNvdXJjZVJlZmxlY3Rpb24uZmluZEFsbChhc3NlbWJseSk7XG4gIGlmIChjZm5SZXNvdXJjZXMubGVuZ3RoID09PSAwKSB7XG4gICAgcmV0dXJuIHVuZGVmaW5lZDsgLy8gbm8gcmVzb3VyY2VzXG4gIH1cblxuICBjb25zdCBuYW1lc3BhY2VzID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIGZvciAoY29uc3QgY2ZuUmVzb3VyY2Ugb2YgY2ZuUmVzb3VyY2VzKSB7XG4gICAgbmFtZXNwYWNlcy5hZGQoY2ZuUmVzb3VyY2UubmFtZXNwYWNlKTtcbiAgfVxuICByZXR1cm4ge1xuICAgIGFzc2VtYmx5LFxuICAgIG5hbWVzcGFjZXMsXG4gIH07XG59KTtcblxubW9kdWxlTGludGVyLmFkZCgge1xuICBjb2RlOiAnbW9kdWxlLW5hbWUnLFxuICBtZXNzYWdlOiAnbW9kdWxlIG5hbWUgbXVzdCBiZSBAYXdzLWNkay9hd3MtPG5hbWVzcGFjZT4nLFxuICBldmFsOiBlID0+IHtcbiAgICBpZiAoIWUuY3R4Lm5hbWVzcGFjZXMpIHsgcmV0dXJuOyB9XG4gICAgaWYgKCFlLmN0eC5hc3NlbWJseSkgeyByZXR1cm47IH1cblxuICAgIGNvbnN0IGNka05hbWVzcGFjZXMgPSBBcnJheVxuICAgICAgLmZyb20oZS5jdHgubmFtZXNwYWNlcylcbiAgICAgIC5tYXAobnMgPT4gYEBhd3MtY2RrLyR7b3ZlcnJpZGVOYW1lc3BhY2UobnMudG9Mb2NhbGVMb3dlckNhc2UoKS5yZXBsYWNlKCc6OicsICctJykpfWApO1xuICAgIGZvciAoY29uc3QgY2RrTmFtZXNwYWNlIG9mIGNka05hbWVzcGFjZXMpIHtcbiAgICAgIGlmIChlLmN0eC5hc3NlbWJseS5uYW1lID09PSBjZGtOYW1lc3BhY2UpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIGUuYXNzZXJ0KGZhbHNlLCBlLmN0eC5hc3NlbWJseS5uYW1lLCBgIGV4cGVjdGVkICcke2UuY3R4LmFzc2VtYmx5Lm5hbWV9JyB0byBiZSBgICtcbiAgICAgIChjZGtOYW1lc3BhY2VzLmxlbmd0aCA9PT0gMVxuICAgICAgICA/IGAnJHtjZGtOYW1lc3BhY2VzWzBdfSdgXG4gICAgICAgIDogYG9uZSBvZjogJHtjZGtOYW1lc3BhY2VzLmpvaW4oJywgJyl9YCkpO1xuICB9LFxufSk7XG5cbi8qKlxuICogT3ZlcnJpZGVzIHNwZWNpYWwtY2FzZSBuYW1lc3BhY2VzIGxpa2UgYXdzLXNlcnZlcmxlc3M9PmF3cy1zYW1cbiAqL1xuZnVuY3Rpb24gb3ZlcnJpZGVOYW1lc3BhY2UobmFtZXNwYWNlOiBzdHJpbmcpIHtcbiAgaWYgKG5hbWVzcGFjZSA9PT0gJ2F3cy1zZXJ2ZXJsZXNzJykge1xuICAgIHJldHVybiAnYXdzLXNhbSc7XG4gIH1cbiAgcmV0dXJuIG5hbWVzcGFjZTtcbn1cbiJdfQ==